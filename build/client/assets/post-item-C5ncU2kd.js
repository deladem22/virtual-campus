import{j as e,R as a}from"./jsx-runtime-CAOzMBF_.js";import{c as p}from"./clsx-B-dksMZM.js";import{P as Y}from"./post-time-BzanNHiO.js";import{F as G,u as Q,i as X}from"./file-input-AkW8SXRP.js";import{u as Z}from"./modal-Yn7LYWtH.js";import{A as ee}from"./avatar-CnHNwoiQ.js";import{p as se}from"./index-CNXIhnF3.js";import{u as F,b as R,L as _}from"./components-B61dXm5I.js";import{D as te,d as L,b as ne,F as ie,c as ae,s as ce,a as re,M as $}from"./tag-select-dLfp8U7r.js";import{u as le}from"./index.esm-eIWaUr6p.js";import{j as z}from"./index-B3TG-iMG.js";import{B as oe}from"./button-D3-ocrTF.js";import{T as de}from"./textarea-D9GvzXla.js";import{U as me}from"./username-Dv9jz7V0.js";function U({content:t}){return t?e.jsx("article",{className:"article",children:se(t)}):null}function ue({post:t}){const{user:s}=F("root")||{},i=R();if((s==null?void 0:s.id)!==t.userId)return e.jsx("div",{className:"size-8"});const n=[{id:"delete-post",title:"Delete post",icon:"i-lucide-trash"}];function o(d){d==="delete-post"&&confirm("Are you sure you want to delete this post? This cannot be undone.")&&i.submit("",{method:"DELETE",action:`/discussions/${t.id}`})}return e.jsx(te,{items:n,onItemClick:o})}function ge({post:t}){const s=R(),{user:i}=F("root")||{};async function n(c){s.submit(JSON.stringify({up:c}),{method:"PATCH",action:`/vote/${t.id}`,encType:"application/json"})}async function o(c){c.preventDefault(),c.stopPropagation(),await n(!0)}async function d(c){c.preventDefault(),c.stopPropagation(),await n(!1)}return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:p(" text-secondary disabled:opacity-50",{"!dark:text-white !text-zinc-900":t.vote}),type:"button",onClick:o,disabled:!i,children:e.jsx("div",{className:"i-lucide-triangle"})}),e.jsx("span",{className:"font-medium text-sm",children:t.upvotes-t.downvotes}),e.jsx("button",{className:p("text-secondary disabled:opacity-50",{"!dark:text-white !text-zinc-900":t.vote===!1}),type:"button",onClick:d,disabled:!i,children:e.jsx("div",{className:"i-lucide-triangle rotate-180"})})]})}function xe(){return e.jsx("div",{className:"p-2",children:e.jsxs("p",{className:"text-secondary",children:["You must be"," ",e.jsx(_,{className:"underline text-reset",to:"/login",children:"logged in"})," ","to comment."]})})}function fe({postId:t}){const[s,i]=a.useState([]),n=R();return a.useEffect(()=>{n.load(`/comments?postId=${t}`)},[n.load,t]),a.useEffect(()=>{n.data&&i(n.data.comments)},[n.data]),{comments:s,status:n.state}}function he({post:t}){const{comments:s,status:i}=fe({postId:t.id});return i==="loading"?e.jsxs("div",{className:"flex gap-2 items-center text-secondary",children:[e.jsx("span",{className:"i-svg-spinners-180-ring-with-bg inline-block"})," ","Loading comments…"]}):s.map((n,o)=>e.jsxs("div",{className:"mb-2",children:[e.jsx(ye,{post:n,level:2}),o<s.length-1&&e.jsx("hr",{className:"me-2 ms-8 dark:border-neutral-800"})]},n.id))}const pe=(t,s,i)=>{const[n,o]=a.useState(!1),[d,c]=a.useState(!1),[m,u]=a.useState(0),[r,w]=a.useState(),j=a.useRef(),[b,T]=a.useState(),v=a.useCallback(()=>{j.current=setInterval(()=>{u(h=>h+1)},1e3)},[]),N=a.useCallback(()=>{clearInterval(j.current),j.current=void 0},[]),y=a.useCallback(()=>{j.current||navigator.mediaDevices.getUserMedia({audio:t??!0}).then(h=>{o(!0);const S=new MediaRecorder(h,i);w(S),S.start(),v(),S.addEventListener("dataavailable",f=>{T(f.data);for(const M of h.getTracks())M.stop();w(void 0)})}).catch(h=>{console.log(h.name,h.message,h.cause)})},[t,v,s,i]),P=a.useCallback(()=>{r==null||r.stop(),N(),u(0),o(!1),c(!1)},[r,N]),C=a.useCallback(()=>{d?(c(!1),r==null||r.resume(),v()):(c(!0),N(),r==null||r.pause())},[r,d,v,N]),k=a.useCallback(()=>T(void 0),[]);return{startRecording:y,stopRecording:P,togglePauseResume:C,recordingBlob:b,isRecording:n,isPaused:d,recordingTime:m,mediaRecorder:r,clear:k}};function je({onRecorded:t,onRecording:s}){const{isPaused:i,isRecording:n,recordingTime:o,startRecording:d,stopRecording:c,togglePauseResume:m,recordingBlob:u,clear:r}=pe({echoCancellation:!0});return a.useEffect(()=>{u&&(t==null||t(u),r())},[r,u,t]),a.useEffect(()=>{s==null||s(n)},[n,s]),e.jsx("div",{className:p("size-8 bg-zinc-200 dark:bg-neutral-800 inline-flex justify-center items-center transition-[width] duration-200 px-2 gap-2",{"w-30 !justify-start !bg-red-500 text-white":n}),children:n?e.jsxs(e.Fragment,{children:[i?e.jsx("div",{className:"size-2 bg-white rounded-full opacity-50 mx-1 shrink-0"}):e.jsx("div",{className:"i-svg-spinners-pulse-3 shrink-0"}),e.jsx("div",{className:"font-mono text-sm",children:be(o)}),e.jsx("button",{type:"button",onClick:m,children:e.jsx("div",{className:p("i-lucide-pause dark:opacity-75",{"i-lucide-play":i})})}),e.jsx("button",{type:"button",onClick:c,children:e.jsx("div",{className:"i-lucide-check dark:opacity-75"})})]}):e.jsx("button",{className:"inline-flex",onClick:d,type:"button",title:"Record audio",children:e.jsx("span",{className:"i-lucide-mic inline-block"})})})}function be(t){const s=Math.floor(t/60),i=t%60;return`${s}:${i.toString().padStart(2,"0")}`}const B=5*1024*1024;function ve({disabled:t,level:s=0,parent:i,dataExtra:n}){var A;const{getValues:o,handleSubmit:d,register:c,setValue:m,watch:u,reset:r}=le({defaultValues:{content:"",files:[]}}),[w,j]=a.useState(!1),[b,T]=a.useState(!1),[v,N]=a.useState(L),[y,P]=a.useState(!1),C=z(),k=z(),{user:h}=F("root")||{},S=s>0,f=u("files");function M(){const l=o("content");l.trim()&&k.submit(JSON.stringify({content:l}),{method:"POST",action:"/md",encType:"application/json"})}async function V(l){T(!0);const g=await Promise.all(f.map(Q));T(!1);const x=ce(v);C.submit(JSON.stringify({...l,parentId:i==null?void 0:i.id,media:g,tags:x,...n}),{encType:"application/json",method:"POST",action:i?void 0:"/discussions"})}function O(l){var x;if(!((x=l.target.files)!=null&&x.length))return;const g=Array.from(l.target.files);if(g.some(E=>E.size>B)){alert("Some files you selected are too large. Maximum 5MB per file.");return}m("files",[...f,...g].slice(0,5))}function J(l,g){N(x=>{const E=x[l].filter(K=>K!==g);return{...x,[l]:E}})}const W=a.useCallback(l=>{const g=Ne(f),x=new File([l],g,{type:"audio/mp3"});if(x.size>B){alert("The recording is too large. Maximum 5MB per file.");return}m("files",[...f,x].slice(0,5))},[f,m]);function H(l){m("files",f.filter((g,x)=>x!==l))}function q(){if(!y){if(!o("content").trim())return;M()}P(!y)}a.useEffect(()=>{C.data&&(r(),N(L),P(!1))},[C.data,r]);const I=C.state==="submitting"||b,D=k.state!=="idle"||!y;return e.jsx(e.Fragment,{children:e.jsxs("form",{onSubmit:d(V),children:[!i&&e.jsx("header",{children:e.jsx(ne,{tags:v,onRemove:J})}),e.jsx(de,{className:p({hidden:!D}),placeholder:S?"What do you think?":"What have you got to share?",maxLength:1024,...c("content",{required:!0,setValueAs(l){return l.trim()}}),disabled:I||y}),e.jsxs("div",{className:p("min-h-[5rem] bg-zinc-100 dark:bg-neutral-800 rounded-lg pt-0 mb-2 border-2 border-blue-600",{hidden:D}),children:[e.jsx("div",{className:"-mt-1",children:e.jsx("div",{className:"text-sm bg-blue-600 text-white inline-block px-2 rounded-rb-lg rounded-tl-md font-medium",children:"Preview mode"})}),e.jsx("div",{className:"px-2 py-1",children:e.jsx(U,{content:(A=k.data)==null?void 0:A.rendered})}),e.jsxs("div",{className:"bg-zinc-200 dark:bg-neutral-700 bg-opacity-50 text-secondary inline-block text-sm rounded-lg px-2 mb-1 ms-2 font-medium",children:["Tap ",e.jsx("span",{className:"inline-block i-lucide-pen"})," to go back to edit mode."]})]}),e.jsx("div",{className:p("grid xl:grid-cols-3 md:grid-cols-2 grid-cols-1 gap-2 flex-wrap",{"mb-2":f.length}),children:f.map((l,g)=>e.jsx("div",{className:"col-span-1",children:e.jsx(ie,{file:l,onRemove:()=>!b&&H(g)})},`${l.name}-${g}`))}),e.jsxs("div",{className:"flex justify-between flex-wrap gap-y-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(G,{name:"files",multiple:!0,maxLength:4,accept:"image/png,image/jpeg,image/gif,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,audio/*",onChange:O,disabled:I||f.length>=5,children:[e.jsx("div",{className:"i-lucide-file-symlink opacity-50 shrink-0"}),"Add files"]}),e.jsxs("div",{className:"flex [&>*:last-child]:rounded-e-full [&>*:first-child]:rounded-s-full",children:[e.jsx(je,{onRecorded:W,onRecording:j}),!w&&e.jsxs(e.Fragment,{children:[!i&&e.jsx(ae,{value:v,onDone:N}),e.jsx("button",{className:"size-8 !bg-zinc-200 !dark:bg-neutral-800 inline-flex justify-center items-center",type:"button",title:y?"Edit mode":"Preview mode",onClick:q,children:e.jsx("span",{className:p("inline-block i-lucide-eye",{"!i-svg-spinners-180-ring-with-bg":k.state!=="idle","i-lucide-pencil":k.state==="idle"&&y})})})]})]})]}),e.jsx("div",{children:e.jsx(oe,{disabled:I||!h||t,children:I?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"i-svg-spinners-180-ring-with-bg"})," Posting…"]}):S?"Comment":"Start Discussion"})})]}),e.jsxs("p",{className:"text-sm text-secondary",children:["5 files max. Images and docs only. 5MB limit per file.",e.jsx("br",{}),e.jsx("a",{className:"underline",target:"_blank",href:"https://docs.github.com/en/get-started/writing-on-github/getting-started-with-writing-and-formatting-on-github/basic-writing-and-formatting-syntax",rel:"noreferrer",children:"Markdown"})," ","is supported."]})]})})}function Ne(t){return`Recording-${t.filter(i=>i.name.startsWith("Recording")).length+1}.mp3`}function ye({expanded:t=!1,post:s,limit:i,level:n=0}){const o=Z(),[d,c]=a.useState(t);function m(){c(b=>!b)}const u=s.parentId?`/discussions/${s.parentId}#${s.id}`:`/discussions/${s.id}`,r=d&&n>0&&n<2,w=n<2,j=e.jsx(ke,{full:w,active:d,post:s,level:n,limit:i});return e.jsxs(e.Fragment,{children:[n===0?e.jsx(_,{to:n<1?u:"",className:"block",id:s.id.toString(),children:j}):e.jsx("div",{className:"cursor-pointer",id:s.id.toString(),tabIndex:0,role:"button",onClick:m,onKeyDown:b=>{["Space","Enter"].includes(b.key)&&m()},children:j}),r&&o&&e.jsx(we,{post:s})]})}function ke({full:t,post:s,active:i,level:n,limit:o}){var c;const d=n===0&&s.media.length===1&&X(s.media[0].contentType);return e.jsxs("div",{className:p("p-2 rounded-lg hover-bg-light transition-[background] duration-200 flex gap-2",{"bg-light dark:bg-neutral-800":i}),children:[e.jsxs("div",{className:"flex flex-col items-center",children:[t&&e.jsx("div",{className:"mb-2",children:e.jsx(ee,{name:s.user.username})}),e.jsx(ge,{post:s})]}),e.jsxs("div",{className:"flex-1 w-0",children:[e.jsxs("header",{className:"flex gap-2 justify-between",children:[e.jsxs("span",{className:"font-mono text-secondary text-sm",children:[e.jsx(me,{user:s.user})," •"," ",e.jsx(Y,{time:s.createdAt})]}),e.jsx("div",{children:e.jsx(ue,{post:s})})]}),!s.parentId&&e.jsx(re,{className:"mb-4",tags:s.tags}),e.jsxs("div",{className:"-mt-3 post-content grid grid-cols-1 lg:grid-cols-4 gap-2",children:[d&&e.jsx("div",{className:"col-span-1 lg:order-last",children:e.jsx("div",{className:"aspect-[3/2]",children:e.jsx("img",{src:s.media[0].url,alt:"",className:"h-full w-full object-cover rounded-lg"})})}),e.jsx("div",{className:p("col-span-1 lg:col-span-3",{"lg:col-span-4":!d}),children:e.jsx(U,{content:s.content})})]}),e.jsx("div",{children:((c=s.media)==null?void 0:c.length)>0&&!d&&e.jsx("div",{className:"grid xl:grid-cols-3 md:grid-cols-2 grid-cols-1 gap-2 flex-wrap mt-2",children:s.media.map(m=>e.jsx("div",{className:"col-span-1",children:o?e.jsx($,{noPlay:o,media:m}):e.jsx("a",{className:"block",href:m.url,target:"_blank",onClick:u=>u.stopPropagation(),rel:"noreferrer",children:e.jsx($,{noPlay:o,media:m})})},m.id))})}),s.community&&e.jsxs("div",{className:"inline-flex gap-2 items-center font-medium text-sm bg-blue-50 dark:bg-blue-800 dark:bg-opacity-20 px-1 rounded-md text-blue-500",children:[e.jsx("div",{className:"inline-block i-lucide-creative-commons"}),s.community.name]}),n<2&&e.jsxs("footer",{className:"mt-2 flex justify-between",children:[e.jsxs("span",{className:"inline-flex items-center gap-2 text-secondary",children:[e.jsx("div",{className:"i-lucide-message-circle inline-block"})," ",s.commentsCount]}),e.jsxs("span",{className:"inline-flex items-center gap-2 text-secondary",children:[e.jsx("div",{className:"i-lucide-users-2 inline-block"})," ",s.people," ",s.people===1?"person":"people"]})]})]})]})}function we({post:t}){const{user:s}=F("root")||{};return e.jsxs("div",{className:"ms-12 border-s-2 ps-2 dark:border-neutral-700",children:[s?e.jsx("div",{className:"p-2",children:e.jsx(ve,{parent:t,level:1})}):e.jsx(xe,{}),e.jsx(he,{post:t})]})}export{U as C,xe as L,ye as P,ge as V,ue as a,ve as b};

import{j as e,R as d}from"./jsx-runtime-CAOzMBF_.js";import{c as z}from"./clsx-B-dksMZM.js";import{u as $}from"./index.esm-eIWaUr6p.js";import{B as A}from"./button-D3-ocrTF.js";import{F as D,u as R}from"./file-input-AkW8SXRP.js";import{D as P,F as U,b as C,c as M,T as q,e as B,a as _,h as O,d as V,s as J}from"./tag-select-dLfp8U7r.js";import{u as k,b as L,a as Q,L as Y}from"./components-B61dXm5I.js";import{I as Z}from"./input-DaKQDKVv.js";import{P as G}from"./post-time-BzanNHiO.js";import{T as H}from"./tags-filter-CPt830Xq.js";import{U as K}from"./username-Dv9jz7V0.js";import{c as W,e as X}from"./index-B3TG-iMG.js";import"./modal-Yn7LYWtH.js";import"./dayjs.min-DReL-Uwu.js";function ee({file:t}){const{user:i}=k("root")||{},m=L();if((i==null?void 0:i.id)!==t.userId)return e.jsx("div",{className:"size-8"});const u=[{id:"delete-file",title:"Delete file",icon:"i-lucide-trash"}];function h(x){x==="delete-file"&&confirm("Are you sure you want to delete this file? This cannot be undone.")&&m.submit("",{method:"DELETE",action:`/library/${t.id}`})}return e.jsx(P,{items:u,onItemClick:h})}const se=5*1024*1024,pe=({data:t})=>[{title:`Library | ${t==null?void 0:t.school.shortName} | gctuvc`},{name:"description",content:"Find resources for your programme, course, level or anything about the school."}];function fe(){const{handleSubmit:t,setValue:i,watch:m,getValues:u,reset:h}=$({defaultValues:{files:[],tags:V}}),{user:x}=k("root")||{},{count:b,repository:f}=Q(),o=L(),N=W(),r=X(),[g,y]=d.useState(""),[T,S]=d.useState(!1),p=m("files"),c=m("tags");function w(s){const a=Array.from(s.target.files||[]);if(a.length){if(a.some(n=>n.size>se)){alert("Some files you selected are too large. Maximum 5MB per file.");return}i("files",[...p,...a].slice(0,5))}}function I(s,a){const n=c[s].filter(v=>v!==a),l={...c,[s]:n};i("tags",l)}async function E(){const s=u("files");S(!0);const a=await Promise.all(s.map(l=>R(l)));S(!1);const n=u("tags");o.submit(JSON.stringify({media:a,tags:J(n)}),{method:"POST",encType:"application/json"})}d.useEffect(()=>{o.data&&h()},[o.data,h]),d.useEffect(()=>{const a=new URLSearchParams(r.search).get("q");y(a||"")},[r.search]),d.useEffect(()=>{const s=new URLSearchParams(r.search),a=s.toString();g?s.set("q",g):s.delete("q");const n=`${r.pathname}?${a}`.replace(/\?$/,""),l=`${r.pathname}?${s.toString()}`.replace(/\?$/,"");if(l===n)return;const v=setTimeout(()=>{N(l)},600);return()=>clearTimeout(v)},[r.search,r.pathname,N,g]);const F=!!Object.values(c).flat().length,j=!!p.length;return e.jsx("div",{className:"min-h-[60vh] container mx-auto",children:e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-5",children:e.jsxs("div",{className:"col-span-1 lg:col-span-4",children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"font-bold text-xl",children:"Library"}),e.jsx("p",{className:"text-xs mb-2 ",children:e.jsx("span",{className:"bg-zinc-100 dark:bg-neutral-800 font-medium px-2 rounded-lg text-secondary",children:j?e.jsx(e.Fragment,{children:"Adding files"}):e.jsxs(e.Fragment,{children:[b," files in repository"]})})})]}),e.jsx("div",{children:!j&&x&&e.jsxs(D,{className:"!bg-blue-600 text-white",onChange:w,multiple:!0,children:[e.jsx("div",{className:"i-lucide-plus opacity-60"})," Add files"]})})]}),j?e.jsxs("form",{onSubmit:t(E),children:[e.jsx("div",{className:"grid xl:grid-cols-3 md:grid-cols-2 grid-cols-1 gap-2 flex-wrap",children:p.map((s,a)=>e.jsx("div",{className:"col-span-1",children:e.jsx(U,{file:s,onRemove:()=>i("files",p.filter((n,l)=>a!==l))},s.name)},s.name))}),F&&e.jsxs("div",{className:"my-2",children:[e.jsx("header",{className:"font-medium text-secondary text-sm",children:"Tags"}),e.jsx(C,{tags:c,onRemove:I})]}),e.jsxs("div",{className:"text-secondary text-sm flex gap-2",children:[e.jsx("div",{children:e.jsx("div",{className:"inline-block i-lucide-alert-triangle text-red-500 shrink-0 mt-1"})}),e.jsx("p",{children:"The names of the files will be retained when uploaded. To make it easy to search, rename the file appropriately before uploading."})]}),e.jsxs("div",{className:"text-secondary text-sm gap-2 flex mt-2",children:[e.jsx("div",{className:"inline-block i-lucide-hash text-blue-500 mt-0.5"}),e.jsx("p",{children:"Add at least one tag to make filtering easier."})]}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsxs(A,{disabled:!F||o.state==="submitting"||T,children:[e.jsx("div",{className:z("i-lucide-upload opacity-60",{"!i-svg-spinners-180-ring-with-bg":o.state==="submitting"||T})})," ","Upload all"]}),e.jsx(M,{className:"!w-auto rounded-lg",value:c,onDone:s=>i("tags",s),children:e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-lg bg-zinc-200 dark:bg-neutral-800 font-medium",children:[e.jsx("div",{className:"i-lucide-hash opacity-60"}),"Add tags"]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx(Z,{onChange:s=>y(s.target.value),placeholder:"Search for file",type:"search",value:g}),e.jsx("div",{className:"mt-2",children:e.jsx(H,{label:"Filter resources",path:"/library"})}),e.jsx("div",{className:"text-secondary mb-2 text-sm",children:"Showing most recent uploads"}),!x&&e.jsx("div",{className:"p-2",children:e.jsxs("p",{className:"text-secondary",children:["You must be"," ",e.jsx(Y,{className:"underline text-reset",to:"/login",children:"logged in"})," ","to upload a file."]})}),e.jsxs("div",{children:[e.jsx("ul",{children:f.map((s,a)=>e.jsxs("li",{children:[e.jsxs("a",{target:"_blank",className:"grid grid-cols-4 hover:bg-zinc-100 dark:hover:bg-neutral-800 gap-2 p-2 rounded-lg",href:s.media.url,rel:"noreferrer",children:[e.jsxs("div",{className:"flex gap-2 col-span-3",children:[e.jsx("div",{children:e.jsx(q,{thumbnail:s.media.thumbnail,contentType:s.media.contentType,name:s.media.filename})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("header",{className:"font-medium break-all",children:B(s.media.filename,40)}),e.jsx("div",{children:e.jsx(_,{tags:s.tags})}),e.jsx("div",{children:e.jsxs("span",{className:"text-secondary inline-flex text-xs items-center gap-1 font-mono",children:[e.jsx("div",{className:"i-lucide-arrow-up-from-line"})," ",e.jsx(K,{user:s.user})," â€¢ ",e.jsx(G,{time:s.createdAt})]})})]})]}),e.jsxs("div",{className:"col-span-1 flex flex-col items-end",children:[e.jsx("div",{className:"font-medium bg-zinc-100 dark:bg-neutral-800 rounded-lg px-1 text-center self-end text-sm",children:O(s.media.size)}),e.jsx(ee,{file:s})]})]}),a<f.length-1&&e.jsx("hr",{className:"me-2 ms-14 dark:border-neutral-700"})]},s.id))}),f.length===0&&e.jsxs("div",{className:"font-mono text-center text-secondary",children:[e.jsx("div",{className:"i-lucide-land-plot inline-block"})," Nothing here!"]})]})]})]})})})}export{fe as default,pe as meta};

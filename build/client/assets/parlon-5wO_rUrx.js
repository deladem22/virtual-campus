var Pn=Object.defineProperty;var En=(s,e,t)=>e in s?Pn(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var He=(s,e,t)=>En(s,typeof e!="symbol"?e+"":e,t);import{j as w,c as _,R as K}from"./jsx-runtime-CAOzMBF_.js";import{A as xn}from"./anchor-BX46IkJD.js";import{B as Ln}from"./button-D3-ocrTF.js";import{c as gr}from"./clsx-B-dksMZM.js";import{u as ls,a as Mn}from"./components-BUh_SX-e.js";import"./index-BqmKY8Xa.js";function In(){return w.jsxs("svg",{width:"300",viewBox:"0 0 622 135",fill:"none",className:"inline-block",xmlns:"http://www.w3.org/2000/svg",children:[w.jsx("title",{children:"Parlon"}),w.jsx("path",{className:"fill-current",d:"M506.591 67.3899H531.677V77.0469C539.521 69.7949 549.622 66.1689 561.98 66.1689H562.757C572.673 66.1689 580.11 68.3149 585.068 72.6069C590.026 76.8249 592.505 81.9679 592.505 88.0359V123.445H566.975V95.6949C566.975 91.2549 565.606 87.8509 562.868 85.4829C560.13 83.0409 556.06 81.8199 550.658 81.8199C544.96 81.8199 540.409 83.2259 537.005 86.0379C533.601 88.7759 531.899 92.4389 531.899 97.0269V123.445H506.591V67.3899Z"}),w.jsx("path",{className:"fill-current",d:"M453.66 124.222H445.779C438.971 124.222 432.94 123.63 427.686 122.446C422.432 121.188 418.214 119.634 415.032 117.784C411.85 115.934 409.223 113.714 407.151 111.124C405.079 108.46 403.673 105.833 402.933 103.243C402.193 100.727 401.823 98.0999 401.823 95.3619V93.4749C401.823 90.6629 402.193 88.0359 402.933 85.5939C403.673 83.0779 405.042 80.5249 407.04 77.9349C409.112 75.3449 411.739 73.1619 414.921 71.3859C418.103 69.5359 422.321 68.0189 427.575 66.8349C432.829 65.7249 438.86 65.1699 445.668 65.1699H453.66C482.816 65.1699 497.394 74.6049 497.394 93.4749V95.3619C497.394 114.602 482.816 124.222 453.66 124.222ZM432.792 104.908C436.196 107.72 441.82 109.126 449.664 109.126C457.582 109.126 463.243 107.72 466.647 104.908C470.051 102.022 471.753 98.6179 471.753 94.6959V94.1409C471.753 90.1449 470.051 86.8149 466.647 84.1509C463.243 81.4129 457.619 80.0439 449.775 80.0439H449.664C441.746 80.0439 436.085 81.3759 432.681 84.0399C429.351 86.7039 427.686 90.0709 427.686 94.1409V94.6959C427.686 98.6179 429.388 102.022 432.792 104.908Z"}),w.jsx("path",{className:"fill-current",d:"M392.824 46.2999V123.667H367.516V46.2999H392.824Z"}),w.jsx("path",{className:"fill-current",d:"M305.563 123.445H280.255V67.3899H305.341V77.2689C306.451 75.7889 307.783 74.3459 309.337 72.9399C310.965 71.4599 313.666 69.9799 317.44 68.4999C321.214 66.9459 325.432 66.1689 330.094 66.1689H331.315C339.751 66.1689 346.004 68.4259 350.074 72.9399C354.144 77.4539 356.179 83.5219 356.179 91.1439V94.3629H331.759C331.759 90.4409 330.723 87.2219 328.651 84.7059C326.579 82.1899 323.323 80.9319 318.883 80.9319H318.772C314.628 80.9319 311.372 82.2639 309.004 84.9279C306.71 87.5179 305.563 90.6999 305.563 94.4739V123.445Z"}),w.jsx("path",{className:"fill-current",d:"M238.69 115.453C236.766 117.599 233.547 119.597 229.033 121.447C224.519 123.223 218.34 124.111 210.496 124.111H209.053C199.433 124.111 192.292 122.409 187.63 119.005C182.968 115.527 180.637 111.124 180.637 105.796V105.13C180.637 99.9499 182.598 96.0649 186.52 93.4749C190.516 90.8109 197.102 89.1089 206.278 88.3689L234.139 85.9269C236.729 85.7049 238.024 84.7429 238.024 83.0409C238.024 82.1529 237.802 81.4129 237.358 80.8209C236.692 80.3029 235.175 79.7849 232.807 79.2669C230.291 78.7489 226.739 78.4899 222.151 78.4899H221.596C218.71 78.4899 216.231 78.6379 214.159 78.9339C212.087 79.3039 210.533 79.6739 209.497 80.0439C208.461 80.4879 207.647 81.0429 207.055 81.7089C206.389 82.4489 205.982 82.9669 205.834 83.2629C205.76 83.7069 205.686 84.1879 205.612 84.7059H182.08V84.4839C182.08 82.6339 182.228 81.0429 182.524 79.7109C182.894 78.2309 183.782 76.5659 185.188 74.7159C186.594 72.8659 188.518 71.3119 190.96 70.0539C193.476 68.7959 197.065 67.7229 201.727 66.8349C206.463 66.0209 212.05 65.6139 218.488 65.6139H224.815C231.623 65.6139 237.432 65.9839 242.242 66.7239C247.126 67.4639 250.826 68.3889 253.342 69.4989C255.932 70.6089 257.93 72.0519 259.336 73.8279C260.816 75.6039 261.704 77.1949 262 78.6009C262.296 80.0069 262.444 81.7089 262.444 83.7069V105.13C262.444 106.98 263.517 107.905 265.663 107.905H268.882V123.112H248.347C242.871 123.112 239.652 120.559 238.69 115.453ZM238.024 96.4719L213.937 99.9129C210.533 100.431 208.128 101.023 206.722 101.689C205.39 102.503 204.724 103.65 204.724 105.13V105.241C204.798 106.943 205.649 108.423 207.277 109.681C209.053 110.939 211.902 111.568 215.824 111.568C222.336 111.568 227.664 110.236 231.808 107.572C235.952 104.834 238.024 101.726 238.024 98.2479V96.4719Z"}),w.jsx("path",{className:"fill-current",d:"M133.152 98.1369H96.1892V124H69.6602V46.4109H133.152C159.496 46.4109 172.668 54.8099 172.668 71.6079V72.7179C172.668 89.6639 159.496 98.1369 133.152 98.1369ZM96.1892 64.0599V80.7099H132.708C140.922 80.7099 145.029 78.0089 145.029 72.6069V72.2739C145.029 66.7979 140.922 64.0599 132.708 64.0599H96.1892Z"}),w.jsx("text",{transform:"translate(0 71.5735) rotate(-30.9778)",xmlSpace:"preserve",fontSize:"73",fill:"currentColor",letterSpacing:"0em",children:w.jsx("tspan",{x:"0",y:"67.89",children:"ðŸ¤­"})}),w.jsx("text",{transform:"translate(549.322 4) rotate(5.75692)",xmlSpace:"preserve",fontSize:"73",fill:"currentColor",letterSpacing:"0em",children:w.jsx("tspan",{x:"0",y:"67.89",children:"ðŸ™ˆ"})}),w.jsx("text",{transform:"translate(289 11.4199) rotate(-9.00013)",xmlSpace:"preserve",fontSize:"73",fill:"currentColor",letterSpacing:"0em",children:w.jsx("tspan",{x:"0",y:"67.89",children:"ðŸ˜…"})})]})}var ji={},cs={exports:{}},Wr,Us;function kn(){if(Us)return Wr;Us=1;var s=1e3,e=s*60,t=e*60,r=t*24,i=r*7,n=r*365.25;Wr=function(c,u){u=u||{};var l=typeof c;if(l==="string"&&c.length>0)return a(c);if(l==="number"&&isFinite(c))return u.long?d(c):o(c);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(c))};function a(c){if(c=String(c),!(c.length>100)){var u=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(c);if(u){var l=parseFloat(u[1]),h=(u[2]||"ms").toLowerCase();switch(h){case"years":case"year":case"yrs":case"yr":case"y":return l*n;case"weeks":case"week":case"w":return l*i;case"days":case"day":case"d":return l*r;case"hours":case"hour":case"hrs":case"hr":case"h":return l*t;case"minutes":case"minute":case"mins":case"min":case"m":return l*e;case"seconds":case"second":case"secs":case"sec":case"s":return l*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return l;default:return}}}}function o(c){var u=Math.abs(c);return u>=r?Math.round(c/r)+"d":u>=t?Math.round(c/t)+"h":u>=e?Math.round(c/e)+"m":u>=s?Math.round(c/s)+"s":c+"ms"}function d(c){var u=Math.abs(c);return u>=r?p(c,u,r,"day"):u>=t?p(c,u,t,"hour"):u>=e?p(c,u,e,"minute"):u>=s?p(c,u,s,"second"):c+" ms"}function p(c,u,l,h){var f=u>=l*1.5;return Math.round(c/l)+" "+h+(f?"s":"")}return Wr}function On(s){t.debug=t,t.default=t,t.coerce=d,t.disable=n,t.enable=i,t.enabled=a,t.humanize=kn(),t.destroy=p,Object.keys(s).forEach(c=>{t[c]=s[c]}),t.names=[],t.skips=[],t.formatters={};function e(c){let u=0;for(let l=0;l<c.length;l++)u=(u<<5)-u+c.charCodeAt(l),u|=0;return t.colors[Math.abs(u)%t.colors.length]}t.selectColor=e;function t(c){let u,l=null,h,f;function m(...g){if(!m.enabled)return;const v=m,N=Number(new Date),S=N-(u||N);v.diff=S,v.prev=u,v.curr=N,u=N,g[0]=t.coerce(g[0]),typeof g[0]!="string"&&g.unshift("%O");let b=0;g[0]=g[0].replace(/%([a-zA-Z%])/g,(Y,ke)=>{if(Y==="%%")return"%";b++;const le=t.formatters[ke];if(typeof le=="function"){const se=g[b];Y=le.call(v,se),g.splice(b,1),b--}return Y}),t.formatArgs.call(v,g),(v.log||t.log).apply(v,g)}return m.namespace=c,m.useColors=t.useColors(),m.color=t.selectColor(c),m.extend=r,m.destroy=t.destroy,Object.defineProperty(m,"enabled",{enumerable:!0,configurable:!1,get:()=>l!==null?l:(h!==t.namespaces&&(h=t.namespaces,f=t.enabled(c)),f),set:g=>{l=g}}),typeof t.init=="function"&&t.init(m),m}function r(c,u){const l=t(this.namespace+(typeof u>"u"?":":u)+c);return l.log=this.log,l}function i(c){t.save(c),t.namespaces=c,t.names=[],t.skips=[];let u;const l=(typeof c=="string"?c:"").split(/[\s,]+/),h=l.length;for(u=0;u<h;u++)l[u]&&(c=l[u].replace(/\*/g,".*?"),c[0]==="-"?t.skips.push(new RegExp("^"+c.slice(1)+"$")):t.names.push(new RegExp("^"+c+"$")))}function n(){const c=[...t.names.map(o),...t.skips.map(o).map(u=>"-"+u)].join(",");return t.enable(""),c}function a(c){if(c[c.length-1]==="*")return!0;let u,l;for(u=0,l=t.skips.length;u<l;u++)if(t.skips[u].test(c))return!1;for(u=0,l=t.names.length;u<l;u++)if(t.names[u].test(c))return!0;return!1}function o(c){return c.toString().substring(2,c.toString().length-2).replace(/\.\*\?$/,"*")}function d(c){return c instanceof Error?c.stack||c.message:c}function p(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}var jn=On;(function(s,e){var t={};e.formatArgs=i,e.save=n,e.load=a,e.useColors=r,e.storage=o(),e.destroy=(()=>{let p=!1;return()=>{p||(p=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function r(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function i(p){if(p[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+p[0]+(this.useColors?"%c ":" ")+"+"+s.exports.humanize(this.diff),!this.useColors)return;const c="color: "+this.color;p.splice(1,0,c,"color: inherit");let u=0,l=0;p[0].replace(/%[a-zA-Z%]/g,h=>{h!=="%%"&&(u++,h==="%c"&&(l=u))}),p.splice(l,0,c)}e.log=console.debug||console.log||(()=>{});function n(p){try{p?e.storage.setItem("debug",p):e.storage.removeItem("debug")}catch{}}function a(){let p;try{p=e.storage.getItem("debug")}catch{}return!p&&typeof process<"u"&&"env"in process&&(p=t.DEBUG),p}function o(){try{return localStorage}catch{}}s.exports=jn(e);const{formatters:d}=s.exports;d.j=function(p){try{return JSON.stringify(p)}catch(c){return"[UnexpectedJSONParseError]: "+c.message}}})(cs,cs.exports);var Nt=cs.exports,bt={},ds={exports:{}};(function(s,e){(function(t,r){var i="1.0.38",n="",a="?",o="function",d="undefined",p="object",c="string",u="major",l="model",h="name",f="type",m="vendor",g="version",v="architecture",N="console",S="mobile",b="tablet",W="smarttv",Y="wearable",ke="embedded",le=500,se="Amazon",he="Apple",ce="ASUS",ie="BlackBerry",qe="Browser",Zt="Chrome",Rn="Edge",Jt="Firefox",Yt="Google",Ms="Huawei",Ur="LG",zr="Microsoft",Is="Motorola",Dt="Opera",Xt="Samsung",ks="Sharp",er="Sony",qr="Xiaomi",Hr="Zebra",Os="Facebook",js="Chromium OS",$s="Mac OS",Cn=function(k,B){var L={};for(var V in k)B[V]&&B[V].length%2===0?L[V]=B[V].concat(k[V]):L[V]=k[V];return L},tr=function(k){for(var B={},L=0;L<k.length;L++)B[k[L].toUpperCase()]=k[L];return B},Ns=function(k,B){return typeof k===c?Pt(B).indexOf(Pt(k))!==-1:!1},Pt=function(k){return k.toLowerCase()},Tn=function(k){return typeof k===c?k.replace(/[^\d\.]/g,n).split(".")[0]:r},Vr=function(k,B){if(typeof k===c)return k=k.replace(/^\s\s*/,n),typeof B===d?k:k.substring(0,le)},Et=function(k,B){for(var L=0,V,Ee,fe,A,E,me;L<B.length&&!E;){var Gr=B[L],Bs=B[L+1];for(V=Ee=0;V<Gr.length&&!E&&Gr[V];)if(E=Gr[V++].exec(k),E)for(fe=0;fe<Bs.length;fe++)me=E[++Ee],A=Bs[fe],typeof A===p&&A.length>0?A.length===2?typeof A[1]==o?this[A[0]]=A[1].call(this,me):this[A[0]]=A[1]:A.length===3?typeof A[1]===o&&!(A[1].exec&&A[1].test)?this[A[0]]=me?A[1].call(this,me,A[2]):r:this[A[0]]=me?me.replace(A[1],A[2]):r:A.length===4&&(this[A[0]]=me?A[3].call(this,me.replace(A[1],A[2])):r):this[A]=me||r;L+=2}},Kr=function(k,B){for(var L in B)if(typeof B[L]===p&&B[L].length>0){for(var V=0;V<B[L].length;V++)if(Ns(B[L][V],k))return L===a?r:L}else if(Ns(B[L],k))return L===a?r:L;return k},Dn={"1.0":"/8","1.2":"/1","1.3":"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"},As={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2","8.1":"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},Fs={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[g,[h,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[g,[h,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[h,g],[/opios[\/ ]+([\w\.]+)/i],[g,[h,Dt+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[g,[h,Dt+" GX"]],[/\bopr\/([\w\.]+)/i],[g,[h,Dt]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[g,[h,"Baidu"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim)\s?(?:browser)?[\/ ]?([\w\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(heytap|ovi)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[h,g],[/\bddg\/([\w\.]+)/i],[g,[h,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[g,[h,"UC"+qe]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[g,[h,"WeChat"]],[/konqueror\/([\w\.]+)/i],[g,[h,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[g,[h,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[g,[h,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[g,[h,"Smart Lenovo "+qe]],[/(avast|avg)\/([\w\.]+)/i],[[h,/(.+)/,"$1 Secure "+qe],g],[/\bfocus\/([\w\.]+)/i],[g,[h,Jt+" Focus"]],[/\bopt\/([\w\.]+)/i],[g,[h,Dt+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[g,[h,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[g,[h,"Dolphin"]],[/coast\/([\w\.]+)/i],[g,[h,Dt+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[g,[h,"MIUI "+qe]],[/fxios\/([-\w\.]+)/i],[g,[h,Jt]],[/\bqihu|(qi?ho?o?|360)browser/i],[[h,"360 "+qe]],[/(oculus|sailfish|huawei|vivo)browser\/([\w\.]+)/i],[[h,/(.+)/,"$1 "+qe],g],[/samsungbrowser\/([\w\.]+)/i],[g,[h,Xt+" Internet"]],[/(comodo_dragon)\/([\w\.]+)/i],[[h,/_/g," "],g],[/metasr[\/ ]?([\d\.]+)/i],[g,[h,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[h,"Sogou Mobile"],g],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345Explorer)[\/ ]?([\w\.]+)/i],[h,g],[/(lbbrowser)/i,/\[(linkedin)app\]/i],[h],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[h,Os],g],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[h,g],[/\bgsa\/([\w\.]+) .*safari\//i],[g,[h,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[g,[h,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[g,[h,Zt+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[h,Zt+" WebView"],g],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[g,[h,"Android "+qe]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[h,g],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[g,[h,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[g,h],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[h,[g,Kr,Dn]],[/(webkit|khtml)\/([\w\.]+)/i],[h,g],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[h,"Netscape"],g],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[g,[h,Jt+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[h,g],[/(cobalt)\/([\w\.]+)/i],[h,[g,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[v,"amd64"]],[/(ia32(?=;))/i],[[v,Pt]],[/((?:i[346]|x)86)[;\)]/i],[[v,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[v,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[v,"armhf"]],[/windows (ce|mobile); ppc;/i],[[v,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[v,/ower/,n,Pt]],[/(sun4\w)[;\)]/i],[[v,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[v,Pt]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[l,[m,Xt],[f,b]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[l,[m,Xt],[f,S]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[l,[m,he],[f,S]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[l,[m,he],[f,b]],[/(macintosh);/i],[l,[m,he]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[l,[m,ks],[f,S]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[l,[m,Ms],[f,b]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[l,[m,Ms],[f,S]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[l,/_/g," "],[m,qr],[f,S]],[/oid[^\)]+; (2\d{4}(283|rpbf)[cgl])( bui|\))/i,/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[l,/_/g," "],[m,qr],[f,b]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[l,[m,"OPPO"],[f,S]],[/\b(opd2\d{3}a?) bui/i],[l,[m,"OPPO"],[f,b]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[l,[m,"Vivo"],[f,S]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[l,[m,"Realme"],[f,S]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[l,[m,Is],[f,S]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[l,[m,Is],[f,b]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[l,[m,Ur],[f,b]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[l,[m,Ur],[f,S]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[l,[m,"Lenovo"],[f,b]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[l,/_/g," "],[m,"Nokia"],[f,S]],[/(pixel c)\b/i],[l,[m,Yt],[f,b]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[l,[m,Yt],[f,S]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[l,[m,er],[f,S]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[l,"Xperia Tablet"],[m,er],[f,b]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[l,[m,"OnePlus"],[f,S]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo[c-r]{2})( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[l,[m,se],[f,b]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[l,/(.+)/g,"Fire Phone $1"],[m,se],[f,S]],[/(playbook);[-\w\),; ]+(rim)/i],[l,m,[f,b]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[l,[m,ie],[f,S]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[l,[m,ce],[f,b]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[l,[m,ce],[f,S]],[/(nexus 9)/i],[l,[m,"HTC"],[f,b]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[m,[l,/_/g," "],[f,S]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[l,[m,"Acer"],[f,b]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[l,[m,"Meizu"],[f,S]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[l,[m,"Ulefone"],[f,S]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron|infinix|tecno)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[m,l,[f,S]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[m,l,[f,b]],[/(surface duo)/i],[l,[m,zr],[f,b]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[l,[m,"Fairphone"],[f,S]],[/(u304aa)/i],[l,[m,"AT&T"],[f,S]],[/\bsie-(\w*)/i],[l,[m,"Siemens"],[f,S]],[/\b(rct\w+) b/i],[l,[m,"RCA"],[f,b]],[/\b(venue[\d ]{2,7}) b/i],[l,[m,"Dell"],[f,b]],[/\b(q(?:mv|ta)\w+) b/i],[l,[m,"Verizon"],[f,b]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[l,[m,"Barnes & Noble"],[f,b]],[/\b(tm\d{3}\w+) b/i],[l,[m,"NuVision"],[f,b]],[/\b(k88) b/i],[l,[m,"ZTE"],[f,b]],[/\b(nx\d{3}j) b/i],[l,[m,"ZTE"],[f,S]],[/\b(gen\d{3}) b.+49h/i],[l,[m,"Swiss"],[f,S]],[/\b(zur\d{3}) b/i],[l,[m,"Swiss"],[f,b]],[/\b((zeki)?tb.*\b) b/i],[l,[m,"Zeki"],[f,b]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[m,"Dragon Touch"],l,[f,b]],[/\b(ns-?\w{0,9}) b/i],[l,[m,"Insignia"],[f,b]],[/\b((nxa|next)-?\w{0,9}) b/i],[l,[m,"NextBook"],[f,b]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[m,"Voice"],l,[f,S]],[/\b(lvtel\-)?(v1[12]) b/i],[[m,"LvTel"],l,[f,S]],[/\b(ph-1) /i],[l,[m,"Essential"],[f,S]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[l,[m,"Envizen"],[f,b]],[/\b(trio[-\w\. ]+) b/i],[l,[m,"MachSpeed"],[f,b]],[/\btu_(1491) b/i],[l,[m,"Rotor"],[f,b]],[/(shield[\w ]+) b/i],[l,[m,"Nvidia"],[f,b]],[/(sprint) (\w+)/i],[m,l,[f,S]],[/(kin\.[onetw]{3})/i],[[l,/\./g," "],[m,zr],[f,S]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[l,[m,Hr],[f,b]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[l,[m,Hr],[f,S]],[/smart-tv.+(samsung)/i],[m,[f,W]],[/hbbtv.+maple;(\d+)/i],[[l,/^/,"SmartTV"],[m,Xt],[f,W]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[m,Ur],[f,W]],[/(apple) ?tv/i],[m,[l,he+" TV"],[f,W]],[/crkey/i],[[l,Zt+"cast"],[m,Yt],[f,W]],[/droid.+aft(\w+)( bui|\))/i],[l,[m,se],[f,W]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[l,[m,ks],[f,W]],[/(bravia[\w ]+)( bui|\))/i],[l,[m,er],[f,W]],[/(mitv-\w{5}) bui/i],[l,[m,qr],[f,W]],[/Hbbtv.*(technisat) (.*);/i],[m,l,[f,W]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[m,Vr],[l,Vr],[f,W]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[f,W]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[m,l,[f,N]],[/droid.+; (shield) bui/i],[l,[m,"Nvidia"],[f,N]],[/(playstation [345portablevi]+)/i],[l,[m,er],[f,N]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[l,[m,zr],[f,N]],[/((pebble))app/i],[m,l,[f,Y]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[l,[m,he],[f,Y]],[/droid.+; (glass) \d/i],[l,[m,Yt],[f,Y]],[/droid.+; (wt63?0{2,3})\)/i],[l,[m,Hr],[f,Y]],[/(quest( \d| pro)?)/i],[l,[m,Os],[f,Y]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[m,[f,ke]],[/(aeobc)\b/i],[l,[m,se],[f,ke]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[l,[f,S]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[l,[f,b]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[f,b]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[f,S]],[/(android[-\w\. ]{0,9});.+buil/i],[l,[m,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[g,[h,Rn+"HTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[g,[h,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[h,g],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[g,h]],os:[[/microsoft (windows) (vista|xp)/i],[h,g],[/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i],[h,[g,Kr,As]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[g,Kr,As],[h,"Windows"]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[g,/_/g,"."],[h,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[h,$s],[g,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[g,h],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[h,g],[/\(bb(10);/i],[g,[h,ie]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[g,[h,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[g,[h,Jt+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[g,[h,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[g,[h,"watchOS"]],[/crkey\/([\d\.]+)/i],[g,[h,Zt+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[h,js],g],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[h,g],[/(sunos) ?([\w\.\d]*)/i],[[h,"Solaris"],g],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[h,g]]},ue=function(k,B){if(typeof k===p&&(B=k,k=r),!(this instanceof ue))return new ue(k,B).getResult();var L=typeof t!==d&&t.navigator?t.navigator:r,V=k||(L&&L.userAgent?L.userAgent:n),Ee=L&&L.userAgentData?L.userAgentData:r,fe=B?Cn(Fs,B):Fs,A=L&&L.userAgent==V;return this.getBrowser=function(){var E={};return E[h]=r,E[g]=r,Et.call(E,V,fe.browser),E[u]=Tn(E[g]),A&&L&&L.brave&&typeof L.brave.isBrave==o&&(E[h]="Brave"),E},this.getCPU=function(){var E={};return E[v]=r,Et.call(E,V,fe.cpu),E},this.getDevice=function(){var E={};return E[m]=r,E[l]=r,E[f]=r,Et.call(E,V,fe.device),A&&!E[f]&&Ee&&Ee.mobile&&(E[f]=S),A&&E[l]=="Macintosh"&&L&&typeof L.standalone!==d&&L.maxTouchPoints&&L.maxTouchPoints>2&&(E[l]="iPad",E[f]=b),E},this.getEngine=function(){var E={};return E[h]=r,E[g]=r,Et.call(E,V,fe.engine),E},this.getOS=function(){var E={};return E[h]=r,E[g]=r,Et.call(E,V,fe.os),A&&!E[h]&&Ee&&Ee.platform&&Ee.platform!="Unknown"&&(E[h]=Ee.platform.replace(/chrome os/i,js).replace(/macos/i,$s)),E},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return V},this.setUA=function(E){return V=typeof E===c&&E.length>le?Vr(E,le):E,this},this.setUA(V),this};ue.VERSION=i,ue.BROWSER=tr([h,g,u]),ue.CPU=tr([v]),ue.DEVICE=tr([l,m,f,N,S,W,b,Y,ke]),ue.ENGINE=ue.OS=tr([h,g]),s.exports&&(e=s.exports=ue),e.UAParser=ue;var Ze=typeof t!==d&&(t.jQuery||t.Zepto);if(Ze&&!Ze.ua){var rr=new ue;Ze.ua=rr.getResult(),Ze.ua.get=function(){return rr.getUA()},Ze.ua.set=function(k){rr.setUA(k);var B=rr.getResult();for(var L in B)Ze.ua[L]=B[L]}}})(typeof window=="object"?window:_)})(ds,ds.exports);var $n=ds.exports,G={},Nn=_&&_.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(G,"__esModule",{value:!0});G.Logger=void 0;const Je=Nn(Nt),Ye="mediasoup-client";let An=class{constructor(e){e?(this._debug=(0,Je.default)(`${Ye}:${e}`),this._warn=(0,Je.default)(`${Ye}:WARN:${e}`),this._error=(0,Je.default)(`${Ye}:ERROR:${e}`)):(this._debug=(0,Je.default)(Ye),this._warn=(0,Je.default)(`${Ye}:WARN`),this._error=(0,Je.default)(`${Ye}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};G.Logger=An;var Te={},us={exports:{}},wt=typeof Reflect=="object"?Reflect:null,zs=wt&&typeof wt.apply=="function"?wt.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)},_r;wt&&typeof wt.ownKeys=="function"?_r=wt.ownKeys:Object.getOwnPropertySymbols?_r=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:_r=function(e){return Object.getOwnPropertyNames(e)};function Fn(s){console&&console.warn&&console.warn(s)}var $i=Number.isNaN||function(e){return e!==e};function U(){U.init.call(this)}us.exports=U;us.exports.once=qn;U.EventEmitter=U;U.prototype._events=void 0;U.prototype._eventsCount=0;U.prototype._maxListeners=void 0;var qs=10;function vr(s){if(typeof s!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof s)}Object.defineProperty(U,"defaultMaxListeners",{enumerable:!0,get:function(){return qs},set:function(s){if(typeof s!="number"||s<0||$i(s))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+s+".");qs=s}});U.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};U.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||$i(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function Ni(s){return s._maxListeners===void 0?U.defaultMaxListeners:s._maxListeners}U.prototype.getMaxListeners=function(){return Ni(this)};U.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var i=e==="error",n=this._events;if(n!==void 0)i=i&&n.error===void 0;else if(!i)return!1;if(i){var a;if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var d=n[e];if(d===void 0)return!1;if(typeof d=="function")zs(d,this,t);else for(var p=d.length,c=zi(d,p),r=0;r<p;++r)zs(c[r],this,t);return!0};function Ai(s,e,t,r){var i,n,a;if(vr(t),n=s._events,n===void 0?(n=s._events=Object.create(null),s._eventsCount=0):(n.newListener!==void 0&&(s.emit("newListener",e,t.listener?t.listener:t),n=s._events),a=n[e]),a===void 0)a=n[e]=t,++s._eventsCount;else if(typeof a=="function"?a=n[e]=r?[t,a]:[a,t]:r?a.unshift(t):a.push(t),i=Ni(s),i>0&&a.length>i&&!a.warned){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=s,o.type=e,o.count=a.length,Fn(o)}return s}U.prototype.addListener=function(e,t){return Ai(this,e,t,!1)};U.prototype.on=U.prototype.addListener;U.prototype.prependListener=function(e,t){return Ai(this,e,t,!0)};function Bn(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Fi(s,e,t){var r={fired:!1,wrapFn:void 0,target:s,type:e,listener:t},i=Bn.bind(r);return i.listener=t,r.wrapFn=i,i}U.prototype.once=function(e,t){return vr(t),this.on(e,Fi(this,e,t)),this};U.prototype.prependOnceListener=function(e,t){return vr(t),this.prependListener(e,Fi(this,e,t)),this};U.prototype.removeListener=function(e,t){var r,i,n,a,o;if(vr(t),i=this._events,i===void 0)return this;if(r=i[e],r===void 0)return this;if(r===t||r.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,r.listener||t));else if(typeof r!="function"){for(n=-1,a=r.length-1;a>=0;a--)if(r[a]===t||r[a].listener===t){o=r[a].listener,n=a;break}if(n<0)return this;n===0?r.shift():Un(r,n),r.length===1&&(i[e]=r[0]),i.removeListener!==void 0&&this.emit("removeListener",e,o||t)}return this};U.prototype.off=U.prototype.removeListener;U.prototype.removeAllListeners=function(e){var t,r,i;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete r[e]),this;if(arguments.length===0){var n=Object.keys(r),a;for(i=0;i<n.length;++i)a=n[i],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=r[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this};function Bi(s,e,t){var r=s._events;if(r===void 0)return[];var i=r[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?zn(i):zi(i,i.length)}U.prototype.listeners=function(e){return Bi(this,e,!0)};U.prototype.rawListeners=function(e){return Bi(this,e,!1)};U.listenerCount=function(s,e){return typeof s.listenerCount=="function"?s.listenerCount(e):Ui.call(s,e)};U.prototype.listenerCount=Ui;function Ui(s){var e=this._events;if(e!==void 0){var t=e[s];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}U.prototype.eventNames=function(){return this._eventsCount>0?_r(this._events):[]};function zi(s,e){for(var t=new Array(e),r=0;r<e;++r)t[r]=s[r];return t}function Un(s,e){for(;e+1<s.length;e++)s[e]=s[e+1];s.pop()}function zn(s){for(var e=new Array(s.length),t=0;t<e.length;++t)e[t]=s[t].listener||s[t];return e}function qn(s,e){return new Promise(function(t,r){function i(a){s.removeListener(e,n),r(a)}function n(){typeof s.removeListener=="function"&&s.removeListener("error",i),t([].slice.call(arguments))}qi(s,e,n,{once:!0}),e!=="error"&&Hn(s,i,{once:!0})})}function Hn(s,e,t){typeof s.on=="function"&&qi(s,"error",e,t)}function qi(s,e,t,r){if(typeof s.on=="function")r.once?s.once(e,t):s.on(e,t);else if(typeof s.addEventListener=="function")s.addEventListener(e,function i(n){r.once&&s.removeEventListener(e,i),t(n)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof s)}var Vn=us.exports;Object.defineProperty(Te,"__esModule",{value:!0});Te.EnhancedEventEmitter=void 0;const Kn=Vn,Gn=G,Wn=new Gn.Logger("EnhancedEventEmitter");let Qn=class extends Kn.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}emit(e,...t){return super.emit(e,...t)}safeEmit(e,...t){const r=super.listenerCount(e);try{return super.emit(e,...t)}catch(i){return Wn.error("safeEmit() | event listener threw an error [eventName:%s]:%o",e,i),!!r}}on(e,t){return super.on(e,t),this}off(e,t){return super.off(e,t),this}addListener(e,t){return super.on(e,t),this}prependListener(e,t){return super.prependListener(e,t),this}once(e,t){return super.once(e,t),this}prependOnceListener(e,t){return super.prependOnceListener(e,t),this}removeListener(e,t){return super.off(e,t),this}removeAllListeners(e){return super.removeAllListeners(e),this}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}rawListeners(e){return super.rawListeners(e)}};Te.EnhancedEventEmitter=Qn;var ee={};Object.defineProperty(ee,"__esModule",{value:!0});ee.InvalidStateError=ee.UnsupportedError=void 0;class hs extends Error{constructor(e){super(e),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,hs):this.stack=new Error(e).stack}}ee.UnsupportedError=hs;class fs extends Error{constructor(e){super(e),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,fs):this.stack=new Error(e).stack}}ee.InvalidStateError=fs;var J={};Object.defineProperty(J,"__esModule",{value:!0});J.clone=Zn;J.generateRandomNumber=Jn;J.deepFreeze=Hi;function Zn(s){if(s!==void 0)return Number.isNaN(s)?NaN:typeof structuredClone=="function"?structuredClone(s):JSON.parse(JSON.stringify(s))}function Jn(){return Math.round(Math.random()*1e7)}function Hi(s){const e=Reflect.ownKeys(s);for(const t of e){const r=s[t];(r&&typeof r=="object"||typeof r=="function")&&Hi(r)}return Object.freeze(s)}var H={},Q={},br={},Yn=_&&_.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(br,"__esModule",{value:!0});br.Logger=void 0;const Xe=Yn(Nt),et="h264-profile-level-id";let Xn=class{constructor(e){e?(this._debug=(0,Xe.default)(`${et}:${e}`),this._warn=(0,Xe.default)(`${et}:WARN:${e}`),this._error=(0,Xe.default)(`${et}:ERROR:${e}`)):(this._debug=(0,Xe.default)(et),this._warn=(0,Xe.default)(`${et}:WARN`),this._error=(0,Xe.default)(`${et}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};br.Logger=Xn;Object.defineProperty(Q,"__esModule",{value:!0});Q.generateProfileLevelIdStringForAnswer=Q.isSameProfile=Q.parseSdpProfileLevelId=Q.levelToString=Q.profileToString=Q.profileLevelIdToString=Q.parseProfileLevelId=Q.ProfileLevelId=Q.Level=Q.Profile=void 0;const ea=br,ze=new ea.Logger;var q;(function(s){s[s.ConstrainedBaseline=1]="ConstrainedBaseline",s[s.Baseline=2]="Baseline",s[s.Main=3]="Main",s[s.ConstrainedHigh=4]="ConstrainedHigh",s[s.High=5]="High",s[s.PredictiveHigh444=6]="PredictiveHigh444"})(q||(Q.Profile=q={}));var x;(function(s){s[s.L1_b=0]="L1_b",s[s.L1=10]="L1",s[s.L1_1=11]="L1_1",s[s.L1_2=12]="L1_2",s[s.L1_3=13]="L1_3",s[s.L2=20]="L2",s[s.L2_1=21]="L2_1",s[s.L2_2=22]="L2_2",s[s.L3=30]="L3",s[s.L3_1=31]="L3_1",s[s.L3_2=32]="L3_2",s[s.L4=40]="L4",s[s.L4_1=41]="L4_1",s[s.L4_2=42]="L4_2",s[s.L5=50]="L5",s[s.L5_1=51]="L5_1",s[s.L5_2=52]="L5_2"})(x||(Q.Level=x={}));class Sr{constructor(e,t){this.profile=e,this.level=t}}Q.ProfileLevelId=Sr;const ta=new Sr(q.ConstrainedBaseline,x.L3_1);class xe{constructor(e){this.mask=~Hs("x",e),this.masked_value=Hs("1",e)}isMatch(e){return this.masked_value===(e&this.mask)}}class Le{constructor(e,t,r){this.profile_idc=e,this.profile_iop=t,this.profile=r}}const ra=[new Le(66,new xe("x1xx0000"),q.ConstrainedBaseline),new Le(77,new xe("1xxx0000"),q.ConstrainedBaseline),new Le(88,new xe("11xx0000"),q.ConstrainedBaseline),new Le(66,new xe("x0xx0000"),q.Baseline),new Le(88,new xe("10xx0000"),q.Baseline),new Le(77,new xe("0x0x0000"),q.Main),new Le(100,new xe("00000000"),q.High),new Le(100,new xe("00001100"),q.ConstrainedHigh),new Le(244,new xe("00000000"),q.PredictiveHigh444)];function Vi(s){if(typeof s!="string"||s.length!==6)return;const t=parseInt(s,16);if(t===0)return;const r=t&255,i=t>>8&255,n=t>>16&255;let a;switch(r){case x.L1_1:{a=i&16?x.L1_b:x.L1_1;break}case x.L1:case x.L1_2:case x.L1_3:case x.L2:case x.L2_1:case x.L2_2:case x.L3:case x.L3_1:case x.L3_2:case x.L4:case x.L4_1:case x.L4_2:case x.L5:case x.L5_1:case x.L5_2:{a=r;break}default:{ze.warn(`parseProfileLevelId() | unrecognized level_idc [str:${s}, level_idc:${r}]`);return}}for(const o of ra)if(n===o.profile_idc&&o.profile_iop.isMatch(i))return new Sr(o.profile,a);ze.warn(`parseProfileLevelId() | unrecognized profile_idc/profile_iop combination [str:${s}, profile_idc:${n}, profile_iop:${i}]`)}Q.parseProfileLevelId=Vi;function Ki(s){if(s.level==x.L1_b)switch(s.profile){case q.ConstrainedBaseline:return"42f00b";case q.Baseline:return"42100b";case q.Main:return"4d100b";default:{ze.warn(`profileLevelIdToString() | Level 1_b not is allowed for profile ${s.profile}`);return}}let e;switch(s.profile){case q.ConstrainedBaseline:{e="42e0";break}case q.Baseline:{e="4200";break}case q.Main:{e="4d00";break}case q.ConstrainedHigh:{e="640c";break}case q.High:{e="6400";break}case q.PredictiveHigh444:{e="f400";break}default:{ze.warn(`profileLevelIdToString() | unrecognized profile ${s.profile}`);return}}let t=s.level.toString(16);return t.length===1&&(t=`0${t}`),`${e}${t}`}Q.profileLevelIdToString=Ki;function sa(s){switch(s){case q.ConstrainedBaseline:return"ConstrainedBaseline";case q.Baseline:return"Baseline";case q.Main:return"Main";case q.ConstrainedHigh:return"ConstrainedHigh";case q.High:return"High";case q.PredictiveHigh444:return"PredictiveHigh444";default:{ze.warn(`profileToString() | unrecognized profile ${s}`);return}}}Q.profileToString=sa;function ia(s){switch(s){case x.L1_b:return"1b";case x.L1:return"1";case x.L1_1:return"1.1";case x.L1_2:return"1.2";case x.L1_3:return"1.3";case x.L2:return"2";case x.L2_1:return"2.1";case x.L2_2:return"2.2";case x.L3:return"3";case x.L3_1:return"3.1";case x.L3_2:return"3.2";case x.L4:return"4";case x.L4_1:return"4.1";case x.L4_2:return"4.2";case x.L5:return"5";case x.L5_1:return"5.1";case x.L5_2:return"5.2";default:{ze.warn(`levelToString() | unrecognized level ${s}`);return}}}Q.levelToString=ia;function jt(s={}){const e=s["profile-level-id"];return e?Vi(e):ta}Q.parseSdpProfileLevelId=jt;function na(s={},e={}){const t=jt(s),r=jt(e);return!!(t&&r&&t.profile===r.profile)}Q.isSameProfile=na;function aa(s={},e={}){if(!s["profile-level-id"]&&!e["profile-level-id"]){ze.warn("generateProfileLevelIdStringForAnswer() | profile-level-id missing in local and remote params");return}const t=jt(s),r=jt(e);if(!t)throw new TypeError("invalid local_profile_level_id");if(!r)throw new TypeError("invalid remote_profile_level_id");if(t.profile!==r.profile)throw new TypeError("H264 Profile mismatch");const i=Vs(s)&&Vs(e),n=t.level,a=r.level,o=ca(n,a),d=i?n:o;return ze.debug(`generateProfileLevelIdStringForAnswer() | result [profile:${t.profile}, level:${d}]`),Ki(new Sr(t.profile,d))}Q.generateProfileLevelIdStringForAnswer=aa;function Hs(s,e){return+(e[0]===s)<<7|+(e[1]===s)<<6|+(e[2]===s)<<5|+(e[3]===s)<<4|+(e[4]===s)<<3|+(e[5]===s)<<2|+(e[6]===s)<<1|+(e[7]===s)<<0}function oa(s,e){return s===x.L1_b?e!==x.L1&&e!==x.L1_b:e===x.L1_b?s!==x.L1:s<e}function ca(s,e){return oa(s,e)?s:e}function Vs(s={}){const e=s["level-asymmetry-allowed"];return e===!0||e===1||e==="1"}var da=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),pa=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Gi=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&da(e,s,t);return pa(e,s),e};Object.defineProperty(H,"__esModule",{value:!0});H.validateRtpCapabilities=ma;H.validateRtpParameters=ms;H.validateSctpStreamParameters=ga;H.validateSctpCapabilities=_a;H.getExtendedRtpCapabilities=wa;H.getRecvRtpCapabilities=va;H.getSendingRtpParameters=ba;H.getSendingRemoteRtpParameters=Sa;H.reduceCodecs=ya;H.generateProbatorRtpParameters=Ra;H.canSend=Ca;H.canReceive=Ta;const Ks=Gi(Q),la=Gi(J),ua="probator",ha=1234,fa=127;function ma(s){if(typeof s!="object")throw new TypeError("caps is not an object");if(s.codecs&&!Array.isArray(s.codecs))throw new TypeError("caps.codecs is not an array");s.codecs||(s.codecs=[]);for(const e of s.codecs)Da(e);if(s.headerExtensions&&!Array.isArray(s.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");s.headerExtensions||(s.headerExtensions=[]);for(const e of s.headerExtensions)Pa(e)}function ms(s){if(typeof s!="object")throw new TypeError("params is not an object");if(s.mid&&typeof s.mid!="string")throw new TypeError("params.mid is not a string");if(!Array.isArray(s.codecs))throw new TypeError("missing params.codecs");for(const e of s.codecs)Ea(e);if(s.headerExtensions&&!Array.isArray(s.headerExtensions))throw new TypeError("params.headerExtensions is not an array");s.headerExtensions||(s.headerExtensions=[]);for(const e of s.headerExtensions)xa(e);if(s.encodings&&!Array.isArray(s.encodings))throw new TypeError("params.encodings is not an array");s.encodings||(s.encodings=[]);for(const e of s.encodings)La(e);if(s.rtcp&&typeof s.rtcp!="object")throw new TypeError("params.rtcp is not an object");s.rtcp||(s.rtcp={}),Ma(s.rtcp)}function ga(s){if(typeof s!="object")throw new TypeError("params is not an object");if(typeof s.streamId!="number")throw new TypeError("missing params.streamId");let e=!1;if(typeof s.ordered=="boolean"?e=!0:s.ordered=!0,s.maxPacketLifeTime&&typeof s.maxPacketLifeTime!="number")throw new TypeError("invalid params.maxPacketLifeTime");if(s.maxRetransmits&&typeof s.maxRetransmits!="number")throw new TypeError("invalid params.maxRetransmits");if(s.maxPacketLifeTime&&s.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(e&&s.ordered&&(s.maxPacketLifeTime||s.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(!e&&(s.maxPacketLifeTime||s.maxRetransmits)&&(s.ordered=!1),s.label&&typeof s.label!="string")throw new TypeError("invalid params.label");if(s.protocol&&typeof s.protocol!="string")throw new TypeError("invalid params.protocol")}function _a(s){if(typeof s!="object")throw new TypeError("caps is not an object");if(!s.numStreams||typeof s.numStreams!="object")throw new TypeError("missing caps.numStreams");Ia(s.numStreams)}function wa(s,e){const t={codecs:[],headerExtensions:[]};for(const r of e.codecs||[]){if(Ot(r))continue;const i=(s.codecs||[]).find(a=>Qi(a,r,{strict:!0,modify:!0}));if(!i)continue;const n={mimeType:i.mimeType,kind:i.kind,clockRate:i.clockRate,channels:i.channels,localPayloadType:i.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:r.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:i.parameters,remoteParameters:r.parameters,rtcpFeedback:Oa(i,r)};t.codecs.push(n)}for(const r of t.codecs){const i=s.codecs.find(a=>Ot(a)&&a.parameters.apt===r.localPayloadType),n=e.codecs.find(a=>Ot(a)&&a.parameters.apt===r.remotePayloadType);i&&n&&(r.localRtxPayloadType=i.preferredPayloadType,r.remoteRtxPayloadType=n.preferredPayloadType)}for(const r of e.headerExtensions){const i=s.headerExtensions.find(a=>ka(a,r));if(!i)continue;const n={kind:r.kind,uri:r.uri,sendId:i.preferredId,recvId:r.preferredId,encrypt:i.preferredEncrypt,direction:"sendrecv"};switch(r.direction){case"sendrecv":{n.direction="sendrecv";break}case"recvonly":{n.direction="sendonly";break}case"sendonly":{n.direction="recvonly";break}case"inactive":{n.direction="inactive";break}}t.headerExtensions.push(n)}return t}function va(s){const e={codecs:[],headerExtensions:[]};for(const t of s.codecs){const r={mimeType:t.mimeType,kind:t.kind,preferredPayloadType:t.remotePayloadType,clockRate:t.clockRate,channels:t.channels,parameters:t.localParameters,rtcpFeedback:t.rtcpFeedback};if(e.codecs.push(r),!t.remoteRtxPayloadType)continue;const i={mimeType:`${t.kind}/rtx`,kind:t.kind,preferredPayloadType:t.remoteRtxPayloadType,clockRate:t.clockRate,parameters:{apt:t.remotePayloadType},rtcpFeedback:[]};e.codecs.push(i)}for(const t of s.headerExtensions){if(t.direction!=="sendrecv"&&t.direction!=="recvonly")continue;const r={kind:t.kind,uri:t.uri,preferredId:t.recvId,preferredEncrypt:t.encrypt,direction:t.direction};e.headerExtensions.push(r)}return e}function ba(s,e){const t={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const r of e.codecs){if(r.kind!==s)continue;const i={mimeType:r.mimeType,payloadType:r.localPayloadType,clockRate:r.clockRate,channels:r.channels,parameters:r.localParameters,rtcpFeedback:r.rtcpFeedback};if(t.codecs.push(i),r.localRtxPayloadType){const n={mimeType:`${r.kind}/rtx`,payloadType:r.localRtxPayloadType,clockRate:r.clockRate,parameters:{apt:r.localPayloadType},rtcpFeedback:[]};t.codecs.push(n)}}for(const r of e.headerExtensions){if(r.kind&&r.kind!==s||r.direction!=="sendrecv"&&r.direction!=="sendonly")continue;const i={uri:r.uri,id:r.sendId,encrypt:r.encrypt,parameters:{}};t.headerExtensions.push(i)}return t}function Sa(s,e){const t={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const r of e.codecs){if(r.kind!==s)continue;const i={mimeType:r.mimeType,payloadType:r.localPayloadType,clockRate:r.clockRate,channels:r.channels,parameters:r.remoteParameters,rtcpFeedback:r.rtcpFeedback};if(t.codecs.push(i),r.localRtxPayloadType){const n={mimeType:`${r.kind}/rtx`,payloadType:r.localRtxPayloadType,clockRate:r.clockRate,parameters:{apt:r.localPayloadType},rtcpFeedback:[]};t.codecs.push(n)}}for(const r of e.headerExtensions){if(r.kind&&r.kind!==s||r.direction!=="sendrecv"&&r.direction!=="sendonly")continue;const i={uri:r.uri,id:r.sendId,encrypt:r.encrypt,parameters:{}};t.headerExtensions.push(i)}if(t.headerExtensions.some(r=>r.uri==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"))for(const r of t.codecs)r.rtcpFeedback=(r.rtcpFeedback||[]).filter(i=>i.type!=="goog-remb");else if(t.headerExtensions.some(r=>r.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"))for(const r of t.codecs)r.rtcpFeedback=(r.rtcpFeedback||[]).filter(i=>i.type!=="transport-cc");else for(const r of t.codecs)r.rtcpFeedback=(r.rtcpFeedback||[]).filter(i=>i.type!=="transport-cc"&&i.type!=="goog-remb");return t}function ya(s,e){const t=[];if(!e)t.push(s[0]),Ot(s[1])&&t.push(s[1]);else{for(let r=0;r<s.length;++r)if(Qi(s[r],e,{strict:!0})){t.push(s[r]),Ot(s[r+1])&&t.push(s[r+1]);break}if(t.length===0)throw new TypeError("no matching codec found")}return t}function Ra(s){s=la.clone(s),ms(s);const e={mid:ua,codecs:[],headerExtensions:[],encodings:[{ssrc:ha}],rtcp:{cname:"probator"}};return e.codecs.push(s.codecs[0]),e.codecs[0].payloadType=fa,e.headerExtensions=s.headerExtensions,e}function Ca(s,e){return e.codecs.some(t=>t.kind===s)}function Ta(s,e){if(ms(s),s.codecs.length===0)return!1;const t=s.codecs[0];return e.codecs.some(r=>r.remotePayloadType===t.payloadType)}function Da(s){const e=new RegExp("^(audio|video)/(.+)","i");if(typeof s!="object")throw new TypeError("codec is not an object");if(!s.mimeType||typeof s.mimeType!="string")throw new TypeError("missing codec.mimeType");const t=e.exec(s.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");if(s.kind=t[1].toLowerCase(),s.preferredPayloadType&&typeof s.preferredPayloadType!="number")throw new TypeError("invalid codec.preferredPayloadType");if(typeof s.clockRate!="number")throw new TypeError("missing codec.clockRate");s.kind==="audio"?typeof s.channels!="number"&&(s.channels=1):delete s.channels,(!s.parameters||typeof s.parameters!="object")&&(s.parameters={});for(const r of Object.keys(s.parameters)){let i=s.parameters[r];if(i===void 0&&(s.parameters[r]="",i=""),typeof i!="string"&&typeof i!="number")throw new TypeError(`invalid codec parameter [key:${r}s, value:${i}]`);if(r==="apt"&&typeof i!="number")throw new TypeError("invalid codec apt parameter")}(!s.rtcpFeedback||!Array.isArray(s.rtcpFeedback))&&(s.rtcpFeedback=[]);for(const r of s.rtcpFeedback)Wi(r)}function Wi(s){if(typeof s!="object")throw new TypeError("fb is not an object");if(!s.type||typeof s.type!="string")throw new TypeError("missing fb.type");(!s.parameter||typeof s.parameter!="string")&&(s.parameter="")}function Pa(s){if(typeof s!="object")throw new TypeError("ext is not an object");if(s.kind!=="audio"&&s.kind!=="video")throw new TypeError("invalid ext.kind");if(!s.uri||typeof s.uri!="string")throw new TypeError("missing ext.uri");if(typeof s.preferredId!="number")throw new TypeError("missing ext.preferredId");if(s.preferredEncrypt&&typeof s.preferredEncrypt!="boolean")throw new TypeError("invalid ext.preferredEncrypt");if(s.preferredEncrypt||(s.preferredEncrypt=!1),s.direction&&typeof s.direction!="string")throw new TypeError("invalid ext.direction");s.direction||(s.direction="sendrecv")}function Ea(s){const e=new RegExp("^(audio|video)/(.+)","i");if(typeof s!="object")throw new TypeError("codec is not an object");if(!s.mimeType||typeof s.mimeType!="string")throw new TypeError("missing codec.mimeType");const t=e.exec(s.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");if(typeof s.payloadType!="number")throw new TypeError("missing codec.payloadType");if(typeof s.clockRate!="number")throw new TypeError("missing codec.clockRate");t[1].toLowerCase()==="audio"?typeof s.channels!="number"&&(s.channels=1):delete s.channels,(!s.parameters||typeof s.parameters!="object")&&(s.parameters={});for(const i of Object.keys(s.parameters)){let n=s.parameters[i];if(n===void 0&&(s.parameters[i]="",n=""),typeof n!="string"&&typeof n!="number")throw new TypeError(`invalid codec parameter [key:${i}s, value:${n}]`);if(i==="apt"&&typeof n!="number")throw new TypeError("invalid codec apt parameter")}(!s.rtcpFeedback||!Array.isArray(s.rtcpFeedback))&&(s.rtcpFeedback=[]);for(const i of s.rtcpFeedback)Wi(i)}function xa(s){if(typeof s!="object")throw new TypeError("ext is not an object");if(!s.uri||typeof s.uri!="string")throw new TypeError("missing ext.uri");if(typeof s.id!="number")throw new TypeError("missing ext.id");if(s.encrypt&&typeof s.encrypt!="boolean")throw new TypeError("invalid ext.encrypt");s.encrypt||(s.encrypt=!1),(!s.parameters||typeof s.parameters!="object")&&(s.parameters={});for(const e of Object.keys(s.parameters)){let t=s.parameters[e];if(t===void 0&&(s.parameters[e]="",t=""),typeof t!="string"&&typeof t!="number")throw new TypeError("invalid header extension parameter")}}function La(s){if(typeof s!="object")throw new TypeError("encoding is not an object");if(s.ssrc&&typeof s.ssrc!="number")throw new TypeError("invalid encoding.ssrc");if(s.rid&&typeof s.rid!="string")throw new TypeError("invalid encoding.rid");if(s.rtx&&typeof s.rtx!="object")throw new TypeError("invalid encoding.rtx");if(s.rtx&&typeof s.rtx.ssrc!="number")throw new TypeError("missing encoding.rtx.ssrc");if((!s.dtx||typeof s.dtx!="boolean")&&(s.dtx=!1),s.scalabilityMode&&typeof s.scalabilityMode!="string")throw new TypeError("invalid encoding.scalabilityMode")}function Ma(s){if(typeof s!="object")throw new TypeError("rtcp is not an object");if(s.cname&&typeof s.cname!="string")throw new TypeError("invalid rtcp.cname");(!s.reducedSize||typeof s.reducedSize!="boolean")&&(s.reducedSize=!0)}function Ia(s){if(typeof s!="object")throw new TypeError("numStreams is not an object");if(typeof s.OS!="number")throw new TypeError("missing numStreams.OS");if(typeof s.MIS!="number")throw new TypeError("missing numStreams.MIS")}function Ot(s){return s?/.+\/rtx$/i.test(s.mimeType):!1}function Qi(s,e,{strict:t=!1,modify:r=!1}={}){const i=s.mimeType.toLowerCase(),n=e.mimeType.toLowerCase();if(i!==n||s.clockRate!==e.clockRate||s.channels!==e.channels)return!1;switch(i){case"video/h264":{if(t){const a=s.parameters["packetization-mode"]||0,o=e.parameters["packetization-mode"]||0;if(a!==o||!Ks.isSameProfile(s.parameters,e.parameters))return!1;let d;try{d=Ks.generateProfileLevelIdStringForAnswer(s.parameters,e.parameters)}catch{return!1}r&&(d?(s.parameters["profile-level-id"]=d,e.parameters["profile-level-id"]=d):(delete s.parameters["profile-level-id"],delete e.parameters["profile-level-id"]))}break}case"video/vp9":{if(t){const a=s.parameters["profile-id"]||0,o=e.parameters["profile-id"]||0;if(a!==o)return!1}break}}return!0}function ka(s,e){return!(s.kind&&e.kind&&s.kind!==e.kind||s.uri!==e.uri)}function Oa(s,e){const t=[];for(const r of s.rtcpFeedback||[]){const i=(e.rtcpFeedback||[]).find(n=>n.type===r.type&&(n.parameter===r.parameter||!n.parameter&&!r.parameter));i&&t.push(i)}return t}var At={},Be={},yr={};Object.defineProperty(yr,"__esModule",{value:!0});yr.Logger=void 0;const tt=Nt,rt="awaitqueue";let ja=class{constructor(e){e?(this._debug=(0,tt.default)(`${rt}:${e}`),this._warn=(0,tt.default)(`${rt}:WARN:${e}`),this._error=(0,tt.default)(`${rt}:ERROR:${e}`)):(this._debug=(0,tt.default)(rt),this._warn=(0,tt.default)(`${rt}:WARN`),this._error=(0,tt.default)(`${rt}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};yr.Logger=ja;Object.defineProperty(Be,"__esModule",{value:!0});Be.AwaitQueue=Be.AwaitQueueRemovedTaskError=Be.AwaitQueueStoppedError=void 0;const $a=yr,Oe=new $a.Logger;class Rr extends Error{constructor(e){super(e??"AwaitQueue stopped"),this.name="AwaitQueueStoppedError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,Rr)}}Be.AwaitQueueStoppedError=Rr;class Cr extends Error{constructor(e){super(e??"AwaitQueue task removed"),this.name="AwaitQueueRemovedTaskError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,Cr)}}Be.AwaitQueueRemovedTaskError=Cr;class Na{constructor(){this.pendingTasks=new Map,this.nextTaskId=0,this.stopping=!1}get size(){return this.pendingTasks.size}async push(e,t){if(t=t??e.name,Oe.debug(`push() [name:${t}]`),typeof e!="function")throw new TypeError("given task is not a function");if(t)try{Object.defineProperty(e,"name",{value:t})}catch{}return new Promise((r,i)=>{const n={id:this.nextTaskId++,task:e,name:t,enqueuedAt:Date.now(),executedAt:void 0,completed:!1,resolve:a=>{if(n.completed)return;n.completed=!0,this.pendingTasks.delete(n.id),Oe.debug(`resolving task [name:${n.name}]`),r(a);const[o]=this.pendingTasks.values();o&&!o.executedAt&&this.execute(o)},reject:a=>{if(!n.completed&&(n.completed=!0,this.pendingTasks.delete(n.id),Oe.debug(`rejecting task [name:${n.name}]: %s`,String(a)),i(a),!this.stopping)){const[o]=this.pendingTasks.values();o&&!o.executedAt&&this.execute(o)}}};this.pendingTasks.set(n.id,n),this.pendingTasks.size===1&&this.execute(n)})}stop(){Oe.debug("stop()"),this.stopping=!0;for(const e of this.pendingTasks.values())Oe.debug(`stop() | stopping task [name:${e.name}]`),e.reject(new Rr);this.stopping=!1}remove(e){Oe.debug(`remove() [taskIdx:${e}]`);const t=Array.from(this.pendingTasks.values())[e];if(!t){Oe.debug(`stop() | no task with given idx [taskIdx:${e}]`);return}t.reject(new Cr)}dump(){const e=Date.now();let t=0;return Array.from(this.pendingTasks.values()).map(r=>({idx:t++,task:r.task,name:r.name,enqueuedTime:r.executedAt?r.executedAt-r.enqueuedAt:e-r.enqueuedAt,executionTime:r.executedAt?e-r.executedAt:0}))}async execute(e){if(Oe.debug(`execute() [name:${e.name}]`),e.executedAt)throw new Error("task already being executed");e.executedAt=Date.now();try{const t=await e.task();e.resolve(t)}catch(t){e.reject(t)}}}Be.AwaitQueue=Na;/*! queue-microtask. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */let Gs;var Aa=typeof queueMicrotask=="function"?queueMicrotask.bind(typeof window<"u"?window:_):s=>(Gs||(Gs=Promise.resolve())).then(s).catch(e=>setTimeout(()=>{throw e},0)),Ft={};Object.defineProperty(Ft,"__esModule",{value:!0});Ft.Producer=void 0;const Fa=G,Ws=Te,st=ee,ge=new Fa.Logger("Producer");class Ba extends Ws.EnhancedEventEmitter{constructor({id:e,localId:t,rtpSender:r,track:i,rtpParameters:n,stopTracks:a,disableTrackOnPause:o,zeroRtpOnPause:d,appData:p}){super(),this._closed=!1,this._observer=new Ws.EnhancedEventEmitter,ge.debug("constructor()"),this._id=e,this._localId=t,this._rtpSender=r,this._track=i,this._kind=i.kind,this._rtpParameters=n,this._paused=o?!i.enabled:!1,this._maxSpatialLayer=void 0,this._stopTracks=a,this._disableTrackOnPause=o,this._zeroRtpOnPause=d,this._appData=p||{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(ge.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(ge.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new st.InvalidStateError("closed");return new Promise((e,t)=>{this.safeEmit("@getstats",e,t)})}pause(){if(ge.debug("pause()"),this._closed){ge.error("pause() | Producer closed");return}this._paused=!0,this._track&&this._disableTrackOnPause&&(this._track.enabled=!1),this._zeroRtpOnPause&&new Promise((e,t)=>{this.safeEmit("@pause",e,t)}).catch(()=>{}),this._observer.safeEmit("pause")}resume(){if(ge.debug("resume()"),this._closed){ge.error("resume() | Producer closed");return}this._paused=!1,this._track&&this._disableTrackOnPause&&(this._track.enabled=!0),this._zeroRtpOnPause&&new Promise((e,t)=>{this.safeEmit("@resume",e,t)}).catch(()=>{}),this._observer.safeEmit("resume")}async replaceTrack({track:e}){if(ge.debug("replaceTrack() [track:%o]",e),this._closed){if(e&&this._stopTracks)try{e.stop()}catch{}throw new st.InvalidStateError("closed")}else if(e&&e.readyState==="ended")throw new st.InvalidStateError("track ended");if(e===this._track){ge.debug("replaceTrack() | same track, ignored");return}await new Promise((t,r)=>{this.safeEmit("@replacetrack",e,t,r)}),this.destroyTrack(),this._track=e,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this.handleTrack()}async setMaxSpatialLayer(e){if(this._closed)throw new st.InvalidStateError("closed");if(this._kind!=="video")throw new st.UnsupportedError("not a video Producer");if(typeof e!="number")throw new TypeError("invalid spatialLayer");e!==this._maxSpatialLayer&&(await new Promise((t,r)=>{this.safeEmit("@setmaxspatiallayer",e,t,r)}).catch(()=>{}),this._maxSpatialLayer=e)}async setRtpEncodingParameters(e){if(this._closed)throw new st.InvalidStateError("closed");if(typeof e!="object")throw new TypeError("invalid params");await new Promise((t,r)=>{this.safeEmit("@setrtpencodingparameters",e,t,r)})}onTrackEnded(){ge.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track&&this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){if(this._track)try{this._track.removeEventListener("ended",this.onTrackEnded),this._stopTracks&&this._track.stop()}catch{}}}Ft.Producer=Ba;var Bt={};Object.defineProperty(Bt,"__esModule",{value:!0});Bt.Consumer=void 0;const Ua=G,Qs=Te,za=ee,_e=new Ua.Logger("Consumer");class qa extends Qs.EnhancedEventEmitter{constructor({id:e,localId:t,producerId:r,rtpReceiver:i,track:n,rtpParameters:a,appData:o}){super(),this._closed=!1,this._observer=new Qs.EnhancedEventEmitter,_e.debug("constructor()"),this._id=e,this._localId=t,this._producerId=r,this._rtpReceiver=i,this._track=n,this._rtpParameters=a,this._paused=!n.enabled,this._appData=o||{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(_e.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(_e.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new za.InvalidStateError("closed");return new Promise((e,t)=>{this.safeEmit("@getstats",e,t)})}pause(){if(_e.debug("pause()"),this._closed){_e.error("pause() | Consumer closed");return}if(this._paused){_e.debug("pause() | Consumer is already paused");return}this._paused=!0,this._track.enabled=!1,this.emit("@pause"),this._observer.safeEmit("pause")}resume(){if(_e.debug("resume()"),this._closed){_e.error("resume() | Consumer closed");return}if(!this._paused){_e.debug("resume() | Consumer is already resumed");return}this._paused=!1,this._track.enabled=!0,this.emit("@resume"),this._observer.safeEmit("resume")}onTrackEnded(){_e.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){try{this._track.removeEventListener("ended",this.onTrackEnded),this._track.stop()}catch{}}}Bt.Consumer=qa;var Ut={};Object.defineProperty(Ut,"__esModule",{value:!0});Ut.DataProducer=void 0;const Ha=G,Zs=Te,Va=ee,Me=new Ha.Logger("DataProducer");class Ka extends Zs.EnhancedEventEmitter{constructor({id:e,dataChannel:t,sctpStreamParameters:r,appData:i}){super(),this._closed=!1,this._observer=new Zs.EnhancedEventEmitter,Me.debug("constructor()"),this._id=e,this._dataChannel=t,this._sctpStreamParameters=r,this._appData=i||{},this.handleDataChannel()}get id(){return this._id}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get bufferedAmount(){return this._dataChannel.bufferedAmount}get bufferedAmountLowThreshold(){return this._dataChannel.bufferedAmountLowThreshold}set bufferedAmountLowThreshold(e){this._dataChannel.bufferedAmountLowThreshold=e}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(Me.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(Me.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}send(e){if(Me.debug("send()"),this._closed)throw new Va.InvalidStateError("closed");this._dataChannel.send(e)}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(Me.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),t.errorDetail==="sctp-failure"?Me.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):Me.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(Me.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",()=>{this._closed||Me.warn('DataChannel "message" event in a DataProducer, message discarded')}),this._dataChannel.addEventListener("bufferedamountlow",()=>{this._closed||this.safeEmit("bufferedamountlow")})}}Ut.DataProducer=Ka;var zt={};Object.defineProperty(zt,"__esModule",{value:!0});zt.DataConsumer=void 0;const Ga=G,Js=Te,Ve=new Ga.Logger("DataConsumer");class Wa extends Js.EnhancedEventEmitter{constructor({id:e,dataProducerId:t,dataChannel:r,sctpStreamParameters:i,appData:n}){super(),this._closed=!1,this._observer=new Js.EnhancedEventEmitter,Ve.debug("constructor()"),this._id=e,this._dataProducerId=t,this._dataChannel=r,this._sctpStreamParameters=i,this._appData=n||{},this.handleDataChannel()}get id(){return this._id}get dataProducerId(){return this._dataProducerId}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get binaryType(){return this._dataChannel.binaryType}set binaryType(e){this._dataChannel.binaryType=e}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(Ve.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(Ve.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(Ve.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),t.errorDetail==="sctp-failure"?Ve.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):Ve.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(Ve.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",e=>{this._closed||this.safeEmit("message",e.data)})}}zt.DataConsumer=Wa;var Qa=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Za=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Zi=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&Qa(e,s,t);return Za(e,s),e},Ja=_&&_.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(At,"__esModule",{value:!0});At.Transport=void 0;const Ya=Be,Qr=Ja(Aa),Xa=G,Ys=Te,te=ee,Zr=Zi(J),xt=Zi(H),eo=Ft,to=Bt,ro=Ut,so=zt,X=new Xa.Logger("Transport");class io{constructor(e){this.consumerOptions=e,this.promise=new Promise((t,r)=>{this.resolve=t,this.reject=r})}}class no extends Ys.EnhancedEventEmitter{constructor({direction:e,id:t,iceParameters:r,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:c,appData:u,handlerFactory:l,extendedRtpCapabilities:h,canProduceByKind:f}){super(),this._closed=!1,this._iceGatheringState="new",this._connectionState="new",this._producers=new Map,this._consumers=new Map,this._dataProducers=new Map,this._dataConsumers=new Map,this._probatorConsumerCreated=!1,this._awaitQueue=new Ya.AwaitQueue,this._pendingConsumerTasks=[],this._consumerCreationInProgress=!1,this._pendingPauseConsumers=new Map,this._consumerPauseInProgress=!1,this._pendingResumeConsumers=new Map,this._consumerResumeInProgress=!1,this._pendingCloseConsumers=new Map,this._consumerCloseInProgress=!1,this._observer=new Ys.EnhancedEventEmitter,X.debug("constructor() [id:%s, direction:%s]",t,e),this._id=t,this._direction=e,this._extendedRtpCapabilities=h,this._canProduceByKind=f,this._maxSctpMessageSize=a?a.maxMessageSize:null;const m=Zr.clone(p)||{};delete m.iceServers,delete m.iceTransportPolicy,delete m.bundlePolicy,delete m.rtcpMuxPolicy,delete m.sdpSemantics,this._handler=l(),this._handler.run({direction:e,iceParameters:r,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:m,proprietaryConstraints:c,extendedRtpCapabilities:h}),this._appData=u||{},this.handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get iceGatheringState(){return this._iceGatheringState}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){if(!this._closed){X.debug("close()"),this._closed=!0,this._awaitQueue.stop(),this._handler.close(),this._connectionState="closed";for(const e of this._producers.values())e.transportClosed();this._producers.clear();for(const e of this._consumers.values())e.transportClosed();this._consumers.clear();for(const e of this._dataProducers.values())e.transportClosed();this._dataProducers.clear();for(const e of this._dataConsumers.values())e.transportClosed();this._dataConsumers.clear(),this._observer.safeEmit("close")}}async getStats(){if(this._closed)throw new te.InvalidStateError("closed");return this._handler.getTransportStats()}async restartIce({iceParameters:e}){if(X.debug("restartIce()"),this._closed)throw new te.InvalidStateError("closed");if(!e)throw new TypeError("missing iceParameters");return this._awaitQueue.push(async()=>await this._handler.restartIce(e),"transport.restartIce()")}async updateIceServers({iceServers:e}={}){if(X.debug("updateIceServers()"),this._closed)throw new te.InvalidStateError("closed");if(!Array.isArray(e))throw new TypeError("missing iceServers");return this._awaitQueue.push(async()=>this._handler.updateIceServers(e),"transport.updateIceServers()")}async produce({track:e,encodings:t,codecOptions:r,codec:i,stopTracks:n=!0,disableTrackOnPause:a=!0,zeroRtpOnPause:o=!1,onRtpSender:d,appData:p={}}={}){if(X.debug("produce() [track:%o]",e),this._closed)throw new te.InvalidStateError("closed");if(e){if(this._direction!=="send")throw new te.UnsupportedError("not a sending Transport");if(this._canProduceByKind[e.kind]){if(e.readyState==="ended")throw new te.InvalidStateError("track ended");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("produce")===0)throw new TypeError('no "produce" listener set into this transport');if(p&&typeof p!="object")throw new TypeError("if given, appData must be an object")}else throw new te.UnsupportedError(`cannot produce ${e.kind}`)}else throw new TypeError("missing track");return this._awaitQueue.push(async()=>{let c;if(t&&!Array.isArray(t))throw TypeError("encodings must be an array");t&&t.length===0?c=void 0:t&&(c=t.map(f=>{const m={active:!0};return f.active===!1&&(m.active=!1),typeof f.dtx=="boolean"&&(m.dtx=f.dtx),typeof f.scalabilityMode=="string"&&(m.scalabilityMode=f.scalabilityMode),typeof f.scaleResolutionDownBy=="number"&&(m.scaleResolutionDownBy=f.scaleResolutionDownBy),typeof f.maxBitrate=="number"&&(m.maxBitrate=f.maxBitrate),typeof f.maxFramerate=="number"&&(m.maxFramerate=f.maxFramerate),typeof f.adaptivePtime=="boolean"&&(m.adaptivePtime=f.adaptivePtime),typeof f.priority=="string"&&(m.priority=f.priority),typeof f.networkPriority=="string"&&(m.networkPriority=f.networkPriority),m}));const{localId:u,rtpParameters:l,rtpSender:h}=await this._handler.send({track:e,encodings:c,codecOptions:r,codec:i,onRtpSender:d});try{xt.validateRtpParameters(l);const{id:f}=await new Promise((g,v)=>{this.safeEmit("produce",{kind:e.kind,rtpParameters:l,appData:p},g,v)}),m=new eo.Producer({id:f,localId:u,rtpSender:h,track:e,rtpParameters:l,stopTracks:n,disableTrackOnPause:a,zeroRtpOnPause:o,appData:p});return this._producers.set(m.id,m),this.handleProducer(m),this._observer.safeEmit("newproducer",m),m}catch(f){throw this._handler.stopSending(u).catch(()=>{}),f}},"transport.produce()").catch(c=>{if(n)try{e.stop()}catch{}throw c})}async consume({id:e,producerId:t,kind:r,rtpParameters:i,streamId:n,onRtpReceiver:a,appData:o={}}){if(X.debug("consume()"),this._closed)throw new te.InvalidStateError("closed");if(this._direction!=="recv")throw new te.UnsupportedError("not a receiving Transport");if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing producerId");if(r!=="audio"&&r!=="video")throw new TypeError(`invalid kind '${r}'`);if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(o&&typeof o!="object")throw new TypeError("if given, appData must be an object");const d=Zr.clone(i);if(!xt.canReceive(d,this._extendedRtpCapabilities))throw new te.UnsupportedError("cannot consume this Producer");const c=new io({id:e,producerId:t,kind:r,rtpParameters:d,streamId:n,onRtpReceiver:a,appData:o});return this._pendingConsumerTasks.push(c),(0,Qr.default)(()=>{this._closed||this._consumerCreationInProgress===!1&&this.createPendingConsumers()}),c.promise}async produceData({ordered:e=!0,maxPacketLifeTime:t,maxRetransmits:r,label:i="",protocol:n="",appData:a={}}={}){if(X.debug("produceData()"),this._closed)throw new te.InvalidStateError("closed");if(this._direction!=="send")throw new te.UnsupportedError("not a sending Transport");if(this._maxSctpMessageSize){if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("producedata")===0)throw new TypeError('no "producedata" listener set into this transport');if(a&&typeof a!="object")throw new TypeError("if given, appData must be an object")}else throw new te.UnsupportedError("SCTP not enabled by remote Transport");return(t||r)&&(e=!1),this._awaitQueue.push(async()=>{const{dataChannel:o,sctpStreamParameters:d}=await this._handler.sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n});xt.validateSctpStreamParameters(d);const{id:p}=await new Promise((u,l)=>{this.safeEmit("producedata",{sctpStreamParameters:d,label:i,protocol:n,appData:a},u,l)}),c=new ro.DataProducer({id:p,dataChannel:o,sctpStreamParameters:d,appData:a});return this._dataProducers.set(c.id,c),this.handleDataProducer(c),this._observer.safeEmit("newdataproducer",c),c},"transport.produceData()")}async consumeData({id:e,dataProducerId:t,sctpStreamParameters:r,label:i="",protocol:n="",appData:a={}}){if(X.debug("consumeData()"),this._closed)throw new te.InvalidStateError("closed");if(this._direction!=="recv")throw new te.UnsupportedError("not a receiving Transport");if(this._maxSctpMessageSize){if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing dataProducerId");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(a&&typeof a!="object")throw new TypeError("if given, appData must be an object")}else throw new te.UnsupportedError("SCTP not enabled by remote Transport");const o=Zr.clone(r);return xt.validateSctpStreamParameters(o),this._awaitQueue.push(async()=>{const{dataChannel:d}=await this._handler.receiveDataChannel({sctpStreamParameters:o,label:i,protocol:n}),p=new so.DataConsumer({id:e,dataProducerId:t,dataChannel:d,sctpStreamParameters:o,appData:a});return this._dataConsumers.set(p.id,p),this.handleDataConsumer(p),this._observer.safeEmit("newdataconsumer",p),p},"transport.consumeData()")}async createPendingConsumers(){this._consumerCreationInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingConsumerTasks.length===0){X.debug("createPendingConsumers() | there is no Consumer to be created");return}const e=[...this._pendingConsumerTasks];this._pendingConsumerTasks=[];let t;const r=[];for(const i of e){const{id:n,kind:a,rtpParameters:o,streamId:d,onRtpReceiver:p}=i.consumerOptions;r.push({trackId:n,kind:a,rtpParameters:o,streamId:d,onRtpReceiver:p})}try{const i=await this._handler.receive(r);for(let n=0;n<i.length;++n){const a=e[n],o=i[n],{id:d,producerId:p,kind:c,rtpParameters:u,appData:l}=a.consumerOptions,{localId:h,rtpReceiver:f,track:m}=o,g=new to.Consumer({id:d,localId:h,producerId:p,rtpReceiver:f,track:m,rtpParameters:u,appData:l});this._consumers.set(g.id,g),this.handleConsumer(g),!this._probatorConsumerCreated&&!t&&c==="video"&&(t=g),this._observer.safeEmit("newconsumer",g),a.resolve(g)}}catch(i){for(const n of e)n.reject(i)}if(t)try{const i=xt.generateProbatorRtpParameters(t.rtpParameters);await this._handler.receive([{trackId:"probator",kind:"video",rtpParameters:i}]),X.debug("createPendingConsumers() | Consumer for RTP probation created"),this._probatorConsumerCreated=!0}catch(i){X.error("createPendingConsumers() | failed to create Consumer for RTP probation:%o",i)}},"transport.createPendingConsumers()").then(()=>{this._consumerCreationInProgress=!1,this._pendingConsumerTasks.length>0&&this.createPendingConsumers()}).catch(()=>{})}pausePendingConsumers(){this._consumerPauseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingPauseConsumers.size===0){X.debug("pausePendingConsumers() | there is no Consumer to be paused");return}const e=Array.from(this._pendingPauseConsumers.values());this._pendingPauseConsumers.clear();try{const t=e.map(r=>r.localId);await this._handler.pauseReceiving(t)}catch(t){X.error("pausePendingConsumers() | failed to pause Consumers:",t)}},"transport.pausePendingConsumers").then(()=>{this._consumerPauseInProgress=!1,this._pendingPauseConsumers.size>0&&this.pausePendingConsumers()}).catch(()=>{})}resumePendingConsumers(){this._consumerResumeInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingResumeConsumers.size===0){X.debug("resumePendingConsumers() | there is no Consumer to be resumed");return}const e=Array.from(this._pendingResumeConsumers.values());this._pendingResumeConsumers.clear();try{const t=e.map(r=>r.localId);await this._handler.resumeReceiving(t)}catch(t){X.error("resumePendingConsumers() | failed to resume Consumers:",t)}},"transport.resumePendingConsumers").then(()=>{this._consumerResumeInProgress=!1,this._pendingResumeConsumers.size>0&&this.resumePendingConsumers()}).catch(()=>{})}closePendingConsumers(){this._consumerCloseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingCloseConsumers.size===0){X.debug("closePendingConsumers() | there is no Consumer to be closed");return}const e=Array.from(this._pendingCloseConsumers.values());this._pendingCloseConsumers.clear();try{await this._handler.stopReceiving(e.map(t=>t.localId))}catch(t){X.error("closePendingConsumers() | failed to close Consumers:",t)}},"transport.closePendingConsumers").then(()=>{this._consumerCloseInProgress=!1,this._pendingCloseConsumers.size>0&&this.closePendingConsumers()}).catch(()=>{})}handleHandler(){const e=this._handler;e.on("@connect",({dtlsParameters:t},r,i)=>{if(this._closed){i(new te.InvalidStateError("closed"));return}this.safeEmit("connect",{dtlsParameters:t},r,i)}),e.on("@icegatheringstatechange",t=>{t!==this._iceGatheringState&&(X.debug("ICE gathering state changed to %s",t),this._iceGatheringState=t,this._closed||this.safeEmit("icegatheringstatechange",t))}),e.on("@connectionstatechange",t=>{t!==this._connectionState&&(X.debug("connection state changed to %s",t),this._connectionState=t,this._closed||this.safeEmit("connectionstatechange",t))})}handleProducer(e){e.on("@close",()=>{this._producers.delete(e.id),!this._closed&&this._awaitQueue.push(async()=>await this._handler.stopSending(e.localId),"producer @close event").catch(t=>X.warn("producer.close() failed:%o",t))}),e.on("@pause",(t,r)=>{this._awaitQueue.push(async()=>await this._handler.pauseSending(e.localId),"producer @pause event").then(t).catch(r)}),e.on("@resume",(t,r)=>{this._awaitQueue.push(async()=>await this._handler.resumeSending(e.localId),"producer @resume event").then(t).catch(r)}),e.on("@replacetrack",(t,r,i)=>{this._awaitQueue.push(async()=>await this._handler.replaceTrack(e.localId,t),"producer @replacetrack event").then(r).catch(i)}),e.on("@setmaxspatiallayer",(t,r,i)=>{this._awaitQueue.push(async()=>await this._handler.setMaxSpatialLayer(e.localId,t),"producer @setmaxspatiallayer event").then(r).catch(i)}),e.on("@setrtpencodingparameters",(t,r,i)=>{this._awaitQueue.push(async()=>await this._handler.setRtpEncodingParameters(e.localId,t),"producer @setrtpencodingparameters event").then(r).catch(i)}),e.on("@getstats",(t,r)=>{if(this._closed)return r(new te.InvalidStateError("closed"));this._handler.getSenderStats(e.localId).then(t).catch(r)})}handleConsumer(e){e.on("@close",()=>{this._consumers.delete(e.id),this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.delete(e.id),!this._closed&&(this._pendingCloseConsumers.set(e.id,e),this._consumerCloseInProgress===!1&&this.closePendingConsumers())}),e.on("@pause",()=>{this._pendingResumeConsumers.has(e.id)&&this._pendingResumeConsumers.delete(e.id),this._pendingPauseConsumers.set(e.id,e),(0,Qr.default)(()=>{this._closed||this._consumerPauseInProgress===!1&&this.pausePendingConsumers()})}),e.on("@resume",()=>{this._pendingPauseConsumers.has(e.id)&&this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.set(e.id,e),(0,Qr.default)(()=>{this._closed||this._consumerResumeInProgress===!1&&this.resumePendingConsumers()})}),e.on("@getstats",(t,r)=>{if(this._closed)return r(new te.InvalidStateError("closed"));this._handler.getReceiverStats(e.localId).then(t).catch(r)})}handleDataProducer(e){e.on("@close",()=>{this._dataProducers.delete(e.id)})}handleDataConsumer(e){e.on("@close",()=>{this._dataConsumers.delete(e.id)})}}At.Transport=no;var Tr={},Z={},Ji={},Yi={exports:{}},Xs=Yi.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(s){return s.encoding?"rtpmap:%d %s/%s/%s":s.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(s){return s.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(s){return s.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(s){return"extmap:%d"+(s.direction?"/%s":"%v")+(s["encrypt-uri"]?" %s":"%v")+" %s"+(s.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(s){return s.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(s){var e="candidate:%s %d %s %d %s %d typ %s";return e+=s.raddr!=null?" raddr %s rport %d":"%v%v",e+=s.tcptype!=null?" tcptype %s":"%v",s.generation!=null&&(e+=" generation %d"),e+=s["network-id"]!=null?" network-id %d":"%v",e+=s["network-cost"]!=null?" network-cost %d":"%v",e}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(s){var e="ssrc:%d";return s.attribute!=null&&(e+=" %s",s.value!=null&&(e+=":%s")),e}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(s){return s.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(s){return s.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(s){return"imageattr:%s %s %s"+(s.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(s){return"simulcast:%s %s"+(s.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(s){return"ts-refclk:%s"+(s.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(s){var e="mediaclk:";return e+=s.id!=null?"id=%s %s":"%v%s",e+=s.mediaClockValue!=null?"=%s":"",e+=s.rateNumerator!=null?" rate=%s":"",e+=s.rateDenominator!=null?"/%s":"",e}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(Xs).forEach(function(s){var e=Xs[s];e.forEach(function(t){t.reg||(t.reg=/(.*)/),t.format||(t.format="%s")})});var Xi=Yi.exports;(function(s){var e=function(o){return String(Number(o))===o?Number(o):o},t=function(o,d,p,c){if(c&&!p)d[c]=e(o[1]);else for(var u=0;u<p.length;u+=1)o[u+1]!=null&&(d[p[u]]=e(o[u+1]))},r=function(o,d,p){var c=o.name&&o.names;o.push&&!d[o.push]?d[o.push]=[]:c&&!d[o.name]&&(d[o.name]={});var u=o.push?{}:c?d[o.name]:d;t(p.match(o.reg),u,o.names,o.name),o.push&&d[o.push].push(u)},i=Xi,n=RegExp.prototype.test.bind(/^([a-z])=(.*)/);s.parse=function(o){var d={},p=[],c=d;return o.split(/(\r\n|\r|\n)/).filter(n).forEach(function(u){var l=u[0],h=u.slice(2);l==="m"&&(p.push({rtp:[],fmtp:[]}),c=p[p.length-1]);for(var f=0;f<(i[l]||[]).length;f+=1){var m=i[l][f];if(m.reg.test(h))return r(m,c,h)}}),d.media=p,d};var a=function(o,d){var p=d.split(/=(.+)/,2);return p.length===2?o[p[0]]=e(p[1]):p.length===1&&d.length>1&&(o[p[0]]=void 0),o};s.parseParams=function(o){return o.split(/;\s?/).reduce(a,{})},s.parseFmtpConfig=s.parseParams,s.parsePayloads=function(o){return o.toString().split(" ").map(Number)},s.parseRemoteCandidates=function(o){for(var d=[],p=o.split(" ").map(e),c=0;c<p.length;c+=3)d.push({component:p[c],ip:p[c+1],port:p[c+2]});return d},s.parseImageAttributes=function(o){return o.split(" ").map(function(d){return d.substring(1,d.length-1).split(",").reduce(a,{})})},s.parseSimulcastStreamList=function(o){return o.split(";").map(function(d){return d.split(",").map(function(p){var c,u=!1;return p[0]!=="~"?c=e(p):(c=e(p.substring(1,p.length)),u=!0),{scid:c,paused:u}})})}})(Ji);var Jr=Xi,ao=/%[sdv%]/g,oo=function(s){var e=1,t=arguments,r=t.length;return s.replace(ao,function(i){if(e>=r)return i;var n=t[e];switch(e+=1,i){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}})},Lt=function(s,e,t){var r=e.format instanceof Function?e.format(e.push?t:t[e.name]):e.format,i=[s+"="+r];if(e.names)for(var n=0;n<e.names.length;n+=1){var a=e.names[n];e.name?i.push(t[e.name][a]):i.push(t[e.names[n]])}else i.push(t[e.name]);return oo.apply(null,i)},co=["v","o","s","i","u","e","p","c","b","t","r","z","a"],po=["i","c","b","a"],lo=function(s,e){e=e||{},s.version==null&&(s.version=0),s.name==null&&(s.name=" "),s.media.forEach(function(n){n.payloads==null&&(n.payloads="")});var t=e.outerOrder||co,r=e.innerOrder||po,i=[];return t.forEach(function(n){Jr[n].forEach(function(a){a.name in s&&s[a.name]!=null?i.push(Lt(n,a,s)):a.push in s&&s[a.push]!=null&&s[a.push].forEach(function(o){i.push(Lt(n,a,o))})})}),s.media.forEach(function(n){i.push(Lt("m",Jr.m[0],n)),r.forEach(function(a){Jr[a].forEach(function(o){o.name in n&&n[o.name]!=null?i.push(Lt(a,o,n)):o.push in n&&n[o.push]!=null&&n[o.push].forEach(function(d){i.push(Lt(a,o,d))})})})}),i.join(`\r
`)+`\r
`},We=Ji,uo=lo;Z.write=uo;Z.parse=We.parse;Z.parseParams=We.parseParams;Z.parseFmtpConfig=We.parseFmtpConfig;Z.parsePayloads=We.parsePayloads;Z.parseRemoteCandidates=We.parseRemoteCandidates;Z.parseImageAttributes=We.parseImageAttributes;Z.parseSimulcastStreamList=We.parseSimulcastStreamList;var ne={},ho=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),fo=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),mo=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&ho(e,s,t);return fo(e,s),e};Object.defineProperty(ne,"__esModule",{value:!0});ne.extractRtpCapabilities=go;ne.extractDtlsParameters=_o;ne.getCname=wo;ne.applyCodecParameters=vo;const en=mo(Z);function go({sdpObject:s}){const e=new Map,t=[];let r=!1,i=!1;for(const a of s.media){const o=a.type;switch(o){case"audio":{if(r)continue;r=!0;break}case"video":{if(i)continue;i=!0;break}default:continue}for(const d of a.rtp){const p={kind:o,mimeType:`${o}/${d.codec}`,preferredPayloadType:d.payload,clockRate:d.rate,channels:d.encoding,parameters:{},rtcpFeedback:[]};e.set(p.preferredPayloadType,p)}for(const d of a.fmtp||[]){const p=en.parseParams(d.config),c=e.get(d.payload);c&&(p&&p.hasOwnProperty("profile-level-id")&&(p["profile-level-id"]=String(p["profile-level-id"])),c.parameters=p)}for(const d of a.rtcpFb||[]){const p={type:d.type,parameter:d.subtype};if(p.parameter||delete p.parameter,d.payload!=="*"){const c=e.get(d.payload);if(!c)continue;c.rtcpFeedback.push(p)}else for(const c of e.values())c.kind===o&&!/.+\/rtx$/i.test(c.mimeType)&&c.rtcpFeedback.push(p)}for(const d of a.ext||[]){if(d["encrypt-uri"])continue;const p={kind:o,uri:d.uri,preferredId:d.value};t.push(p)}}return{codecs:Array.from(e.values()),headerExtensions:t}}function _o({sdpObject:s}){let e=s.setup,t=s.fingerprint;if(!e||!t){const n=(s.media||[]).find(a=>a.port!==0);n&&(e??(e=n.setup),t??(t=n.fingerprint))}if(e){if(!t)throw new Error("no a=fingerprint found at SDP session or media level")}else throw new Error("no a=setup found at SDP session or media level");let r;switch(e){case"active":{r="client";break}case"passive":{r="server";break}case"actpass":{r="auto";break}}return{role:r,fingerprints:[{algorithm:t.type,value:t.hash}]}}function wo({offerMediaObject:s}){const e=(s.ssrcs||[]).find(t=>t.attribute==="cname");return e?e.value:""}function vo({offerRtpParameters:s,answerMediaObject:e}){for(const t of s.codecs){const r=t.mimeType.toLowerCase();if(r!=="audio/opus"||!(e.rtp||[]).find(o=>o.payload===t.payloadType))continue;e.fmtp=e.fmtp||[];let n=e.fmtp.find(o=>o.payload===t.payloadType);n||(n={payload:t.payloadType,config:""},e.fmtp.push(n));const a=en.parseParams(n.config);switch(r){case"audio/opus":{const o=t.parameters["sprop-stereo"];o!==void 0&&(a.stereo=o?1:0);break}}n.config="";for(const o of Object.keys(a))n.config&&(n.config+=";"),n.config+=`${o}=${a[o]}`}}var De={};Object.defineProperty(De,"__esModule",{value:!0});De.getRtpEncodings=bo;De.addLegacySimulcast=So;function bo({offerMediaObject:s}){const e=new Set;for(const i of s.ssrcs||[]){const n=i.id;e.add(n)}if(e.size===0)throw new Error("no a=ssrc lines found");const t=new Map;for(const i of s.ssrcGroups||[]){if(i.semantics!=="FID")continue;let[n,a]=i.ssrcs.split(/\s+/);n=Number(n),a=Number(a),e.has(n)&&(e.delete(n),e.delete(a),t.set(n,a))}for(const i of e)t.set(i,null);const r=[];for(const[i,n]of t){const a={ssrc:i};n&&(a.rtx={ssrc:n}),r.push(a)}return r}function So({offerMediaObject:s,numStreams:e}){if(e<=1)throw new TypeError("numStreams must be greater than 1");const t=(s.ssrcs||[]).find(u=>u.attribute==="msid");if(!t)throw new Error("a=ssrc line with msid information not found");const[r,i]=t.value.split(" "),n=t.id;let a;(s.ssrcGroups||[]).some(u=>{if(u.semantics!=="FID")return!1;const l=u.ssrcs.split(/\s+/);return Number(l[0])===n?(a=Number(l[1]),!0):!1});const o=s.ssrcs.find(u=>u.attribute==="cname");if(!o)throw new Error("a=ssrc line with cname information not found");const d=o.value,p=[],c=[];for(let u=0;u<e;++u)p.push(n+u),a&&c.push(a+u);s.ssrcGroups=[],s.ssrcs=[],s.ssrcGroups.push({semantics:"SIM",ssrcs:p.join(" ")});for(let u=0;u<p.length;++u){const l=p[u];s.ssrcs.push({id:l,attribute:"cname",value:d}),s.ssrcs.push({id:l,attribute:"msid",value:`${r} ${i}`})}for(let u=0;u<c.length;++u){const l=p[u],h=c[u];s.ssrcs.push({id:h,attribute:"cname",value:d}),s.ssrcs.push({id:h,attribute:"msid",value:`${r} ${i}`}),s.ssrcGroups.push({semantics:"FID",ssrcs:`${l} ${h}`})}}var St={};Object.defineProperty(St,"__esModule",{value:!0});St.addNackSuppportForOpus=yo;function yo(s){var e;for(const t of s.codecs||[])(t.mimeType.toLowerCase()==="audio/opus"||t.mimeType.toLowerCase()==="audio/multiopus")&&!((e=t.rtcpFeedback)!=null&&e.some(r=>r.type==="nack"&&!r.parameter))&&(t.rtcpFeedback||(t.rtcpFeedback=[]),t.rtcpFeedback.push({type:"nack"}))}var ae={};Object.defineProperty(ae,"__esModule",{value:!0});ae.HandlerInterface=void 0;const Ro=Te;class Co extends Ro.EnhancedEventEmitter{constructor(){super()}}ae.HandlerInterface=Co;var oe={},Ue={},To=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Do=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),tn=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&To(e,s,t);return Do(e,s),e};Object.defineProperty(Ue,"__esModule",{value:!0});Ue.OfferMediaSection=Ue.AnswerMediaSection=Ue.MediaSection=void 0;const Po=tn(Z),ei=tn(J);class gs{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:r,planB:i=!1}){if(this._mediaObject={},this._planB=i,e&&this.setIceParameters(e),t){this._mediaObject.candidates=[];for(const n of t){const a={};a.component=1,a.foundation=n.foundation,a.ip=n.address??n.ip,a.port=n.port,a.priority=n.priority,a.transport=n.protocol,a.type=n.type,n.tcpType&&(a.tcptype=n.tcpType),this._mediaObject.candidates.push(a)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}r&&this.setDtlsRole(r.role)}get mid(){return String(this._mediaObject.mid)}get closed(){return this._mediaObject.port===0}getObject(){return this._mediaObject}setIceParameters(e){this._mediaObject.iceUfrag=e.usernameFragment,this._mediaObject.icePwd=e.password}pause(){this._mediaObject.direction="inactive"}disable(){this.pause(),delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}close(){this.disable(),this._mediaObject.port=0}}Ue.MediaSection=gs;class Eo extends gs{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:r,sctpParameters:i,plainRtpParameters:n,planB:a=!1,offerMediaObject:o,offerRtpParameters:d,answerRtpParameters:p,codecOptions:c,extmapAllowMixed:u=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:r,planB:a}),this._mediaObject.mid=String(o.mid),this._mediaObject.type=o.type,this._mediaObject.protocol=o.protocol,n?(this._mediaObject.connection={ip:n.ip,version:n.ipVersion},this._mediaObject.port=n.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),o.type){case"audio":case"video":{this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(const l of p.codecs){const h={payload:l.payloadType,codec:ps(l),rate:l.clockRate};l.channels>1&&(h.encoding=l.channels),this._mediaObject.rtp.push(h);const f=ei.clone(l.parameters)??{};let m=ei.clone(l.rtcpFeedback)??[];if(c){const{opusStereo:v,opusFec:N,opusDtx:S,opusMaxPlaybackRate:b,opusMaxAverageBitrate:W,opusPtime:Y,opusNack:ke,videoGoogleStartBitrate:le,videoGoogleMaxBitrate:se,videoGoogleMinBitrate:he}=c,ce=d.codecs.find(ie=>ie.payloadType===l.payloadType);switch(l.mimeType.toLowerCase()){case"audio/opus":case"audio/multiopus":{v!==void 0&&(ce.parameters["sprop-stereo"]=v?1:0,f.stereo=v?1:0),N!==void 0&&(ce.parameters.useinbandfec=N?1:0,f.useinbandfec=N?1:0),S!==void 0&&(ce.parameters.usedtx=S?1:0,f.usedtx=S?1:0),b!==void 0&&(f.maxplaybackrate=b),W!==void 0&&(f.maxaveragebitrate=W),Y!==void 0&&(ce.parameters.ptime=Y,f.ptime=Y),ke||(ce.rtcpFeedback=ce.rtcpFeedback.filter(ie=>ie.type!=="nack"||ie.parameter),m=m.filter(ie=>ie.type!=="nack"||ie.parameter));break}case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":{le!==void 0&&(f["x-google-start-bitrate"]=le),se!==void 0&&(f["x-google-max-bitrate"]=se),he!==void 0&&(f["x-google-min-bitrate"]=he);break}}}const g={payload:l.payloadType,config:""};for(const v of Object.keys(f))g.config&&(g.config+=";"),g.config+=`${v}=${f[v]}`;g.config&&this._mediaObject.fmtp.push(g);for(const v of m)this._mediaObject.rtcpFb.push({payload:l.payloadType,type:v.type,subtype:v.parameter})}this._mediaObject.payloads=p.codecs.map(l=>l.payloadType).join(" "),this._mediaObject.ext=[];for(const l of p.headerExtensions)(o.ext||[]).some(f=>f.uri===l.uri)&&this._mediaObject.ext.push({uri:l.uri,value:l.id});if(u&&o.extmapAllowMixed==="extmap-allow-mixed"&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),o.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:o.simulcast.list1},this._mediaObject.rids=[];for(const l of o.rids||[])l.direction==="send"&&this._mediaObject.rids.push({id:l.id,direction:"recv"})}else if(o.simulcast_03){this._mediaObject.simulcast_03={value:o.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(const l of o.rids||[])l.direction==="send"&&this._mediaObject.rids.push({id:l.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize",this._planB&&this._mediaObject.type==="video"&&(this._mediaObject.xGoogleFlag="conference");break}case"application":{typeof o.sctpPort=="number"?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=i.port,this._mediaObject.maxMessageSize=i.maxMessageSize):o.sctpmap&&(this._mediaObject.payloads=i.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:i.port,maxMessageSize:i.maxMessageSize});break}}}setDtlsRole(e){switch(e){case"client":{this._mediaObject.setup="active";break}case"server":{this._mediaObject.setup="passive";break}case"auto":{this._mediaObject.setup="actpass";break}}}resume(){this._mediaObject.direction="recvonly"}muxSimulcastStreams(e){var n;if(!this._mediaObject.simulcast||!this._mediaObject.simulcast.list1)return;const t={};for(const a of e)a.rid&&(t[a.rid]=a);const r=this._mediaObject.simulcast.list1,i=Po.parseSimulcastStreamList(r);for(const a of i)for(const o of a)o.paused=!((n=t[o.scid])!=null&&n.active);this._mediaObject.simulcast.list1=i.map(a=>a.map(o=>`${o.paused?"~":""}${o.scid}`).join(",")).join(";")}}Ue.AnswerMediaSection=Eo;class xo extends gs{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:r,sctpParameters:i,plainRtpParameters:n,planB:a=!1,mid:o,kind:d,offerRtpParameters:p,streamId:c,trackId:u,oldDataChannelSpec:l=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:r,planB:a}),this._mediaObject.mid=String(o),this._mediaObject.type=d,n?(this._mediaObject.connection={ip:n.ip,version:n.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=n.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},i?this._mediaObject.protocol="UDP/DTLS/SCTP":this._mediaObject.protocol="UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),d){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._planB||(this._mediaObject.msid=`${c||"-"} ${u}`);for(const g of p.codecs){const v={payload:g.payloadType,codec:ps(g),rate:g.clockRate};g.channels>1&&(v.encoding=g.channels),this._mediaObject.rtp.push(v);const N={payload:g.payloadType,config:""};for(const S of Object.keys(g.parameters))N.config&&(N.config+=";"),N.config+=`${S}=${g.parameters[S]}`;N.config&&this._mediaObject.fmtp.push(N);for(const S of g.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:g.payloadType,type:S.type,subtype:S.parameter})}this._mediaObject.payloads=p.codecs.map(g=>g.payloadType).join(" "),this._mediaObject.ext=[];for(const g of p.headerExtensions)this._mediaObject.ext.push({uri:g.uri,value:g.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";const h=p.encodings[0],f=h.ssrc,m=h.rtx&&h.rtx.ssrc?h.rtx.ssrc:void 0;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],p.rtcp.cname&&this._mediaObject.ssrcs.push({id:f,attribute:"cname",value:p.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:f,attribute:"msid",value:`${c||"-"} ${u}`}),m&&(p.rtcp.cname&&this._mediaObject.ssrcs.push({id:m,attribute:"cname",value:p.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:m,attribute:"msid",value:`${c||"-"} ${u}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${f} ${m}`}));break}case"application":{l?(this._mediaObject.payloads=i.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:i.port,maxMessageSize:i.maxMessageSize}):(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=i.port,this._mediaObject.maxMessageSize=i.maxMessageSize);break}}}setDtlsRole(e){this._mediaObject.setup="actpass"}resume(){this._mediaObject.direction="sendonly"}planBReceive({offerRtpParameters:e,streamId:t,trackId:r}){const i=e.encodings[0],n=i.ssrc,a=i.rtx&&i.rtx.ssrc?i.rtx.ssrc:void 0,o=this._mediaObject.payloads.split(" ");for(const d of e.codecs){if(o.includes(String(d.payloadType)))continue;const p={payload:d.payloadType,codec:ps(d),rate:d.clockRate};d.channels>1&&(p.encoding=d.channels),this._mediaObject.rtp.push(p);const c={payload:d.payloadType,config:""};for(const u of Object.keys(d.parameters))c.config&&(c.config+=";"),c.config+=`${u}=${d.parameters[u]}`;c.config&&this._mediaObject.fmtp.push(c);for(const u of d.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:d.payloadType,type:u.type,subtype:u.parameter})}this._mediaObject.payloads+=` ${e.codecs.filter(d=>!this._mediaObject.payloads.includes(d.payloadType)).map(d=>d.payloadType).join(" ")}`,this._mediaObject.payloads=this._mediaObject.payloads.trim(),e.rtcp.cname&&this._mediaObject.ssrcs.push({id:n,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:n,attribute:"msid",value:`${t||"-"} ${r}`}),a&&(e.rtcp.cname&&this._mediaObject.ssrcs.push({id:a,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:a,attribute:"msid",value:`${t||"-"} ${r}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${n} ${a}`}))}planBStopReceiving({offerRtpParameters:e}){const t=e.encodings[0],r=t.ssrc,i=t.rtx&&t.rtx.ssrc?t.rtx.ssrc:void 0;this._mediaObject.ssrcs=this._mediaObject.ssrcs.filter(n=>n.id!==r&&n.id!==i),i&&(this._mediaObject.ssrcGroups=this._mediaObject.ssrcGroups.filter(n=>n.ssrcs!==`${r} ${i}`))}}Ue.OfferMediaSection=xo;function ps(s){const t=new RegExp("^(audio|video)/(.+)","i").exec(s.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");return t[2]}var Lo=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Mo=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Io=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&Lo(e,s,t);return Mo(e,s),e};Object.defineProperty(oe,"__esModule",{value:!0});oe.RemoteSdp=void 0;const ko=Io(Z),Oo=G,sr=Ue,Yr=new Oo.Logger("RemoteSdp");class jo{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:r,sctpParameters:i,plainRtpParameters:n,planB:a=!1}){if(this._mediaSections=[],this._midToIndex=new Map,this._iceParameters=e,this._iceCandidates=t,this._dtlsParameters=r,this._sctpParameters=i,this._plainRtpParameters=n,this._planB=a,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:1e4,sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},e&&e.iceLite&&(this._sdpObject.icelite="ice-lite"),r){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};const o=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:r.fingerprints[o-1].algorithm,hash:r.fingerprints[o-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}n&&(this._sdpObject.origin.address=n.ip,this._sdpObject.origin.ipVer=n.ipVersion)}updateIceParameters(e){Yr.debug("updateIceParameters() [iceParameters:%o]",e),this._iceParameters=e,this._sdpObject.icelite=e.iceLite?"ice-lite":void 0;for(const t of this._mediaSections)t.setIceParameters(e)}updateDtlsRole(e){Yr.debug("updateDtlsRole() [role:%s]",e),this._dtlsParameters.role=e;for(const t of this._mediaSections)t.setDtlsRole(e)}getNextMediaSectionIdx(){for(let e=0;e<this._mediaSections.length;++e){const t=this._mediaSections[e];if(t.closed)return{idx:e,reuseMid:t.mid}}return{idx:this._mediaSections.length}}send({offerMediaObject:e,reuseMid:t,offerRtpParameters:r,answerRtpParameters:i,codecOptions:n,extmapAllowMixed:a=!1}){const o=new sr.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,offerMediaObject:e,offerRtpParameters:r,answerRtpParameters:i,codecOptions:n,extmapAllowMixed:a});t?this._replaceMediaSection(o,t):this._midToIndex.has(o.mid)?this._replaceMediaSection(o):this._addMediaSection(o)}receive({mid:e,kind:t,offerRtpParameters:r,streamId:i,trackId:n}){const a=this._midToIndex.get(e);let o;if(a!==void 0&&(o=this._mediaSections[a]),o)o.planBReceive({offerRtpParameters:r,streamId:i,trackId:n}),this._replaceMediaSection(o);else{o=new sr.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:e,kind:t,offerRtpParameters:r,streamId:i,trackId:n});const d=this._mediaSections.find(p=>p.closed);d?this._replaceMediaSection(o,d.mid):this._addMediaSection(o)}}pauseMediaSection(e){this._findMediaSection(e).pause()}resumeSendingMediaSection(e){this._findMediaSection(e).resume()}resumeReceivingMediaSection(e){this._findMediaSection(e).resume()}disableMediaSection(e){this._findMediaSection(e).disable()}closeMediaSection(e){const t=this._findMediaSection(e);return e===this._firstMid?(Yr.debug("closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",e),this.disableMediaSection(e),!1):(t.close(),this._regenerateBundleMids(),!0)}muxMediaSectionSimulcast(e,t){const r=this._findMediaSection(e);r.muxSimulcastStreams(t),this._replaceMediaSection(r)}planBStopReceiving({mid:e,offerRtpParameters:t}){const r=this._findMediaSection(e);r.planBStopReceiving({offerRtpParameters:t}),this._replaceMediaSection(r)}sendSctpAssociation({offerMediaObject:e}){const t=new sr.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:e});this._addMediaSection(t)}receiveSctpAssociation({oldDataChannelSpec:e=!1}={}){const t=new sr.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application",oldDataChannelSpec:e});this._addMediaSection(t)}getSdp(){return this._sdpObject.origin.sessionVersion++,ko.write(this._sdpObject)}_addMediaSection(e){this._firstMid||(this._firstMid=e.mid),this._mediaSections.push(e),this._midToIndex.set(e.mid,this._mediaSections.length-1),this._sdpObject.media.push(e.getObject()),this._regenerateBundleMids()}_replaceMediaSection(e,t){if(typeof t=="string"){const r=this._midToIndex.get(t);if(r===void 0)throw new Error(`no media section found for reuseMid '${t}'`);const i=this._mediaSections[r];this._mediaSections[r]=e,this._midToIndex.delete(i.mid),this._midToIndex.set(e.mid,r),this._sdpObject.media[r]=e.getObject(),this._regenerateBundleMids()}else{const r=this._midToIndex.get(e.mid);if(r===void 0)throw new Error(`no media section found with mid '${e.mid}'`);this._mediaSections[r]=e,this._sdpObject.media[r]=e.getObject()}}_findMediaSection(e){const t=this._midToIndex.get(e);if(t===void 0)throw new Error(`no media section found with mid '${e}'`);return this._mediaSections[t]}_regenerateBundleMids(){this._dtlsParameters&&(this._sdpObject.groups[0].mids=this._mediaSections.filter(e=>!e.closed).map(e=>e.mid).join(" "))}}oe.RemoteSdp=jo;var Pe={};Object.defineProperty(Pe,"__esModule",{value:!0});Pe.parse=No;const $o=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");function No(s){const e=$o.exec(s||"");return e?{spatialLayers:Number(e[1]),temporalLayers:Number(e[2])}:{spatialLayers:1,temporalLayers:1}}var Ao=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Fo=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),yt=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&Ao(e,s,t);return Fo(e,s),e};Object.defineProperty(Tr,"__esModule",{value:!0});Tr.Chrome111=void 0;const je=yt(Z),Bo=G,ti=yt(J),it=yt(H),ir=yt(ne),ri=yt(De),Uo=yt(St),zo=ee,qo=ae,Ho=oe,Vo=Pe,T=new Bo.Logger("Chrome111"),si={OS:1024,MIS:1024};class _s extends qo.HandlerInterface{static createFactory(){return()=>new _s}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Chrome111"}close(){if(T.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){T.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const r=je.parse(t.sdp),i=ir.extractRtpCapabilities({sdpObject:r});return Uo.addNackSuppportForOpus(i),i}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return T.debug("getNativeSctpCapabilities()"),{numStreams:si}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){this.assertNotClosed(),T.debug("run()"),this._direction=e,this._remoteSdp=new Ho.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:it.getSendingRtpParameters("audio",c),video:it.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:it.getSendingRemoteRtpParameters("audio",c),video:it.getSendingRemoteRtpParameters("video",c)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):(T.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}))}async updateIceServers(e){this.assertNotClosed(),T.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),T.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});T.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();T.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i,onRtpSender:n}){if(this.assertNotClosed(),this.assertSendDirection(),T.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1){let m=1;for(const g of t){const v=g.scalabilityMode?(0,Vo.parse)(g.scalabilityMode).temporalLayers:3;v>m&&(m=v)}t.forEach((g,v)=>{g.rid=`r${v}`,g.scalabilityMode=`L1T${m}`})}const a=ti.clone(this._sendingRtpParametersByKind[e.kind]);a.codecs=it.reduceCodecs(a.codecs,i);const o=ti.clone(this._sendingRemoteRtpParametersByKind[e.kind]);o.codecs=it.reduceCodecs(o.codecs,i);const d=this._remoteSdp.getNextMediaSectionIdx(),p=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});n&&n(p.sender);const c=await this._pc.createOffer();let u=je.parse(c.sdp);this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:u}),T.debug("send() | calling pc.setLocalDescription() [offer:%o]",c),await this._pc.setLocalDescription(c);const l=p.mid;a.mid=l,u=je.parse(this._pc.localDescription.sdp);const h=u.media[d.idx];if(a.rtcp.cname=ir.getCname({offerMediaObject:h}),!t)a.encodings=ri.getRtpEncodings({offerMediaObject:h});else if(t.length===1){const m=ri.getRtpEncodings({offerMediaObject:h});Object.assign(m[0],t[0]),a.encodings=m}else a.encodings=t;this._remoteSdp.send({offerMediaObject:h,reuseMid:d.reuseMid,offerRtpParameters:a,answerRtpParameters:o,codecOptions:r,extmapAllowMixed:!0});const f={type:"answer",sdp:this._remoteSdp.getSdp()};return T.debug("send() | calling pc.setRemoteDescription() [answer:%o]",f),await this._pc.setRemoteDescription(f),this._mapMidTransceiver.set(l,p),{localId:l,rtpParameters:a,rtpSender:p.sender}}async stopSending(e){if(this.assertSendDirection(),T.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const i=await this._pc.createOffer();T.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),T.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const r=await this._pc.createOffer();T.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),T.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const r=await this._pc.createOffer();T.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?T.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):T.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),T.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((o,d)=>{d<=t?o.active=!0:o.active=!1}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();T.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),T.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((o,d)=>{i.encodings[d]={...o,...t}}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();T.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertNotClosed(),this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:n};T.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(i,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%si.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=je.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),T.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],r=new Map;for(const o of e){const{trackId:d,kind:p,rtpParameters:c,streamId:u}=o;T.debug("receive() [trackId:%s, kind:%s]",d,p);const l=c.mid||String(this._mapMidTransceiver.size);r.set(d,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:c,streamId:u||c.rtcp.cname,trackId:d})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);for(const o of e){const{trackId:d,onRtpReceiver:p}=o;if(p){const c=r.get(d),u=this._pc.getTransceivers().find(l=>l.mid===c);if(!u)throw new Error("transceiver not found");p(u.receiver)}}let n=await this._pc.createAnswer();const a=je.parse(n.sdp);for(const o of e){const{trackId:d,rtpParameters:p}=o,c=r.get(d),u=a.media.find(l=>String(l.mid)===c);ir.applyCodecParameters({offerRtpParameters:p,answerMediaObject:u})}n={type:"answer",sdp:je.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),T.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{trackId:d}=o,p=r.get(d),c=this._pc.getTransceivers().find(u=>u.mid===p);if(c)this._mapMidTransceiver.set(p,c),t.push({localId:p,track:c.receiver.track,rtpReceiver:c.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const i of e){T.debug("stopReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();T.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r);for(const i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){T.debug("pauseReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();T.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){T.debug("resumeReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();T.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o,protocol:r};T.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=je.parse(u.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}T.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=je.parse(this._pc.localDescription.sdp));const r=ir.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new zo.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Tr.Chrome111=_s;var Dr={},Ko=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Go=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Rt=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&Ko(e,s,t);return Go(e,s),e};Object.defineProperty(Dr,"__esModule",{value:!0});Dr.Chrome74=void 0;const we=Rt(Z),Wo=G,ii=Rt(J),nt=Rt(H),nr=Rt(ne),Xr=Rt(De),Qo=Rt(St),Zo=ee,Jo=ae,Yo=oe,Xo=Pe,R=new Wo.Logger("Chrome74"),ni={OS:1024,MIS:1024};class ws extends Jo.HandlerInterface{static createFactory(){return()=>new ws}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Chrome74"}close(){if(R.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){R.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const r=we.parse(t.sdp),i=nr.extractRtpCapabilities({sdpObject:r});return Qo.addNackSuppportForOpus(i),i}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return R.debug("getNativeSctpCapabilities()"),{numStreams:ni}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){R.debug("run()"),this._direction=e,this._remoteSdp=new Yo.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:nt.getSendingRtpParameters("audio",c),video:nt.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:nt.getSendingRemoteRtpParameters("audio",c),video:nt.getSendingRemoteRtpParameters("video",c)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):(R.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}))}async updateIceServers(e){this.assertNotClosed(),R.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),R.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});R.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};R.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();R.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){this.assertNotClosed(),this.assertSendDirection(),R.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((g,v)=>{g.rid=`r${v}`});const n=ii.clone(this._sendingRtpParametersByKind[e.kind]);n.codecs=nt.reduceCodecs(n.codecs,i);const a=ii.clone(this._sendingRemoteRtpParametersByKind[e.kind]);a.codecs=nt.reduceCodecs(a.codecs,i);const o=this._remoteSdp.getNextMediaSectionIdx(),d=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});let p=await this._pc.createOffer(),c=we.parse(p.sdp),u;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c});let l=!1;const h=(0,Xo.parse)((t||[{}])[0].scalabilityMode);t&&t.length===1&&h.spatialLayers>1&&n.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(R.debug("send() | enabling legacy simulcast for VP9 SVC"),l=!0,c=we.parse(p.sdp),u=c.media[o.idx],Xr.addLegacySimulcast({offerMediaObject:u,numStreams:h.spatialLayers}),p={type:"offer",sdp:we.write(c)}),R.debug("send() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p);const f=d.mid;if(n.mid=f,c=we.parse(this._pc.localDescription.sdp),u=c.media[o.idx],n.rtcp.cname=nr.getCname({offerMediaObject:u}),!t)n.encodings=Xr.getRtpEncodings({offerMediaObject:u});else if(t.length===1){let g=Xr.getRtpEncodings({offerMediaObject:u});Object.assign(g[0],t[0]),l&&(g=[g[0]]),n.encodings=g}else n.encodings=t;if(n.encodings.length>1&&(n.codecs[0].mimeType.toLowerCase()==="video/vp8"||n.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const g of n.encodings)g.scalabilityMode?g.scalabilityMode=`L1T${h.temporalLayers}`:g.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:u,reuseMid:o.reuseMid,offerRtpParameters:n,answerRtpParameters:a,codecOptions:r,extmapAllowMixed:!0});const m={type:"answer",sdp:this._remoteSdp.getSdp()};return R.debug("send() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._mapMidTransceiver.set(f,d),{localId:f,rtpParameters:n,rtpSender:d.sender}}async stopSending(e){if(this.assertSendDirection(),R.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const i=await this._pc.createOffer();R.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),R.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const r=await this._pc.createOffer();R.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),R.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const r=await this._pc.createOffer();R.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?R.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):R.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),R.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((o,d)=>{d<=t?o.active=!0:o.active=!1}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();R.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),R.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((o,d)=>{i.encodings[d]={...o,...t}}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();R.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertNotClosed(),this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:n};R.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(i,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%ni.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=we.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),R.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],r=new Map;for(const o of e){const{trackId:d,kind:p,rtpParameters:c,streamId:u}=o;R.debug("receive() [trackId:%s, kind:%s]",d,p);const l=c.mid||String(this._mapMidTransceiver.size);r.set(d,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:c,streamId:u||c.rtcp.cname,trackId:d})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};R.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const a=we.parse(n.sdp);for(const o of e){const{trackId:d,rtpParameters:p}=o,c=r.get(d),u=a.media.find(l=>String(l.mid)===c);nr.applyCodecParameters({offerRtpParameters:p,answerMediaObject:u})}n={type:"answer",sdp:we.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),R.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{trackId:d}=o,p=r.get(d),c=this._pc.getTransceivers().find(u=>u.mid===p);if(c)this._mapMidTransceiver.set(p,c),t.push({localId:p,track:c.receiver.track,rtpReceiver:c.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const i of e){R.debug("stopReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};R.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();R.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r);for(const i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){R.debug("pauseReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};R.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();R.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){R.debug("resumeReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};R.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();R.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o,protocol:r};R.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};R.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=we.parse(u.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}R.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=we.parse(this._pc.localDescription.sdp));const r=nr.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new Zo.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Dr.Chrome74=ws;var Pr={},ec=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),tc=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),qt=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&ec(e,s,t);return tc(e,s),e};Object.defineProperty(Pr,"__esModule",{value:!0});Pr.Chrome70=void 0;const de=qt(Z),rc=G,ai=qt(J),at=qt(H),ar=qt(ne),es=qt(De),sc=ae,ic=oe,nc=Pe,M=new rc.Logger("Chrome70"),oi={OS:1024,MIS:1024};class vs extends sc.HandlerInterface{static createFactory(){return()=>new vs}constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Chrome70"}close(){if(M.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){M.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const r=de.parse(t.sdp);return ar.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return M.debug("getNativeSctpCapabilities()"),{numStreams:oi}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){M.debug("run()"),this._direction=e,this._remoteSdp=new ic.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:at.getSendingRtpParameters("audio",c),video:at.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:at.getSendingRemoteRtpParameters("audio",c),video:at.getSendingRemoteRtpParameters("video",c)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(M.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){M.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(M.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});M.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};M.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};M.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();M.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){this.assertSendDirection(),M.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);const n=ai.clone(this._sendingRtpParametersByKind[e.kind]);n.codecs=at.reduceCodecs(n.codecs,i);const a=ai.clone(this._sendingRemoteRtpParametersByKind[e.kind]);a.codecs=at.reduceCodecs(a.codecs,i);const o=this._remoteSdp.getNextMediaSectionIdx(),d=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});let p=await this._pc.createOffer(),c=de.parse(p.sdp),u;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),t&&t.length>1&&(M.debug("send() | enabling legacy simulcast"),c=de.parse(p.sdp),u=c.media[o.idx],es.addLegacySimulcast({offerMediaObject:u,numStreams:t.length}),p={type:"offer",sdp:de.write(c)});let l=!1;const h=(0,nc.parse)((t||[{}])[0].scalabilityMode);if(t&&t.length===1&&h.spatialLayers>1&&n.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(M.debug("send() | enabling legacy simulcast for VP9 SVC"),l=!0,c=de.parse(p.sdp),u=c.media[o.idx],es.addLegacySimulcast({offerMediaObject:u,numStreams:h.spatialLayers}),p={type:"offer",sdp:de.write(c)}),M.debug("send() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),t){M.debug("send() | applying given encodings");const g=d.sender.getParameters();for(let v=0;v<(g.encodings||[]).length;++v){const N=g.encodings[v],S=t[v];if(!S)break;g.encodings[v]=Object.assign(N,S)}await d.sender.setParameters(g)}const f=d.mid;if(n.mid=f,c=de.parse(this._pc.localDescription.sdp),u=c.media[o.idx],n.rtcp.cname=ar.getCname({offerMediaObject:u}),n.encodings=es.getRtpEncodings({offerMediaObject:u}),t)for(let g=0;g<n.encodings.length;++g)t[g]&&Object.assign(n.encodings[g],t[g]);if(l&&(n.encodings=[n.encodings[0]]),n.encodings.length>1&&(n.codecs[0].mimeType.toLowerCase()==="video/vp8"||n.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const g of n.encodings)g.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:u,reuseMid:o.reuseMid,offerRtpParameters:n,answerRtpParameters:a,codecOptions:r});const m={type:"answer",sdp:this._remoteSdp.getSdp()};return M.debug("send() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._mapMidTransceiver.set(f,d),{localId:f,rtpParameters:n,rtpSender:d.sender}}async stopSending(e){this.assertSendDirection(),M.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const i=await this._pc.createOffer();M.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};M.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){this.assertSendDirection(),t?M.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):M.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertSendDirection(),M.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((o,d)=>{d<=t?o.active=!0:o.active=!1}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();M.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};M.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertSendDirection(),M.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((o,d)=>{i.encodings[d]={...o,...t}}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();M.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};M.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:r,protocol:n};M.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(i,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%oi.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=de.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),M.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};M.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertRecvDirection();const t=[],r=new Map;for(const o of e){const{trackId:d,kind:p,rtpParameters:c,streamId:u}=o;M.debug("receive() [trackId:%s, kind:%s]",d,p);const l=c.mid||String(this._mapMidTransceiver.size);r.set(d,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:c,streamId:u||c.rtcp.cname,trackId:d})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};M.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const a=de.parse(n.sdp);for(const o of e){const{trackId:d,rtpParameters:p}=o,c=r.get(d),u=a.media.find(l=>String(l.mid)===c);ar.applyCodecParameters({offerRtpParameters:p,answerMediaObject:u})}n={type:"answer",sdp:de.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),M.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{trackId:d}=o,p=r.get(d),c=this._pc.getTransceivers().find(u=>u.mid===p);if(!c)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(p,c),t.push({localId:p,track:c.receiver.track,rtpReceiver:c.receiver})}return t}async stopReceiving(e){this.assertRecvDirection();for(const i of e){M.debug("stopReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};M.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();M.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r);for(const i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:a,maxRetransmitTime:a,maxRetransmits:o,protocol:r};M.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};M.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=de.parse(u.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}M.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=de.parse(this._pc.localDescription.sdp));const r=ar.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Pr.Chrome70=vs;var Er={},Qe={};Object.defineProperty(Qe,"__esModule",{value:!0});Qe.getRtpEncodings=ac;Qe.addLegacySimulcast=oc;function ac({offerMediaObject:s,track:e}){const t=new Set;for(const n of s.ssrcs||[]){if(n.attribute!=="msid")continue;if(n.value.split(" ")[1]===e.id){const o=n.id;t.add(o)}}if(t.size===0)throw new Error(`a=ssrc line with msid information not found [track.id:${e.id}]`);const r=new Map;for(const n of s.ssrcGroups||[]){if(n.semantics!=="FID")continue;let[a,o]=n.ssrcs.split(/\s+/);a=Number(a),o=Number(o),t.has(a)&&(t.delete(a),t.delete(o),r.set(a,o))}for(const n of t)r.set(n,null);const i=[];for(const[n,a]of r){const o={ssrc:n};a&&(o.rtx={ssrc:a}),i.push(o)}return i}function oc({offerMediaObject:s,track:e,numStreams:t}){if(t<=1)throw new TypeError("numStreams must be greater than 1");let r,i,n;if(!(s.ssrcs||[]).find(u=>u.attribute!=="msid"?!1:u.value.split(" ")[1]===e.id?(r=u.id,n=u.value.split(" ")[0],!0):!1))throw new Error(`a=ssrc line with msid information not found [track.id:${e.id}]`);(s.ssrcGroups||[]).some(u=>{if(u.semantics!=="FID")return!1;const l=u.ssrcs.split(/\s+/);return Number(l[0])===r?(i=Number(l[1]),!0):!1});const o=s.ssrcs.find(u=>u.attribute==="cname"&&u.id===r);if(!o)throw new Error(`a=ssrc line with cname information not found [track.id:${e.id}]`);const d=o.value,p=[],c=[];for(let u=0;u<t;++u)p.push(r+u),i&&c.push(i+u);s.ssrcGroups=s.ssrcGroups||[],s.ssrcs=s.ssrcs||[],s.ssrcGroups.push({semantics:"SIM",ssrcs:p.join(" ")});for(let u=0;u<p.length;++u){const l=p[u];s.ssrcs.push({id:l,attribute:"cname",value:d}),s.ssrcs.push({id:l,attribute:"msid",value:`${n} ${e.id}`})}for(let u=0;u<c.length;++u){const l=p[u],h=c[u];s.ssrcs.push({id:h,attribute:"cname",value:d}),s.ssrcs.push({id:h,attribute:"msid",value:`${n} ${e.id}`}),s.ssrcGroups.push({semantics:"FID",ssrcs:`${l} ${h}`})}}var cc=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),dc=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Ht=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&cc(e,s,t);return dc(e,s),e};Object.defineProperty(Er,"__esModule",{value:!0});Er.Chrome67=void 0;const ve=Ht(Z),pc=G,ci=Ht(J),ot=Ht(H),or=Ht(ne),di=Ht(Qe),lc=ae,uc=oe,I=new pc.Logger("Chrome67"),pi={OS:1024,MIS:1024};class bs extends lc.HandlerInterface{static createFactory(){return()=>new bs}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdRtpSender=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Chrome67"}close(){if(I.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){I.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch{}const r=ve.parse(t.sdp);return or.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return I.debug("getNativeSctpCapabilities()"),{numStreams:pi}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){I.debug("run()"),this._direction=e,this._remoteSdp=new uc.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,planB:!0}),this._sendingRtpParametersByKind={audio:ot.getSendingRtpParameters("audio",c),video:ot.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:ot.getSendingRemoteRtpParameters("audio",c),video:ot.getSendingRemoteRtpParameters("video",c)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(I.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){I.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(I.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});I.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();I.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){this.assertSendDirection(),I.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),i&&I.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addTrack(e,this._sendStream);let n=await this._pc.createOffer(),a=ve.parse(n.sdp),o;const d=ci.clone(this._sendingRtpParametersByKind[e.kind]);d.codecs=ot.reduceCodecs(d.codecs);const p=ci.clone(this._sendingRemoteRtpParametersByKind[e.kind]);if(p.codecs=ot.reduceCodecs(p.codecs),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),e.kind==="video"&&t&&t.length>1&&(I.debug("send() | enabling simulcast"),a=ve.parse(n.sdp),o=a.media.find(h=>h.type==="video"),di.addLegacySimulcast({offerMediaObject:o,track:e,numStreams:t.length}),n={type:"offer",sdp:ve.write(a)}),I.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),a=ve.parse(this._pc.localDescription.sdp),o=a.media.find(h=>h.type===e.kind),d.rtcp.cname=or.getCname({offerMediaObject:o}),d.encodings=di.getRtpEncodings({offerMediaObject:o,track:e}),t)for(let h=0;h<d.encodings.length;++h)t[h]&&Object.assign(d.encodings[h],t[h]);if(d.encodings.length>1&&d.codecs[0].mimeType.toLowerCase()==="video/vp8")for(const h of d.encodings)h.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:o,offerRtpParameters:d,answerRtpParameters:p,codecOptions:r});const c={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("send() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setRemoteDescription(c);const u=String(this._nextSendLocalId);this._nextSendLocalId++;const l=this._pc.getSenders().find(h=>h.track===e);return this._mapSendLocalIdRtpSender.set(u,l),{localId:u,rtpParameters:d,rtpSender:l}}async stopSending(e){this.assertSendDirection(),I.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");this._pc.removeTrack(t),t.track&&this._sendStream.removeTrack(t.track),this._mapSendLocalIdRtpSender.delete(e);const r=await this._pc.createOffer();I.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r);try{await this._pc.setLocalDescription(r)}catch(n){if(this._sendStream.getTracks().length===0){I.warn("stopSending() | ignoring expected error due no sending tracks: %s",n.toString());return}throw n}if(this._pc.signalingState==="stable")return;const i={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){this.assertSendDirection(),t?I.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):I.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapSendLocalIdRtpSender.get(e);if(!r)throw new Error("associated RTCRtpSender not found");const i=r.track;await r.replaceTrack(t),i&&this._sendStream.removeTrack(i),t&&this._sendStream.addTrack(t)}async setMaxSpatialLayer(e,t){this.assertSendDirection(),I.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapSendLocalIdRtpSender.get(e);if(!r)throw new Error("associated RTCRtpSender not found");const i=r.getParameters();i.encodings.forEach((n,a)=>{a<=t?n.active=!0:n.active=!1}),await r.setParameters(i)}async setRtpEncodingParameters(e,t){this.assertSendDirection(),I.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapSendLocalIdRtpSender.get(e);if(!r)throw new Error("associated RTCRtpSender not found");const i=r.getParameters();i.encodings.forEach((n,a)=>{i.encodings[a]={...n,...t}}),await r.setParameters(i)}async getSenderStats(e){this.assertSendDirection();const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");return t.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:r,protocol:n};I.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(i,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%pi.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=ve.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),I.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertRecvDirection();const t=[];for(const a of e){const{trackId:o,kind:d,rtpParameters:p,streamId:c}=a;I.debug("receive() [trackId:%s, kind:%s]",o,d);const u=d;this._remoteSdp.receive({mid:u,kind:d,offerRtpParameters:p,streamId:c||p.rtcp.cname,trackId:o})}const r={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);let i=await this._pc.createAnswer();const n=ve.parse(i.sdp);for(const a of e){const{kind:o,rtpParameters:d}=a,p=o,c=n.media.find(u=>String(u.mid)===p);or.applyCodecParameters({offerRtpParameters:d,answerMediaObject:c})}i={type:"answer",sdp:ve.write(n)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:n}),I.debug("receive() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(const a of e){const{kind:o,trackId:d,rtpParameters:p}=a,c=d,u=o,l=this._pc.getReceivers().find(h=>h.track&&h.track.id===c);if(!l)throw new Error("new RTCRtpReceiver not");this._mapRecvLocalIdInfo.set(c,{mid:u,rtpParameters:p,rtpReceiver:l}),t.push({localId:c,track:l.track,rtpReceiver:l})}return t}async stopReceiving(e){this.assertRecvDirection();for(const i of e){I.debug("stopReceiving() [localId:%s]",i);const{mid:n,rtpParameters:a}=this._mapRecvLocalIdInfo.get(i)||{};this._mapRecvLocalIdInfo.delete(i),this._remoteSdp.planBStopReceiving({mid:n,offerRtpParameters:a})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();I.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){this.assertRecvDirection();const{rtpReceiver:t}=this._mapRecvLocalIdInfo.get(e)||{};if(!t)throw new Error("associated RTCRtpReceiver not found");return t.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:a,maxRetransmitTime:a,maxRetransmits:o,protocol:r};I.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const c={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=ve.parse(u.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}I.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ve.parse(this._pc.localDescription.sdp));const r=or.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Er.Chrome67=bs;var xr={},hc=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),fc=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Vt=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&hc(e,s,t);return fc(e,s),e};Object.defineProperty(xr,"__esModule",{value:!0});xr.Chrome55=void 0;const be=Vt(Z),mc=G,Mt=ee,li=Vt(J),ct=Vt(H),cr=Vt(ne),ui=Vt(Qe),gc=ae,_c=oe,$=new mc.Logger("Chrome55"),hi={OS:1024,MIS:1024};class Ss extends gc.HandlerInterface{static createFactory(){return()=>new Ss}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Chrome55"}close(){if($.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){$.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch{}const r=be.parse(t.sdp);return cr.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return $.debug("getNativeSctpCapabilities()"),{numStreams:hi}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){$.debug("run()"),this._direction=e,this._remoteSdp=new _c.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,planB:!0}),this._sendingRtpParametersByKind={audio:ct.getSendingRtpParameters("audio",c),video:ct.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:ct.getSendingRemoteRtpParameters("audio",c),video:ct.getSendingRemoteRtpParameters("video",c)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch($.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){$.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if($.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});$.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};$.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};$.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();$.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){this.assertSendDirection(),$.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),i&&$.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addStream(this._sendStream);let n=await this._pc.createOffer(),a=be.parse(n.sdp),o;const d=li.clone(this._sendingRtpParametersByKind[e.kind]);d.codecs=ct.reduceCodecs(d.codecs);const p=li.clone(this._sendingRemoteRtpParametersByKind[e.kind]);if(p.codecs=ct.reduceCodecs(p.codecs),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),e.kind==="video"&&t&&t.length>1&&($.debug("send() | enabling simulcast"),a=be.parse(n.sdp),o=a.media.find(l=>l.type==="video"),ui.addLegacySimulcast({offerMediaObject:o,track:e,numStreams:t.length}),n={type:"offer",sdp:be.write(a)}),$.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),a=be.parse(this._pc.localDescription.sdp),o=a.media.find(l=>l.type===e.kind),d.rtcp.cname=cr.getCname({offerMediaObject:o}),d.encodings=ui.getRtpEncodings({offerMediaObject:o,track:e}),t)for(let l=0;l<d.encodings.length;++l)t[l]&&Object.assign(d.encodings[l],t[l]);if(d.encodings.length>1&&d.codecs[0].mimeType.toLowerCase()==="video/vp8")for(const l of d.encodings)l.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:o,offerRtpParameters:d,answerRtpParameters:p,codecOptions:r});const c={type:"answer",sdp:this._remoteSdp.getSdp()};$.debug("send() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setRemoteDescription(c);const u=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(u,e),{localId:u,rtpParameters:d}}async stopSending(e){this.assertSendDirection(),$.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdTrack.get(e);if(!t)throw new Error("track not found");this._mapSendLocalIdTrack.delete(e),this._sendStream.removeTrack(t),this._pc.addStream(this._sendStream);const r=await this._pc.createOffer();$.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r);try{await this._pc.setLocalDescription(r)}catch(n){if(this._sendStream.getTracks().length===0){$.warn("stopSending() | ignoring expected error due no sending tracks: %s",n.toString());return}throw n}if(this._pc.signalingState==="stable")return;const i={type:"answer",sdp:this._remoteSdp.getSdp()};$.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){throw new Mt.UnsupportedError("not implemented")}async setMaxSpatialLayer(e,t){throw new Mt.UnsupportedError(" not implemented")}async setRtpEncodingParameters(e,t){throw new Mt.UnsupportedError("not supported")}async getSenderStats(e){throw new Mt.UnsupportedError("not implemented")}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:r,protocol:n};$.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(i,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%hi.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=be.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),$.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};$.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertRecvDirection();const t=[];for(const a of e){const{trackId:o,kind:d,rtpParameters:p,streamId:c}=a;$.debug("receive() [trackId:%s, kind:%s]",o,d);const u=d;this._remoteSdp.receive({mid:u,kind:d,offerRtpParameters:p,streamId:c||p.rtcp.cname,trackId:o})}const r={type:"offer",sdp:this._remoteSdp.getSdp()};$.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);let i=await this._pc.createAnswer();const n=be.parse(i.sdp);for(const a of e){const{kind:o,rtpParameters:d}=a,p=o,c=n.media.find(u=>String(u.mid)===p);cr.applyCodecParameters({offerRtpParameters:d,answerMediaObject:c})}i={type:"answer",sdp:be.write(n)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:n}),$.debug("receive() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(const a of e){const{kind:o,trackId:d,rtpParameters:p}=a,c=o,u=d,l=a.streamId||p.rtcp.cname,f=this._pc.getRemoteStreams().find(m=>m.id===l).getTrackById(u);if(!f)throw new Error("remote track not found");this._mapRecvLocalIdInfo.set(u,{mid:c,rtpParameters:p}),t.push({localId:u,track:f})}return t}async stopReceiving(e){this.assertRecvDirection();for(const i of e){$.debug("stopReceiving() [localId:%s]",i);const{mid:n,rtpParameters:a}=this._mapRecvLocalIdInfo.get(i)||{};this._mapRecvLocalIdInfo.delete(i),this._remoteSdp.planBStopReceiving({mid:n,offerRtpParameters:a})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};$.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();$.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){throw new Mt.UnsupportedError("not implemented")}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:a,maxRetransmitTime:a,maxRetransmits:o,protocol:r};$.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const c={type:"offer",sdp:this._remoteSdp.getSdp()};$.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=be.parse(u.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}$.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=be.parse(this._pc.localDescription.sdp));const r=cr.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}xr.Chrome55=Ss;var Lr={},wc=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),vc=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Kt=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&wc(e,s,t);return vc(e,s),e};Object.defineProperty(Lr,"__esModule",{value:!0});Lr.Firefox120=void 0;const $e=Kt(Z),bc=G,fi=ee,mi=Kt(J),dt=Kt(H),dr=Kt(ne),gi=Kt(De),Sc=ae,yc=oe,Rc=Pe,D=new bc.Logger("Firefox120"),_i={OS:16,MIS:2048};class ys extends Sc.HandlerInterface{static createFactory(){return()=>new ys}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Firefox120"}close(){if(D.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){D.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"}),t=document.createElement("canvas");t.getContext("2d");const i=t.captureStream().getVideoTracks()[0];try{e.addTransceiver("audio",{direction:"sendrecv"}),e.addTransceiver(i,{direction:"sendrecv",sendEncodings:[{rid:"r0",maxBitrate:1e5},{rid:"r1",maxBitrate:5e5}]});const n=await e.createOffer();try{t.remove()}catch{}try{i.stop()}catch{}try{e.close()}catch{}const a=$e.parse(n.sdp);return dr.extractRtpCapabilities({sdpObject:a})}catch(n){try{t.remove()}catch{}try{i.stop()}catch{}try{e.close()}catch{}throw n}}async getNativeSctpCapabilities(){return D.debug("getNativeSctpCapabilities()"),{numStreams:_i}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){this.assertNotClosed(),D.debug("run()"),this._direction=e,this._remoteSdp=new yc.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:dt.getSendingRtpParameters("audio",c),video:dt.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:dt.getSendingRemoteRtpParameters("audio",c),video:dt.getSendingRemoteRtpParameters("video",c)},this._pc=new RTCPeerConnection({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(D.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){throw this.assertNotClosed(),new fi.UnsupportedError("not supported")}async restartIce(e){if(this.assertNotClosed(),D.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});D.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();D.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i,onRtpSender:n}){this.assertNotClosed(),this.assertSendDirection(),D.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((m,g)=>{m.rid=`r${g}`});const a=mi.clone(this._sendingRtpParametersByKind[e.kind]);a.codecs=dt.reduceCodecs(a.codecs,i);const o=mi.clone(this._sendingRemoteRtpParametersByKind[e.kind]);o.codecs=dt.reduceCodecs(o.codecs,i);const d=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});n&&n(d.sender);const p=await this._pc.createOffer();let c=$e.parse(p.sdp);this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:c});const u=(0,Rc.parse)((t||[{}])[0].scalabilityMode);D.debug("send() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p);const l=d.mid;a.mid=l,c=$e.parse(this._pc.localDescription.sdp);const h=c.media[c.media.length-1];if(a.rtcp.cname=dr.getCname({offerMediaObject:h}),!t)a.encodings=gi.getRtpEncodings({offerMediaObject:h});else if(t.length===1){const m=gi.getRtpEncodings({offerMediaObject:h});Object.assign(m[0],t[0]),a.encodings=m}else a.encodings=t;if(a.encodings.length>1&&(a.codecs[0].mimeType.toLowerCase()==="video/vp8"||a.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const m of a.encodings)m.scalabilityMode?m.scalabilityMode=`L1T${u.temporalLayers}`:m.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:h,offerRtpParameters:a,answerRtpParameters:o,codecOptions:r,extmapAllowMixed:!0});const f={type:"answer",sdp:this._remoteSdp.getSdp()};return D.debug("send() | calling pc.setRemoteDescription() [answer:%o]",f),await this._pc.setRemoteDescription(f),this._mapMidTransceiver.set(l,d),{localId:l,rtpParameters:a,rtpSender:d.sender}}async stopSending(e){if(this.assertSendDirection(),D.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated transceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.disableMediaSection(t.mid);const r=await this._pc.createOffer();D.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),D.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const r=await this._pc.createOffer();D.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),D.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const r=await this._pc.createOffer();D.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?D.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):D.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),D.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated transceiver not found");const i=r.sender.getParameters();i.encodings.forEach((o,d)=>{d<=t?o.active=!0:o.active=!1}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();D.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),D.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((o,d)=>{i.encodings[d]={...o,...t}}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();D.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertNotClosed(),this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:n};D.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(i,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%_i.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=$e.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:c}),D.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],r=new Map;for(const o of e){const{trackId:d,kind:p,rtpParameters:c,streamId:u}=o;D.debug("receive() [trackId:%s, kind:%s]",d,p);const l=c.mid||String(this._mapMidTransceiver.size);r.set(d,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:c,streamId:u||c.rtcp.cname,trackId:d})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);for(const o of e){const{trackId:d,onRtpReceiver:p}=o;if(p){const c=r.get(d),u=this._pc.getTransceivers().find(l=>l.mid===c);if(!u)throw new Error("transceiver not found");p(u.receiver)}}let n=await this._pc.createAnswer();const a=$e.parse(n.sdp);for(const o of e){const{trackId:d,rtpParameters:p}=o,c=r.get(d),u=a.media.find(l=>String(l.mid)===c);dr.applyCodecParameters({offerRtpParameters:p,answerMediaObject:u}),n={type:"answer",sdp:$e.write(a)}}this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:a}),D.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{trackId:d}=o,p=r.get(d),c=this._pc.getTransceivers().find(u=>u.mid===p);if(!c)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(p,c),t.push({localId:p,track:c.receiver.track,rtpReceiver:c.receiver})}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const i of e){D.debug("stopReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();D.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r);for(const i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){D.debug("pauseReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();D.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){D.debug("resumeReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();D.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async getReceiverStats(e){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o,protocol:r};D.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=$e.parse(u.sdp);await this.setupTransport({localDtlsRole:"client",localSdpObject:l})}D.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=$e.parse(this._pc.localDescription.sdp));const r=dr.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new fi.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Lr.Firefox120=ys;var Mr={},Cc=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Tc=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Gt=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&Cc(e,s,t);return Tc(e,s),e};Object.defineProperty(Mr,"__esModule",{value:!0});Mr.Firefox60=void 0;const Ne=Gt(Z),Dc=G,wi=ee,ts=Gt(J),pt=Gt(H),pr=Gt(ne),vi=Gt(De),Pc=ae,Ec=oe,xc=Pe,P=new Dc.Logger("Firefox60"),bi={OS:16,MIS:2048};class Rs extends Pc.HandlerInterface{static createFactory(){return()=>new Rs}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Firefox60"}close(){if(P.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){P.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"}),t=document.createElement("canvas");t.getContext("2d");const i=t.captureStream().getVideoTracks()[0];try{e.addTransceiver("audio",{direction:"sendrecv"});const n=e.addTransceiver(i,{direction:"sendrecv"}),a=n.sender.getParameters(),o=[{rid:"r0",maxBitrate:1e5},{rid:"r1",maxBitrate:5e5}];a.encodings=o,await n.sender.setParameters(a);const d=await e.createOffer();try{t.remove()}catch{}try{i.stop()}catch{}try{e.close()}catch{}const p=Ne.parse(d.sdp);return pr.extractRtpCapabilities({sdpObject:p})}catch(n){try{t.remove()}catch{}try{i.stop()}catch{}try{e.close()}catch{}throw n}}async getNativeSctpCapabilities(){return P.debug("getNativeSctpCapabilities()"),{numStreams:bi}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){this.assertNotClosed(),P.debug("run()"),this._direction=e,this._remoteSdp=new Ec.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:pt.getSendingRtpParameters("audio",c),video:pt.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:pt.getSendingRemoteRtpParameters("audio",c),video:pt.getSendingRemoteRtpParameters("video",c)},this._pc=new RTCPeerConnection({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(P.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){throw this.assertNotClosed(),new wi.UnsupportedError("not supported")}async restartIce(e){if(this.assertNotClosed(),P.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});P.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();P.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){this.assertNotClosed(),this.assertSendDirection(),P.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&(t=ts.clone(t),t.length>1&&(t.forEach((f,m)=>{f.rid=`r${m}`}),t.reverse()));const n=ts.clone(this._sendingRtpParametersByKind[e.kind]);n.codecs=pt.reduceCodecs(n.codecs,i);const a=ts.clone(this._sendingRemoteRtpParametersByKind[e.kind]);a.codecs=pt.reduceCodecs(a.codecs,i);const o=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});if(t){const f=o.sender.getParameters();f.encodings=t,await o.sender.setParameters(f)}const d=await this._pc.createOffer();let p=Ne.parse(d.sdp);this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:p});const c=(0,xc.parse)((t||[{}])[0].scalabilityMode);P.debug("send() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d);const u=o.mid;n.mid=u,p=Ne.parse(this._pc.localDescription.sdp);const l=p.media[p.media.length-1];if(n.rtcp.cname=pr.getCname({offerMediaObject:l}),!t)n.encodings=vi.getRtpEncodings({offerMediaObject:l});else if(t.length===1){const f=vi.getRtpEncodings({offerMediaObject:l});Object.assign(f[0],t[0]),n.encodings=f}else n.encodings=t.reverse();if(n.encodings.length>1&&(n.codecs[0].mimeType.toLowerCase()==="video/vp8"||n.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const f of n.encodings)f.scalabilityMode?f.scalabilityMode=`L1T${c.temporalLayers}`:f.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:l,offerRtpParameters:n,answerRtpParameters:a,codecOptions:r,extmapAllowMixed:!0});const h={type:"answer",sdp:this._remoteSdp.getSdp()};return P.debug("send() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setRemoteDescription(h),this._mapMidTransceiver.set(u,o),{localId:u,rtpParameters:n,rtpSender:o.sender}}async stopSending(e){if(this.assertSendDirection(),P.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated transceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.disableMediaSection(t.mid);const r=await this._pc.createOffer();P.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),P.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const r=await this._pc.createOffer();P.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),P.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const r=await this._pc.createOffer();P.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?P.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):P.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),P.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated transceiver not found");const i=r.sender.getParameters();t=i.encodings.length-1-t,i.encodings.forEach((o,d)=>{d>=t?o.active=!0:o.active=!1}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();P.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),P.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((o,d)=>{i.encodings[d]={...o,...t}}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();P.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertNotClosed(),this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:n};P.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(i,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%bi.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=Ne.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:c}),P.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],r=new Map;for(const o of e){const{trackId:d,kind:p,rtpParameters:c,streamId:u}=o;P.debug("receive() [trackId:%s, kind:%s]",d,p);const l=c.mid||String(this._mapMidTransceiver.size);r.set(d,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:c,streamId:u||c.rtcp.cname,trackId:d})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const a=Ne.parse(n.sdp);for(const o of e){const{trackId:d,rtpParameters:p}=o,c=r.get(d),u=a.media.find(l=>String(l.mid)===c);pr.applyCodecParameters({offerRtpParameters:p,answerMediaObject:u}),n={type:"answer",sdp:Ne.write(a)}}this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:a}),P.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{trackId:d}=o,p=r.get(d),c=this._pc.getTransceivers().find(u=>u.mid===p);if(!c)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(p,c),t.push({localId:p,track:c.receiver.track,rtpReceiver:c.receiver})}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const i of e){P.debug("stopReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();P.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r);for(const i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){P.debug("pauseReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();P.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){P.debug("resumeReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();P.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async getReceiverStats(e){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o,protocol:r};P.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=Ne.parse(u.sdp);await this.setupTransport({localDtlsRole:"client",localSdpObject:l})}P.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Ne.parse(this._pc.localDescription.sdp));const r=pr.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new wi.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Mr.Firefox60=Rs;var Ir={},Lc=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Mc=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Ct=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&Lc(e,s,t);return Mc(e,s),e};Object.defineProperty(Ir,"__esModule",{value:!0});Ir.Safari12=void 0;const Se=Ct(Z),Ic=G,Si=Ct(J),lt=Ct(H),lr=Ct(ne),yi=Ct(De),kc=Ct(St),Oc=ee,jc=ae,$c=oe,Nc=Pe,C=new Ic.Logger("Safari12"),Ri={OS:1024,MIS:1024};class Cs extends jc.HandlerInterface{static createFactory(){return()=>new Cs}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Safari12"}close(){if(C.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){C.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const r=Se.parse(t.sdp),i=lr.extractRtpCapabilities({sdpObject:r});return kc.addNackSuppportForOpus(i),i}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return C.debug("getNativeSctpCapabilities()"),{numStreams:Ri}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){this.assertNotClosed(),C.debug("run()"),this._direction=e,this._remoteSdp=new $c.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:lt.getSendingRtpParameters("audio",c),video:lt.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:lt.getSendingRemoteRtpParameters("audio",c),video:lt.getSendingRemoteRtpParameters("video",c)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(C.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){this.assertNotClosed(),C.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),C.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});C.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};C.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();C.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i,onRtpSender:n}){this.assertNotClosed(),this.assertSendDirection(),C.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);const a=Si.clone(this._sendingRtpParametersByKind[e.kind]);a.codecs=lt.reduceCodecs(a.codecs,i);const o=Si.clone(this._sendingRemoteRtpParametersByKind[e.kind]);o.codecs=lt.reduceCodecs(o.codecs,i);const d=this._remoteSdp.getNextMediaSectionIdx(),p=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});n&&n(p.sender);let c=await this._pc.createOffer(),u=Se.parse(c.sdp),l;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:u});const h=(0,Nc.parse)((t||[{}])[0].scalabilityMode);t&&t.length>1&&(C.debug("send() | enabling legacy simulcast"),u=Se.parse(c.sdp),l=u.media[d.idx],yi.addLegacySimulcast({offerMediaObject:l,numStreams:t.length}),c={type:"offer",sdp:Se.write(u)}),C.debug("send() | calling pc.setLocalDescription() [offer:%o]",c),await this._pc.setLocalDescription(c);const f=p.mid;if(a.mid=f,u=Se.parse(this._pc.localDescription.sdp),l=u.media[d.idx],a.rtcp.cname=lr.getCname({offerMediaObject:l}),a.encodings=yi.getRtpEncodings({offerMediaObject:l}),t)for(let g=0;g<a.encodings.length;++g)t[g]&&Object.assign(a.encodings[g],t[g]);if(a.encodings.length>1&&(a.codecs[0].mimeType.toLowerCase()==="video/vp8"||a.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const g of a.encodings)g.scalabilityMode?g.scalabilityMode=`L1T${h.temporalLayers}`:g.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:l,reuseMid:d.reuseMid,offerRtpParameters:a,answerRtpParameters:o,codecOptions:r});const m={type:"answer",sdp:this._remoteSdp.getSdp()};return C.debug("send() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._mapMidTransceiver.set(f,p),{localId:f,rtpParameters:a,rtpSender:p.sender}}async stopSending(e){if(this.assertSendDirection(),this._closed)return;C.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const i=await this._pc.createOffer();C.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),C.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const r=await this._pc.createOffer();C.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),C.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const r=await this._pc.createOffer();C.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?C.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):C.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),C.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((o,d)=>{d<=t?o.active=!0:o.active=!1}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();C.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),C.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((o,d)=>{i.encodings[d]={...o,...t}}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();C.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertNotClosed(),this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:n};C.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(i,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Ri.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=Se.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),C.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],r=new Map;for(const o of e){const{trackId:d,kind:p,rtpParameters:c,streamId:u}=o;C.debug("receive() [trackId:%s, kind:%s]",d,p);const l=c.mid||String(this._mapMidTransceiver.size);r.set(d,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:c,streamId:u||c.rtcp.cname,trackId:d})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};C.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);for(const o of e){const{trackId:d,onRtpReceiver:p}=o;if(p){const c=r.get(d),u=this._pc.getTransceivers().find(l=>l.mid===c);if(!u)throw new Error("transceiver not found");p(u.receiver)}}let n=await this._pc.createAnswer();const a=Se.parse(n.sdp);for(const o of e){const{trackId:d,rtpParameters:p}=o,c=r.get(d),u=a.media.find(l=>String(l.mid)===c);lr.applyCodecParameters({offerRtpParameters:p,answerMediaObject:u})}n={type:"answer",sdp:Se.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),C.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{trackId:d}=o,p=r.get(d),c=this._pc.getTransceivers().find(u=>u.mid===p);if(!c)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(p,c),t.push({localId:p,track:c.receiver.track,rtpReceiver:c.receiver})}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const i of e){C.debug("stopReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};C.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();C.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r);for(const i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){C.debug("pauseReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};C.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();C.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){C.debug("resumeReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};C.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();C.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o,protocol:r};C.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};C.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=Se.parse(u.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}C.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Se.parse(this._pc.localDescription.sdp));const r=lr.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new Oc.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Ir.Safari12=Cs;var kr={},Ac=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Fc=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Wt=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&Ac(e,s,t);return Fc(e,s),e};Object.defineProperty(kr,"__esModule",{value:!0});kr.Safari11=void 0;const ye=Wt(Z),Bc=G,Ci=Wt(J),ut=Wt(H),ur=Wt(ne),Ti=Wt(Qe),Uc=ae,zc=oe,O=new Bc.Logger("Safari11"),Di={OS:1024,MIS:1024};class Ts extends Uc.HandlerInterface{static createFactory(){return()=>new Ts}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdRtpSender=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Safari11"}close(){if(O.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){O.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch{}const r=ye.parse(t.sdp);return ur.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return O.debug("getNativeSctpCapabilities()"),{numStreams:Di}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){O.debug("run()"),this._direction=e,this._remoteSdp=new zc.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,planB:!0}),this._sendingRtpParametersByKind={audio:ut.getSendingRtpParameters("audio",c),video:ut.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:ut.getSendingRemoteRtpParameters("audio",c),video:ut.getSendingRemoteRtpParameters("video",c)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(O.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){O.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(O.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});O.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};O.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};O.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();O.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){this.assertSendDirection(),O.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),i&&O.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addTrack(e,this._sendStream);let n=await this._pc.createOffer(),a=ye.parse(n.sdp),o;const d=Ci.clone(this._sendingRtpParametersByKind[e.kind]);d.codecs=ut.reduceCodecs(d.codecs);const p=Ci.clone(this._sendingRemoteRtpParametersByKind[e.kind]);if(p.codecs=ut.reduceCodecs(p.codecs),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),e.kind==="video"&&t&&t.length>1&&(O.debug("send() | enabling simulcast"),a=ye.parse(n.sdp),o=a.media.find(h=>h.type==="video"),Ti.addLegacySimulcast({offerMediaObject:o,track:e,numStreams:t.length}),n={type:"offer",sdp:ye.write(a)}),O.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),a=ye.parse(this._pc.localDescription.sdp),o=a.media.find(h=>h.type===e.kind),d.rtcp.cname=ur.getCname({offerMediaObject:o}),d.encodings=Ti.getRtpEncodings({offerMediaObject:o,track:e}),t)for(let h=0;h<d.encodings.length;++h)t[h]&&Object.assign(d.encodings[h],t[h]);if(d.encodings.length>1&&d.codecs[0].mimeType.toLowerCase()==="video/vp8")for(const h of d.encodings)h.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:o,offerRtpParameters:d,answerRtpParameters:p,codecOptions:r});const c={type:"answer",sdp:this._remoteSdp.getSdp()};O.debug("send() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setRemoteDescription(c);const u=String(this._nextSendLocalId);this._nextSendLocalId++;const l=this._pc.getSenders().find(h=>h.track===e);return this._mapSendLocalIdRtpSender.set(u,l),{localId:u,rtpParameters:d,rtpSender:l}}async stopSending(e){this.assertSendDirection();const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");t.track&&this._sendStream.removeTrack(t.track),this._mapSendLocalIdRtpSender.delete(e);const r=await this._pc.createOffer();O.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r);try{await this._pc.setLocalDescription(r)}catch(n){if(this._sendStream.getTracks().length===0){O.warn("stopSending() | ignoring expected error due no sending tracks: %s",n.toString());return}throw n}if(this._pc.signalingState==="stable")return;const i={type:"answer",sdp:this._remoteSdp.getSdp()};O.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){this.assertSendDirection(),t?O.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):O.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapSendLocalIdRtpSender.get(e);if(!r)throw new Error("associated RTCRtpSender not found");const i=r.track;await r.replaceTrack(t),i&&this._sendStream.removeTrack(i),t&&this._sendStream.addTrack(t)}async setMaxSpatialLayer(e,t){this.assertSendDirection(),O.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapSendLocalIdRtpSender.get(e);if(!r)throw new Error("associated RTCRtpSender not found");const i=r.getParameters();i.encodings.forEach((n,a)=>{a<=t?n.active=!0:n.active=!1}),await r.setParameters(i)}async setRtpEncodingParameters(e,t){this.assertSendDirection(),O.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapSendLocalIdRtpSender.get(e);if(!r)throw new Error("associated RTCRtpSender not found");const i=r.getParameters();i.encodings.forEach((n,a)=>{i.encodings[a]={...n,...t}}),await r.setParameters(i)}async getSenderStats(e){this.assertSendDirection();const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");return t.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:n};O.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(i,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Di.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=ye.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),O.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};O.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertRecvDirection();const t=[];for(const a of e){const{trackId:o,kind:d,rtpParameters:p,streamId:c}=a;O.debug("receive() [trackId:%s, kind:%s]",o,d);const u=d;this._remoteSdp.receive({mid:u,kind:d,offerRtpParameters:p,streamId:c||p.rtcp.cname,trackId:o})}const r={type:"offer",sdp:this._remoteSdp.getSdp()};O.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);let i=await this._pc.createAnswer();const n=ye.parse(i.sdp);for(const a of e){const{kind:o,rtpParameters:d}=a,p=o,c=n.media.find(u=>String(u.mid)===p);ur.applyCodecParameters({offerRtpParameters:d,answerMediaObject:c})}i={type:"answer",sdp:ye.write(n)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:n}),O.debug("receive() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(const a of e){const{kind:o,trackId:d,rtpParameters:p}=a,c=o,u=d,l=this._pc.getReceivers().find(h=>h.track&&h.track.id===u);if(!l)throw new Error("new RTCRtpReceiver not");this._mapRecvLocalIdInfo.set(u,{mid:c,rtpParameters:p,rtpReceiver:l}),t.push({localId:u,track:l.track,rtpReceiver:l})}return t}async stopReceiving(e){this.assertRecvDirection();for(const i of e){O.debug("stopReceiving() [localId:%s]",i);const{mid:n,rtpParameters:a}=this._mapRecvLocalIdInfo.get(i)||{};this._mapRecvLocalIdInfo.delete(i),this._remoteSdp.planBStopReceiving({mid:n,offerRtpParameters:a})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};O.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();O.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async getReceiverStats(e){this.assertRecvDirection();const{rtpReceiver:t}=this._mapRecvLocalIdInfo.get(e)||{};if(!t)throw new Error("associated RTCRtpReceiver not found");return t.getStats()}async pauseReceiving(e){}async resumeReceiving(e){}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o,protocol:r};O.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const c={type:"offer",sdp:this._remoteSdp.getSdp()};O.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=ye.parse(u.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}O.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ye.parse(this._pc.localDescription.sdp));const r=ur.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}kr.Safari11=Ts;var Or={},jr={},qc=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Hc=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Vc=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&qc(e,s,t);return Hc(e,s),e};Object.defineProperty(jr,"__esModule",{value:!0});jr.getCapabilities=Kc;jr.mangleRtpParameters=Gc;const rn=Vc(J);function Kc(){const s=RTCRtpReceiver.getCapabilities(),e=rn.clone(s);for(const t of e.codecs??[]){if(t.channels=t.numChannels,delete t.numChannels,t.mimeType=t.mimeType||`${t.kind}/${t.name}`,t.parameters){const r=t.parameters;r.apt&&(r.apt=Number(r.apt)),r["packetization-mode"]&&(r["packetization-mode"]=Number(r["packetization-mode"]))}for(const r of t.rtcpFeedback||[])r.parameter||(r.parameter="")}return e}function Gc(s){const e=rn.clone(s);e.mid&&(e.muxId=e.mid,delete e.mid);for(const t of e.codecs)t.channels&&(t.numChannels=t.channels,delete t.channels),t.mimeType&&!t.name&&(t.name=t.mimeType.split("/")[1]),delete t.mimeType;return e}var Wc=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Qc=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Ds=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&Wc(e,s,t);return Qc(e,s),e};Object.defineProperty(Or,"__esModule",{value:!0});Or.Edge11=void 0;const Zc=G,rs=ee,hr=Ds(J),ss=Ds(H),is=Ds(jr),Jc=ae,F=new Zc.Logger("Edge11");class Ps extends Jc.HandlerInterface{static createFactory(){return()=>new Ps}constructor(){super(),this._rtpSenders=new Map,this._rtpReceivers=new Map,this._nextSendLocalId=0,this._transportReady=!1}get name(){return"Edge11"}close(){F.debug("close()");try{this._iceGatherer.close()}catch{}try{this._iceTransport.stop()}catch{}try{this._dtlsTransport.stop()}catch{}for(const e of this._rtpSenders.values())try{e.stop()}catch{}for(const e of this._rtpReceivers.values())try{e.stop()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){return F.debug("getNativeRtpCapabilities()"),is.getCapabilities()}async getNativeSctpCapabilities(){return F.debug("getNativeSctpCapabilities()"),{numStreams:{OS:0,MIS:0}}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){F.debug("run()"),this._sendingRtpParametersByKind={audio:ss.getSendingRtpParameters("audio",c),video:ss.getSendingRtpParameters("video",c)},this._remoteIceParameters=t,this._remoteIceCandidates=r,this._remoteDtlsParameters=i,this._cname=`CNAME-${hr.generateRandomNumber()}`,this.setIceGatherer({iceServers:a,iceTransportPolicy:o}),this.setIceTransport(),this.setDtlsTransport()}async updateIceServers(e){throw new rs.UnsupportedError("not supported")}async restartIce(e){if(F.debug("restartIce()"),this._remoteIceParameters=e,!!this._transportReady){F.debug("restartIce() | calling iceTransport.start()"),this._iceTransport.start(this._iceGatherer,e,"controlling");for(const t of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(t);this._iceTransport.addRemoteCandidate({})}}async getTransportStats(){return this._iceTransport.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){F.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),this._transportReady||await this.setupTransport({localDtlsRole:"server"}),F.debug("send() | calling new RTCRtpSender()");const n=new RTCRtpSender(e,this._dtlsTransport),a=hr.clone(this._sendingRtpParametersByKind[e.kind]);a.codecs=ss.reduceCodecs(a.codecs,i);const o=a.codecs.some(c=>/.+\/rtx$/i.test(c.mimeType));t||(t=[{}]);for(const c of t)c.ssrc=hr.generateRandomNumber(),o&&(c.rtx={ssrc:hr.generateRandomNumber()});a.encodings=t,a.rtcp={cname:this._cname,reducedSize:!0,mux:!0};const d=is.mangleRtpParameters(a);F.debug("send() | calling rtpSender.send() [params:%o]",d),await n.send(d);const p=String(this._nextSendLocalId);return this._nextSendLocalId++,this._rtpSenders.set(p,n),{localId:p,rtpParameters:a,rtpSender:n}}async stopSending(e){F.debug("stopSending() [localId:%s]",e);const t=this._rtpSenders.get(e);if(!t)throw new Error("RTCRtpSender not found");this._rtpSenders.delete(e);try{F.debug("stopSending() | calling rtpSender.stop()"),t.stop()}catch(r){throw F.warn("stopSending() | rtpSender.stop() failed:%o",r),r}}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){t?F.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):F.debug("replaceTrack() [localId:%s, no track]",e);const r=this._rtpSenders.get(e);if(!r)throw new Error("RTCRtpSender not found");r.setTrack(t)}async setMaxSpatialLayer(e,t){F.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._rtpSenders.get(e);if(!r)throw new Error("RTCRtpSender not found");const i=r.getParameters();i.encodings.forEach((n,a)=>{a<=t?n.active=!0:n.active=!1}),await r.setParameters(i)}async setRtpEncodingParameters(e,t){F.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._rtpSenders.get(e);if(!r)throw new Error("RTCRtpSender not found");const i=r.getParameters();i.encodings.forEach((n,a)=>{i.encodings[a]={...n,...t}}),await r.setParameters(i)}async getSenderStats(e){const t=this._rtpSenders.get(e);if(!t)throw new Error("RTCRtpSender not found");return t.getStats()}async sendDataChannel(e){throw new rs.UnsupportedError("not implemented")}async receive(e){const t=[];for(const r of e){const{trackId:i,kind:n}=r;F.debug("receive() [trackId:%s, kind:%s]",i,n)}this._transportReady||await this.setupTransport({localDtlsRole:"server"});for(const r of e){const{trackId:i,kind:n,rtpParameters:a}=r;F.debug("receive() | calling new RTCRtpReceiver()");const o=new RTCRtpReceiver(this._dtlsTransport,n);o.addEventListener("error",c=>{F.error('rtpReceiver "error" event [event:%o]',c)});const d=is.mangleRtpParameters(a);F.debug("receive() | calling rtpReceiver.receive() [params:%o]",d),await o.receive(d);const p=i;this._rtpReceivers.set(p,o),t.push({localId:p,track:o.track,rtpReceiver:o})}return t}async stopReceiving(e){for(const t of e){F.debug("stopReceiving() [localId:%s]",t);const r=this._rtpReceivers.get(t);if(!r)throw new Error("RTCRtpReceiver not found");this._rtpReceivers.delete(t);try{F.debug("stopReceiving() | calling rtpReceiver.stop()"),r.stop()}catch(i){F.warn("stopReceiving() | rtpReceiver.stop() failed:%o",i)}}}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){const t=this._rtpReceivers.get(e);if(!t)throw new Error("RTCRtpReceiver not found");return t.getStats()}async receiveDataChannel(e){throw new rs.UnsupportedError("not implemented")}setIceGatherer({iceServers:e,iceTransportPolicy:t}){const r=new RTCIceGatherer({iceServers:e||[],gatherPolicy:t||"all"});r.addEventListener("error",i=>{F.error('iceGatherer "error" event [event:%o]',i)});try{r.gather()}catch(i){F.debug("setIceGatherer() | iceGatherer.gather() failed: %s",i.toString())}this._iceGatherer=r}setIceTransport(){const e=new RTCIceTransport(this._iceGatherer);e.addEventListener("statechange",()=>{switch(e.state){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}),e.addEventListener("icestatechange",()=>{switch(e.state){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}),e.addEventListener("candidatepairchange",t=>{F.debug('iceTransport "candidatepairchange" event [pair:%o]',t.pair)}),this._iceTransport=e}setDtlsTransport(){const e=new RTCDtlsTransport(this._iceTransport);e.addEventListener("statechange",()=>{F.debug('dtlsTransport "statechange" event [state:%s]',e.state)}),e.addEventListener("dtlsstatechange",()=>{F.debug('dtlsTransport "dtlsstatechange" event [state:%s]',e.state),e.state==="closed"&&this.emit("@connectionstatechange","closed")}),e.addEventListener("error",t=>{F.error('dtlsTransport "error" event [event:%o]',t)}),this._dtlsTransport=e}async setupTransport({localDtlsRole:e}){F.debug("setupTransport()");const t=this._dtlsTransport.getLocalParameters();t.role=e,await new Promise((r,i)=>{this.safeEmit("@connect",{dtlsParameters:t},r,i)}),this._iceTransport.start(this._iceGatherer,this._remoteIceParameters,"controlling");for(const r of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(r);this._iceTransport.addRemoteCandidate({}),this._remoteDtlsParameters.fingerprints=this._remoteDtlsParameters.fingerprints.filter(r=>r.algorithm==="sha-256"||r.algorithm==="sha-384"||r.algorithm==="sha-512"),this._dtlsTransport.start(this._remoteDtlsParameters),this._transportReady=!0}}Or.Edge11=Ps;var $r={},Yc=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Xc=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Tt=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&Yc(e,s,t);return Xc(e,s),e};Object.defineProperty($r,"__esModule",{value:!0});$r.ReactNativeUnifiedPlan=void 0;const Re=Tt(Z),ed=G,Pi=Tt(J),ht=Tt(H),fr=Tt(ne),ns=Tt(De),td=Tt(St),rd=ee,sd=ae,id=oe,nd=Pe,y=new ed.Logger("ReactNativeUnifiedPlan"),Ei={OS:1024,MIS:1024};class Es extends sd.HandlerInterface{static createFactory(){return()=>new Es}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"ReactNativeUnifiedPlan"}close(){if(y.debug("close()"),!this._closed){if(this._closed=!0,this._sendStream.release(!1),this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){y.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const r=Re.parse(t.sdp),i=fr.extractRtpCapabilities({sdpObject:r});return td.addNackSuppportForOpus(i),i}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return y.debug("getNativeSctpCapabilities()"),{numStreams:Ei}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){this.assertNotClosed(),y.debug("run()"),this._direction=e,this._remoteSdp=new id.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:ht.getSendingRtpParameters("audio",c),video:ht.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:ht.getSendingRemoteRtpParameters("audio",c),video:ht.getSendingRemoteRtpParameters("video",c)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(y.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){this.assertNotClosed(),y.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),y.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});y.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();y.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i,onRtpSender:n}){this.assertNotClosed(),this.assertSendDirection(),y.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((v,N)=>{v.rid=`r${N}`});const a=Pi.clone(this._sendingRtpParametersByKind[e.kind]);a.codecs=ht.reduceCodecs(a.codecs,i);const o=Pi.clone(this._sendingRemoteRtpParametersByKind[e.kind]);o.codecs=ht.reduceCodecs(o.codecs,i);const d=this._remoteSdp.getNextMediaSectionIdx(),p=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});n&&n(p.sender);let c=await this._pc.createOffer(),u=Re.parse(c.sdp),l;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:u});let h=!1;const f=(0,nd.parse)((t||[{}])[0].scalabilityMode);t&&t.length===1&&f.spatialLayers>1&&a.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(y.debug("send() | enabling legacy simulcast for VP9 SVC"),h=!0,u=Re.parse(c.sdp),l=u.media[d.idx],ns.addLegacySimulcast({offerMediaObject:l,numStreams:f.spatialLayers}),c={type:"offer",sdp:Re.write(u)}),y.debug("send() | calling pc.setLocalDescription() [offer:%o]",c),await this._pc.setLocalDescription(c);let m=p.mid??void 0;if(m||y.warn("send() | missing transceiver.mid (bug in react-native-webrtc, using a workaround"),a.mid=m,u=Re.parse(this._pc.localDescription.sdp),l=u.media[d.idx],a.rtcp.cname=fr.getCname({offerMediaObject:l}),!t)a.encodings=ns.getRtpEncodings({offerMediaObject:l});else if(t.length===1){let v=ns.getRtpEncodings({offerMediaObject:l});Object.assign(v[0],t[0]),h&&(v=[v[0]]),a.encodings=v}else a.encodings=t;if(a.encodings.length>1&&(a.codecs[0].mimeType.toLowerCase()==="video/vp8"||a.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const v of a.encodings)v.scalabilityMode?v.scalabilityMode=`L1T${f.temporalLayers}`:v.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:l,reuseMid:d.reuseMid,offerRtpParameters:a,answerRtpParameters:o,codecOptions:r,extmapAllowMixed:!0});const g={type:"answer",sdp:this._remoteSdp.getSdp()};return y.debug("send() | calling pc.setRemoteDescription() [answer:%o]",g),await this._pc.setRemoteDescription(g),m||(m=p.mid,a.mid=m),this._mapMidTransceiver.set(m,p),{localId:m,rtpParameters:a,rtpSender:p.sender}}async stopSending(e){if(this.assertSendDirection(),this._closed)return;y.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const i=await this._pc.createOffer();y.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),y.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const r=await this._pc.createOffer();y.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),y.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const r=await this._pc.createOffer();y.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?y.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):y.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),y.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((o,d)=>{d<=t?o.active=!0:o.active=!1}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();y.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),y.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((o,d)=>{i.encodings[d]={...o,...t}}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();y.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertNotClosed(),this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:n};y.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(i,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Ei.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=Re.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),y.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],r=new Map;for(const o of e){const{trackId:d,kind:p,rtpParameters:c,streamId:u}=o;y.debug("receive() [trackId:%s, kind:%s]",d,p);const l=c.mid||String(this._mapMidTransceiver.size);r.set(d,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:c,streamId:u||c.rtcp.cname,trackId:d})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);for(const o of e){const{trackId:d,onRtpReceiver:p}=o;if(p){const c=r.get(d),u=this._pc.getTransceivers().find(l=>l.mid===c);if(!u)throw new Error("transceiver not found");p(u.receiver)}}let n=await this._pc.createAnswer();const a=Re.parse(n.sdp);for(const o of e){const{trackId:d,rtpParameters:p}=o,c=r.get(d),u=a.media.find(l=>String(l.mid)===c);fr.applyCodecParameters({offerRtpParameters:p,answerMediaObject:u})}n={type:"answer",sdp:Re.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),y.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{trackId:d}=o,p=r.get(d),c=this._pc.getTransceivers().find(u=>u.mid===p);if(c)this._mapMidTransceiver.set(p,c),t.push({localId:p,track:c.receiver.track,rtpReceiver:c.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const i of e){y.debug("stopReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();y.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r);for(const i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){y.debug("pauseReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();y.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){y.debug("resumeReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();y.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o,protocol:r};y.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=Re.parse(u.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}y.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Re.parse(this._pc.localDescription.sdp));const r=fr.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new rd.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}$r.ReactNativeUnifiedPlan=Es;var Nr={},ad=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),od=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Qt=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&ad(e,s,t);return od(e,s),e};Object.defineProperty(Nr,"__esModule",{value:!0});Nr.ReactNative=void 0;const Ce=Qt(Z),cd=G,It=ee,as=Qt(J),ft=Qt(H),mr=Qt(ne),xi=Qt(Qe),dd=ae,pd=oe,j=new cd.Logger("ReactNative"),Li={OS:1024,MIS:1024};class xs extends dd.HandlerInterface{static createFactory(){return()=>new xs}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"ReactNative"}close(){if(j.debug("close()"),this._sendStream.release(!1),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){j.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch{}const r=Ce.parse(t.sdp);return mr.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return j.debug("getNativeSctpCapabilities()"),{numStreams:Li}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:c}){j.debug("run()"),this._direction=e,this._remoteSdp=new pd.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,planB:!0}),this._sendingRtpParametersByKind={audio:ft.getSendingRtpParameters("audio",c),video:ft.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:ft.getSendingRemoteRtpParameters("audio",c),video:ft.getSendingRemoteRtpParameters("video",c)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b",...d},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(j.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){j.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(j.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});j.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();j.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){this.assertSendDirection(),j.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),i&&j.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addStream(this._sendStream);let n=await this._pc.createOffer(),a=Ce.parse(n.sdp),o;const d=as.clone(this._sendingRtpParametersByKind[e.kind]);d.codecs=ft.reduceCodecs(d.codecs);const p=as.clone(this._sendingRemoteRtpParametersByKind[e.kind]);if(p.codecs=ft.reduceCodecs(p.codecs),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),e.kind==="video"&&t&&t.length>1&&(j.debug("send() | enabling simulcast"),a=Ce.parse(n.sdp),o=a.media.find(l=>l.type==="video"),xi.addLegacySimulcast({offerMediaObject:o,track:e,numStreams:t.length}),n={type:"offer",sdp:Ce.write(a)}),j.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),a=Ce.parse(this._pc.localDescription.sdp),o=a.media.find(l=>l.type===e.kind),d.rtcp.cname=mr.getCname({offerMediaObject:o}),d.encodings=xi.getRtpEncodings({offerMediaObject:o,track:e}),t)for(let l=0;l<d.encodings.length;++l)t[l]&&Object.assign(d.encodings[l],t[l]);if(d.encodings.length>1&&(d.codecs[0].mimeType.toLowerCase()==="video/vp8"||d.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const l of d.encodings)l.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:o,offerRtpParameters:d,answerRtpParameters:p,codecOptions:r});const c={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("send() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setRemoteDescription(c);const u=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(u,e),{localId:u,rtpParameters:d}}async stopSending(e){this.assertSendDirection(),j.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdTrack.get(e);if(!t)throw new Error("track not found");this._mapSendLocalIdTrack.delete(e),this._sendStream.removeTrack(t),this._pc.addStream(this._sendStream);const r=await this._pc.createOffer();j.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r);try{await this._pc.setLocalDescription(r)}catch(n){if(this._sendStream.getTracks().length===0){j.warn("stopSending() | ignoring expected error due no sending tracks: %s",n.toString());return}throw n}if(this._pc.signalingState==="stable")return;const i={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){throw new It.UnsupportedError("not implemented")}async setMaxSpatialLayer(e,t){throw new It.UnsupportedError("not implemented")}async setRtpEncodingParameters(e,t){throw new It.UnsupportedError("not implemented")}async getSenderStats(e){throw new It.UnsupportedError("not implemented")}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:r,protocol:n};j.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(i,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Li.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),c=Ce.parse(p.sdp),u=c.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),j.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:u});const l={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertRecvDirection();const t=[],r=new Map;for(const o of e){const{trackId:d,kind:p,rtpParameters:c}=o;j.debug("receive() [trackId:%s, kind:%s]",d,p);const u=p;let l=o.streamId||c.rtcp.cname;j.debug("receive() | forcing a random remote streamId to avoid well known bug in react-native-webrtc"),l+=`-hack-${as.generateRandomNumber()}`,r.set(d,l),this._remoteSdp.receive({mid:u,kind:p,offerRtpParameters:c,streamId:l,trackId:d})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const a=Ce.parse(n.sdp);for(const o of e){const{kind:d,rtpParameters:p}=o,c=d,u=a.media.find(l=>String(l.mid)===c);mr.applyCodecParameters({offerRtpParameters:p,answerMediaObject:u})}n={type:"answer",sdp:Ce.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),j.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{kind:d,trackId:p,rtpParameters:c}=o,u=p,l=d,h=r.get(p),m=this._pc.getRemoteStreams().find(g=>g.id===h).getTrackById(u);if(!m)throw new Error("remote track not found");this._mapRecvLocalIdInfo.set(u,{mid:l,rtpParameters:c}),t.push({localId:u,track:m})}return t}async stopReceiving(e){this.assertRecvDirection();for(const i of e){j.debug("stopReceiving() [localId:%s]",i);const{mid:n,rtpParameters:a}=this._mapRecvLocalIdInfo.get(i)||{};this._mapRecvLocalIdInfo.delete(i),this._remoteSdp.planBStopReceiving({mid:n,offerRtpParameters:a})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();j.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){throw new It.UnsupportedError("not implemented")}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:a,maxRetransmitTime:a,maxRetransmits:o,protocol:r};j.debug("receiveDataChannel() [options:%o]",d);const p=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const c={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const u=await this._pc.createAnswer();if(!this._transportReady){const l=Ce.parse(u.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}j.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Ce.parse(this._pc.localDescription.sdp));const r=mr.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Nr.ReactNative=xs;var ld=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),ud=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),sn=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&ld(e,s,t);return ud(e,s),e};Object.defineProperty(bt,"__esModule",{value:!0});bt.Device=void 0;bt.detectDevice=nn;const hd=$n,fd=G,md=Te,mt=ee,Mi=sn(J),Ae=sn(H),gd=At,_d=Tr,wd=Dr,vd=Pr,bd=Er,Sd=xr,yd=Lr,Rd=Mr,Cd=Ir,Td=kr,Dd=Or,Pd=$r,Ed=Nr,re=new fd.Logger("Device");function nn(){var s,e,t,r;if(typeof navigator=="object"&&navigator.product==="ReactNative"){if(re.debug("detectDevice() | React-Native detected"),typeof RTCPeerConnection>"u"){re.warn("detectDevice() | unsupported react-native-webrtc without RTCPeerConnection, forgot to call registerGlobals()?");return}return typeof RTCRtpTransceiver<"u"?(re.debug("detectDevice() | ReactNative UnifiedPlan handler chosen"),"ReactNativeUnifiedPlan"):(re.debug("detectDevice() | ReactNative PlanB handler chosen"),"ReactNative")}else if(typeof navigator=="object"&&typeof navigator.userAgent=="string"){const i=navigator.userAgent,n=new hd.UAParser(i);re.debug("detectDevice() | browser detected [ua:%s, parsed:%o]",i,n.getResult());const a=n.getBrowser(),o=(s=a.name)==null?void 0:s.toLowerCase(),d=parseInt(a.major??"0"),c=(e=n.getEngine().name)==null?void 0:e.toLowerCase(),u=n.getOS(),l=(t=u.name)==null?void 0:t.toLowerCase(),h=parseFloat(u.version??"0"),m=(r=n.getDevice().model)==null?void 0:r.toLowerCase(),g=l==="ios"||m==="ipad",v=o&&["chrome","chromium","mobile chrome","chrome webview","chrome headless"].includes(o),N=o&&["firefox","mobile firefox","mobile focus"].includes(o),S=o&&["safari","mobile safari"].includes(o),b=o&&["edge"].includes(o);if((v||b)&&!g&&d>=111)return"Chrome111";if(v&&!g&&d>=74||b&&!g&&d>=88)return"Chrome74";if(v&&!g&&d>=70)return"Chrome70";if(v&&!g&&d>=67)return"Chrome67";if(v&&!g&&d>=55)return"Chrome55";if(N&&!g&&d>=120)return"Firefox120";if(N&&!g&&d>=60)return"Firefox60";if(N&&g&&h>=14.3)return"Safari12";if(S&&d>=12&&typeof RTCRtpTransceiver<"u"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(S&&d>=11)return"Safari11";if(b&&!g&&d>=11&&d<=18)return"Edge11";if(c==="webkit"&&g&&typeof RTCRtpTransceiver<"u"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(c==="blink"){const W=i.match(/(?:(?:Chrome|Chromium))[ /](\w+)/i);if(W){const Y=Number(W[1]);return Y>=111?"Chrome111":Y>=74?"Chrome74":Y>=70?"Chrome70":Y>=67?"Chrome67":"Chrome55"}else return"Chrome111"}else{re.warn("detectDevice() | browser not supported [name:%s, version:%s]",o,d);return}}else{re.warn("detectDevice() | unknown device");return}}class xd{constructor({handlerName:e,handlerFactory:t,Handler:r}={}){if(this._loaded=!1,this._observer=new md.EnhancedEventEmitter,re.debug("constructor()"),r)if(re.warn("constructor() | Handler option is DEPRECATED, use handlerName or handlerFactory instead"),typeof r=="string")e=r;else throw new TypeError("non string Handler option no longer supported, use handlerFactory instead");if(e&&t)throw new TypeError("just one of handlerName or handlerInterface can be given");if(t)this._handlerFactory=t;else{if(e)re.debug("constructor() | handler given: %s",e);else if(e=nn(),e)re.debug("constructor() | detected handler: %s",e);else throw new mt.UnsupportedError("device not supported");switch(e){case"Chrome111":{this._handlerFactory=_d.Chrome111.createFactory();break}case"Chrome74":{this._handlerFactory=wd.Chrome74.createFactory();break}case"Chrome70":{this._handlerFactory=vd.Chrome70.createFactory();break}case"Chrome67":{this._handlerFactory=bd.Chrome67.createFactory();break}case"Chrome55":{this._handlerFactory=Sd.Chrome55.createFactory();break}case"Firefox120":{this._handlerFactory=yd.Firefox120.createFactory();break}case"Firefox60":{this._handlerFactory=Rd.Firefox60.createFactory();break}case"Safari12":{this._handlerFactory=Cd.Safari12.createFactory();break}case"Safari11":{this._handlerFactory=Td.Safari11.createFactory();break}case"Edge11":{this._handlerFactory=Dd.Edge11.createFactory();break}case"ReactNativeUnifiedPlan":{this._handlerFactory=Pd.ReactNativeUnifiedPlan.createFactory();break}case"ReactNative":{this._handlerFactory=Ed.ReactNative.createFactory();break}default:throw new TypeError(`unknown handlerName "${e}"`)}}const i=this._handlerFactory();this._handlerName=i.name,i.close(),this._extendedRtpCapabilities=void 0,this._recvRtpCapabilities=void 0,this._canProduceByKind={audio:!1,video:!1},this._sctpCapabilities=void 0}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new mt.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new mt.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}async load({routerRtpCapabilities:e}){re.debug("load() [routerRtpCapabilities:%o]",e);let t;try{if(this._loaded)throw new mt.InvalidStateError("already loaded");const r=Mi.clone(e);Ae.validateRtpCapabilities(r),t=this._handlerFactory();const i=await t.getNativeRtpCapabilities();re.debug("load() | got native RTP capabilities:%o",i);const n=Mi.clone(i);Ae.validateRtpCapabilities(n),this._extendedRtpCapabilities=Ae.getExtendedRtpCapabilities(n,r),re.debug("load() | got extended RTP capabilities:%o",this._extendedRtpCapabilities),this._canProduceByKind.audio=Ae.canSend("audio",this._extendedRtpCapabilities),this._canProduceByKind.video=Ae.canSend("video",this._extendedRtpCapabilities),this._recvRtpCapabilities=Ae.getRecvRtpCapabilities(this._extendedRtpCapabilities),Ae.validateRtpCapabilities(this._recvRtpCapabilities),re.debug("load() | got receiving RTP capabilities:%o",this._recvRtpCapabilities),this._sctpCapabilities=await t.getNativeSctpCapabilities(),re.debug("load() | got native SCTP capabilities:%o",this._sctpCapabilities),Ae.validateSctpCapabilities(this._sctpCapabilities),re.debug("load() succeeded"),this._loaded=!0,t.close()}catch(r){throw t&&t.close(),r}}canProduce(e){if(this._loaded){if(e!=="audio"&&e!=="video")throw new TypeError(`invalid kind "${e}"`)}else throw new mt.InvalidStateError("not loaded");return this._canProduceByKind[e]}createSendTransport({id:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,appData:c}){return re.debug("createSendTransport()"),this.createTransport({direction:"send",id:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,appData:c})}createRecvTransport({id:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,appData:c}){return re.debug("createRecvTransport()"),this.createTransport({direction:"recv",id:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,appData:c})}createTransport({direction:e,id:t,iceParameters:r,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:c,appData:u}){if(this._loaded){if(typeof t!="string")throw new TypeError("missing id");if(typeof r!="object")throw new TypeError("missing iceParameters");if(Array.isArray(i)){if(typeof n!="object")throw new TypeError("missing dtlsParameters");if(a&&typeof a!="object")throw new TypeError("wrong sctpParameters");if(u&&typeof u!="object")throw new TypeError("if given, appData must be an object")}else throw new TypeError("missing iceCandidates")}else throw new mt.InvalidStateError("not loaded");const l=new gd.Transport({direction:e,id:t,iceParameters:r,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:c,appData:u,handlerFactory:this._handlerFactory,extendedRtpCapabilities:this._extendedRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",l),l}}bt.Device=xd;var an={},on={};Object.defineProperty(on,"__esModule",{value:!0});var cn={};Object.defineProperty(cn,"__esModule",{value:!0});(function(s){var e=_&&_.__createBinding||(Object.create?function(r,i,n,a){a===void 0&&(a=n);var o=Object.getOwnPropertyDescriptor(i,n);(!o||("get"in o?!i.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return i[n]}}),Object.defineProperty(r,a,o)}:function(r,i,n,a){a===void 0&&(a=n),r[a]=i[n]}),t=_&&_.__exportStar||function(r,i){for(var n in r)n!=="default"&&!Object.prototype.hasOwnProperty.call(i,n)&&e(i,r,n)};Object.defineProperty(s,"__esModule",{value:!0}),t(bt,s),t(At,s),t(Ft,s),t(Bt,s),t(Ut,s),t(zt,s),t(on,s),t(cn,s),t(ae,s),t(ee,s)})(an);(function(s){var e=_&&_.__createBinding||(Object.create?function(p,c,u,l){l===void 0&&(l=u);var h=Object.getOwnPropertyDescriptor(c,u);(!h||("get"in h?!c.__esModule:h.writable||h.configurable))&&(h={enumerable:!0,get:function(){return c[u]}}),Object.defineProperty(p,l,h)}:function(p,c,u,l){l===void 0&&(l=u),p[l]=c[u]}),t=_&&_.__setModuleDefault||(Object.create?function(p,c){Object.defineProperty(p,"default",{enumerable:!0,value:c})}:function(p,c){p.default=c}),r=_&&_.__importStar||function(p){if(p&&p.__esModule)return p;var c={};if(p!=null)for(var u in p)u!=="default"&&Object.prototype.hasOwnProperty.call(p,u)&&e(c,p,u);return t(c,p),c},i=_&&_.__importDefault||function(p){return p&&p.__esModule?p:{default:p}};Object.defineProperty(s,"__esModule",{value:!0}),s.debug=s.parseScalabilityMode=s.detectDevice=s.Device=s.version=s.types=void 0;const n=i(Nt);s.debug=n.default;const a=bt;Object.defineProperty(s,"Device",{enumerable:!0,get:function(){return a.Device}}),Object.defineProperty(s,"detectDevice",{enumerable:!0,get:function(){return a.detectDevice}});const o=r(an);s.types=o,s.version="3.7.12";var d=Pe;Object.defineProperty(s,"parseScalabilityMode",{enumerable:!0,get:function(){return d.parse}})})(ji);const gt=Nt,_t="protoo-client";let Ld=class{constructor(e){e?(this._debug=gt(`${_t}:${e}`),this._warn=gt(`${_t}:WARN:${e}`),this._error=gt(`${_t}:ERROR:${e}`)):(this._debug=gt(_t),this._warn=gt(`${_t}:WARN`),this._error=gt(`${_t}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};var Ar=Ld,Ls={exports:{}},vt=typeof Reflect=="object"?Reflect:null,Ii=vt&&typeof vt.apply=="function"?vt.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)},wr;vt&&typeof vt.ownKeys=="function"?wr=vt.ownKeys:Object.getOwnPropertySymbols?wr=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:wr=function(e){return Object.getOwnPropertyNames(e)};function Md(s){console&&console.warn&&console.warn(s)}var dn=Number.isNaN||function(e){return e!==e};function z(){z.init.call(this)}Ls.exports=z;Ls.exports.once=jd;z.EventEmitter=z;z.prototype._events=void 0;z.prototype._eventsCount=0;z.prototype._maxListeners=void 0;var ki=10;function Fr(s){if(typeof s!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof s)}Object.defineProperty(z,"defaultMaxListeners",{enumerable:!0,get:function(){return ki},set:function(s){if(typeof s!="number"||s<0||dn(s))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+s+".");ki=s}});z.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};z.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||dn(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function pn(s){return s._maxListeners===void 0?z.defaultMaxListeners:s._maxListeners}z.prototype.getMaxListeners=function(){return pn(this)};z.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var i=e==="error",n=this._events;if(n!==void 0)i=i&&n.error===void 0;else if(!i)return!1;if(i){var a;if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var d=n[e];if(d===void 0)return!1;if(typeof d=="function")Ii(d,this,t);else for(var p=d.length,c=mn(d,p),r=0;r<p;++r)Ii(c[r],this,t);return!0};function ln(s,e,t,r){var i,n,a;if(Fr(t),n=s._events,n===void 0?(n=s._events=Object.create(null),s._eventsCount=0):(n.newListener!==void 0&&(s.emit("newListener",e,t.listener?t.listener:t),n=s._events),a=n[e]),a===void 0)a=n[e]=t,++s._eventsCount;else if(typeof a=="function"?a=n[e]=r?[t,a]:[a,t]:r?a.unshift(t):a.push(t),i=pn(s),i>0&&a.length>i&&!a.warned){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=s,o.type=e,o.count=a.length,Md(o)}return s}z.prototype.addListener=function(e,t){return ln(this,e,t,!1)};z.prototype.on=z.prototype.addListener;z.prototype.prependListener=function(e,t){return ln(this,e,t,!0)};function Id(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function un(s,e,t){var r={fired:!1,wrapFn:void 0,target:s,type:e,listener:t},i=Id.bind(r);return i.listener=t,r.wrapFn=i,i}z.prototype.once=function(e,t){return Fr(t),this.on(e,un(this,e,t)),this};z.prototype.prependOnceListener=function(e,t){return Fr(t),this.prependListener(e,un(this,e,t)),this};z.prototype.removeListener=function(e,t){var r,i,n,a,o;if(Fr(t),i=this._events,i===void 0)return this;if(r=i[e],r===void 0)return this;if(r===t||r.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,r.listener||t));else if(typeof r!="function"){for(n=-1,a=r.length-1;a>=0;a--)if(r[a]===t||r[a].listener===t){o=r[a].listener,n=a;break}if(n<0)return this;n===0?r.shift():kd(r,n),r.length===1&&(i[e]=r[0]),i.removeListener!==void 0&&this.emit("removeListener",e,o||t)}return this};z.prototype.off=z.prototype.removeListener;z.prototype.removeAllListeners=function(e){var t,r,i;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete r[e]),this;if(arguments.length===0){var n=Object.keys(r),a;for(i=0;i<n.length;++i)a=n[i],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=r[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this};function hn(s,e,t){var r=s._events;if(r===void 0)return[];var i=r[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?Od(i):mn(i,i.length)}z.prototype.listeners=function(e){return hn(this,e,!0)};z.prototype.rawListeners=function(e){return hn(this,e,!1)};z.listenerCount=function(s,e){return typeof s.listenerCount=="function"?s.listenerCount(e):fn.call(s,e)};z.prototype.listenerCount=fn;function fn(s){var e=this._events;if(e!==void 0){var t=e[s];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}z.prototype.eventNames=function(){return this._eventsCount>0?wr(this._events):[]};function mn(s,e){for(var t=new Array(e),r=0;r<e;++r)t[r]=s[r];return t}function kd(s,e){for(;e+1<s.length;e++)s[e]=s[e+1];s.pop()}function Od(s){for(var e=new Array(s.length),t=0;t<e.length;++t)e[t]=s[t].listener||s[t];return e}function jd(s,e){return new Promise(function(t,r){function i(a){s.removeListener(e,n),r(a)}function n(){typeof s.removeListener=="function"&&s.removeListener("error",i),t([].slice.call(arguments))}gn(s,e,n,{once:!0}),e!=="error"&&$d(s,i,{once:!0})})}function $d(s,e,t){typeof s.on=="function"&&gn(s,"error",e,t)}function gn(s,e,t,r){if(typeof s.on=="function")r.once?s.once(e,t):s.on(e,t);else if(typeof s.addEventListener=="function")s.addEventListener(e,function i(n){r.once&&s.removeEventListener(e,i),t(n)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof s)}var Nd=Ls.exports;const{EventEmitter:Ad}=Nd,Fd=Ar;let Bd=class extends Ad{constructor(e){super(),this.setMaxListeners(1/0),this._logger=e||new Fd("EnhancedEventEmitter")}safeEmit(e,...t){try{this.emit(e,...t)}catch(r){this._logger.error("safeEmit() | event listener threw an error [event:%s]:%o",e,r)}}async safeEmitAsPromise(e,...t){return new Promise((r,i)=>{this.safeEmit(e,...t,r,i)})}};var _n=Bd,wn={};wn.generateRandomNumber=function(){return Math.round(Math.random()*1e7)};const Ud=Ar,{generateRandomNumber:zd}=wn,Ke=new Ud("Message");let qd=class{static parse(e){let t;const r={};try{t=JSON.parse(e)}catch(i){Ke.error("parse() | invalid JSON: %s",i);return}if(typeof t!="object"||Array.isArray(t)){Ke.error("parse() | not an object");return}if(t.request){if(r.request=!0,typeof t.method!="string"){Ke.error("parse() | missing/invalid method field");return}if(typeof t.id!="number"){Ke.error("parse() | missing/invalid id field");return}r.id=t.id,r.method=t.method,r.data=t.data||{}}else if(t.response){if(r.response=!0,typeof t.id!="number"){Ke.error("parse() | missing/invalid id field");return}r.id=t.id,t.ok?(r.ok=!0,r.data=t.data||{}):(r.ok=!1,r.errorCode=t.errorCode,r.errorReason=t.errorReason)}else if(t.notification){if(r.notification=!0,typeof t.method!="string"){Ke.error("parse() | missing/invalid method field");return}r.method=t.method,r.data=t.data||{}}else{Ke.error("parse() | missing request/response field");return}return r}static createRequest(e,t){return{request:!0,id:zd(),method:e,data:t||{}}}static createSuccessResponse(e,t){return{response:!0,id:e.id,ok:!0,data:t||{}}}static createErrorResponse(e,t,r){return{response:!0,id:e.id,ok:!1,errorCode:t,errorReason:r}}static createNotification(e,t){return{notification:!0,method:e,data:t||{}}}};var vn=qd;const Hd=Ar,Vd=_n,kt=vn,Fe=new Hd("Peer");let Kd=class extends Vd{constructor(e){super(Fe),Fe.debug("constructor()"),this._closed=!1,this._transport=e,this._connected=!1,this._data={},this._sents=new Map,this._handleTransport()}get closed(){return this._closed}get connected(){return this._connected}get data(){return this._data}set data(e){throw new Error("cannot override data object")}close(){if(!this._closed){Fe.debug("close()"),this._closed=!0,this._connected=!1,this._transport.close();for(const e of this._sents.values())e.close();this.safeEmit("close")}}async request(e,t=void 0){const r=kt.createRequest(e,t);return this._logger.debug("request() [method:%s, id:%s]",e,r.id),await this._transport.send(r),new Promise((i,n)=>{const a=1500*(15+.1*this._sents.size),o={id:r.id,method:r.method,resolve:d=>{this._sents.delete(r.id)&&(clearTimeout(o.timer),i(d))},reject:d=>{this._sents.delete(r.id)&&(clearTimeout(o.timer),n(d))},timer:setTimeout(()=>{this._sents.delete(r.id)&&n(new Error("request timeout"))},a),close:()=>{clearTimeout(o.timer),n(new Error("peer closed"))}};this._sents.set(r.id,o)})}async notify(e,t=void 0){const r=kt.createNotification(e,t);this._logger.debug("notify() [method:%s]",e),await this._transport.send(r)}_handleTransport(){if(this._transport.closed){this._closed=!0,setTimeout(()=>{this._closed||(this._connected=!1,this.safeEmit("close"))});return}this._transport.on("open",()=>{this._closed||(Fe.debug('emit "open"'),this._connected=!0,this.safeEmit("open"))}),this._transport.on("disconnected",()=>{this._closed||(Fe.debug('emit "disconnected"'),this._connected=!1,this.safeEmit("disconnected"))}),this._transport.on("failed",e=>{this._closed||(Fe.debug('emit "failed" [currentAttempt:%s]',e),this._connected=!1,this.safeEmit("failed",e))}),this._transport.on("close",()=>{this._closed||(this._closed=!0,Fe.debug('emit "close"'),this._connected=!1,this.safeEmit("close"))}),this._transport.on("message",e=>{e.request?this._handleRequest(e):e.response?this._handleResponse(e):e.notification&&this._handleNotification(e)})}_handleRequest(e){try{this.emit("request",e,t=>{const r=kt.createSuccessResponse(e,t);this._transport.send(r).catch(()=>{})},(t,r)=>{t instanceof Error?(r=t.message,t=500):typeof t=="number"&&r instanceof Error&&(r=r.message);const i=kt.createErrorResponse(e,t,r);this._transport.send(i).catch(()=>{})})}catch(t){const r=kt.createErrorResponse(e,500,String(t));this._transport.send(r).catch(()=>{})}}_handleResponse(e){const t=this._sents.get(e.id);if(!t){Fe.error("received response does not match any sent request [id:%s]",e.id);return}if(e.ok)t.resolve(e.data);else{const r=new Error(e.errorReason);r.code=e.errorCode,t.reject(r)}}_handleNotification(e){this.safeEmit("notification",e)}};var Gd=Kd,os,Oi;function Wd(){if(Oi)return os;Oi=1;var s=function(){if(typeof self=="object"&&self)return self;if(typeof window=="object"&&window)return window;throw new Error("Unable to resolve global `this`")};return os=function(){if(this)return this;if(typeof globalThis=="object"&&globalThis)return globalThis;try{Object.defineProperty(Object.prototype,"__global__",{get:function(){return this},configurable:!0})}catch{return s()}try{return __global__||s()}finally{delete Object.prototype.__global__}}(),os}const Qd="websocket",Zd="Websocket Client & Server Library implementing the WebSocket protocol as specified in RFC 6455.",Jd=["websocket","websockets","socket","networking","comet","push","RFC-6455","realtime","server","client"],Yd="Brian McKelvey <theturtle32@gmail.com> (https://github.com/theturtle32)",Xd=["IÃ±aki Baz Castillo <ibc@aliax.net> (http://dev.sipdoc.net)"],ep="1.0.35",tp={type:"git",url:"https://github.com/theturtle32/WebSocket-Node.git"},rp="https://github.com/theturtle32/WebSocket-Node",sp={node:">=4.0.0"},ip={bufferutil:"^4.0.1",debug:"^2.2.0","es5-ext":"^0.10.63","typedarray-to-buffer":"^3.1.5","utf-8-validate":"^5.0.2",yaeti:"^0.0.6"},np={"buffer-equal":"^1.0.0",gulp:"^4.0.2","gulp-jshint":"^2.0.4","jshint-stylish":"^2.2.1",jshint:"^2.0.0",tape:"^4.9.1"},ap={verbose:!1},op={test:"tape test/unit/*.js",gulp:"gulp"},cp="index",dp={lib:"./lib"},pp="lib/browser.js",lp="Apache-2.0",up={name:Qd,description:Zd,keywords:Jd,author:Yd,contributors:Xd,version:ep,repository:tp,homepage:rp,engines:sp,dependencies:ip,devDependencies:np,config:ap,scripts:op,main:cp,directories:dp,browser:pp,license:lp};var hp=up.version,Ge;if(typeof globalThis=="object")Ge=globalThis;else try{Ge=Wd()}catch{}finally{if(!Ge&&typeof window<"u"&&(Ge=window),!Ge)throw new Error("Could not determine global this")}var $t=Ge.WebSocket||Ge.MozWebSocket,fp=hp;function bn(s,e){var t;return e?t=new $t(s,e):t=new $t(s),t}$t&&["CONNECTING","OPEN","CLOSING","CLOSED"].forEach(function(s){Object.defineProperty(bn,s,{get:function(){return $t[s]}})});var mp={w3cwebsocket:$t?bn:null,version:fp},Sn={};function pe(s,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(s)),this._timeouts=s,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var gp=pe;pe.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts};pe.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timeouts=[],this._cachedTimeouts=null};pe.prototype.retry=function(s){if(this._timeout&&clearTimeout(this._timeout),!s)return!1;var e=new Date().getTime();if(s&&e-this._operationStart>=this._maxRetryTime)return this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(s);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(this._errors.length-1,this._errors.length),this._timeouts=this._cachedTimeouts.slice(0),t=this._timeouts.shift();else return!1;var r=this,i=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t);return this._options.unref&&i.unref(),!0};pe.prototype.attempt=function(s,e){this._fn=s,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};pe.prototype.try=function(s){console.log("Using RetryOperation.try() is deprecated"),this.attempt(s)};pe.prototype.start=function(s){console.log("Using RetryOperation.start() is deprecated"),this.attempt(s)};pe.prototype.start=pe.prototype.try;pe.prototype.errors=function(){return this._errors};pe.prototype.attempts=function(){return this._attempts};pe.prototype.mainError=function(){if(this._errors.length===0)return null;for(var s={},e=null,t=0,r=0;r<this._errors.length;r++){var i=this._errors[r],n=i.message,a=(s[n]||0)+1;s[n]=a,a>=t&&(e=i,t=a)}return e};(function(s){var e=gp;s.operation=function(t){var r=s.timeouts(t);return new e(r,{forever:t&&t.forever,unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},s.timeouts=function(t){if(t instanceof Array)return[].concat(t);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var i in t)r[i]=t[i];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var n=[],a=0;a<r.retries;a++)n.push(this.createTimeout(a,r));return t&&t.forever&&!n.length&&n.push(this.createTimeout(a,r)),n.sort(function(o,d){return o-d}),n},s.createTimeout=function(t,r){var i=r.randomize?Math.random()+1:1,n=Math.round(i*r.minTimeout*Math.pow(r.factor,t));return n=Math.min(n,r.maxTimeout),n},s.wrap=function(t,r,i){if(r instanceof Array&&(i=r,r=null),!i){i=[];for(var n in t)typeof t[n]=="function"&&i.push(n)}for(var a=0;a<i.length;a++){var o=i[a],d=t[o];t[o]=(function(c){var u=s.operation(r),l=Array.prototype.slice.call(arguments,1),h=l.pop();l.push(function(f){u.retry(f)||(f&&(arguments[0]=u.mainError()),h.apply(this,arguments))}),u.attempt(function(){c.apply(t,l)})}).bind(t,d),t[o].options=r}}})(Sn);var _p=Sn;const wp=mp.w3cwebsocket,vp=_p,bp=Ar,Sp=_n,yp=vn,Rp="protoo",Cp={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:8*1e3},Ie=new bp("WebSocketTransport");let Tp=class extends Sp{constructor(e,t){super(Ie),Ie.debug("constructor() [url:%s, options:%o]",e,t),this._closed=!1,this._url=e,this._options=t||{},this._ws=null,this._runWebSocket()}get closed(){return this._closed}close(){if(!this._closed){Ie.debug("close()"),this._closed=!0,this.safeEmit("close");try{this._ws.onopen=null,this._ws.onclose=null,this._ws.onerror=null,this._ws.onmessage=null,this._ws.close()}catch(e){Ie.error("close() | error closing the WebSocket: %o",e)}}}async send(e){if(this._closed)throw new Error("transport closed");try{this._ws.send(JSON.stringify(e))}catch(t){throw Ie.warn("send() failed:%o",t),t}}_runWebSocket(){const e=vp.operation(this._options.retry||Cp);let t=!1;e.attempt(r=>{if(this._closed){e.stop();return}Ie.debug("_runWebSocket() [currentAttempt:%s]",r),this._ws=new wp(this._url,Rp,this._options.origin,this._options.headers,this._options.requestOptions,this._options.clientConfig),this._ws.onopen=()=>{this._closed||(t=!0,this.safeEmit("open"))},this._ws.onclose=i=>{if(!this._closed){if(Ie.warn('WebSocket "close" event [wasClean:%s, code:%s, reason:"%s"]',i.wasClean,i.code,i.reason),i.code!==4e3){if(t){if(e.stop(),this.safeEmit("disconnected"),this._closed)return;this._runWebSocket();return}else if(this.safeEmit("failed",r),this._closed||e.retry(!0))return}this._closed=!0,this.safeEmit("close")}},this._ws.onerror=()=>{this._closed||Ie.error('WebSocket "error" event')},this._ws.onmessage=i=>{if(this._closed)return;const n=yp.parse(i.data);if(n){if(this.listenerCount("message")===0){Ie.error('no listeners for WebSocket "message" event, ignoring received message');return}this.safeEmit("message",n)}}})}};var Dp=Tp;const Pp=Gd,Ep=Dp;var xp=Pp,Lp=Ep;class Mp{constructor(e){He(this,"endpoint");He(this,"client",null);He(this,"device");He(this,"onJoin",null);He(this,"onLeave",null);He(this,"peers",[]);this.endpoint=e,this.device=new ji.Device}async connect(e){const t=new Lp(this.endpoint),r=new xp(t);this.client=r,this.client.on("open",async()=>{const i=await r.request("getRtpCapabilities");await this.device.load({routerRtpCapabilities:i});const n=await r.request("createProducerTransport",{rtpCapabilities:i}),a=this.device.createSendTransport(n);a.on("connect",async({dtlsParameters:d},p,c)=>{try{await r.request("connectProducerTransport",{dtlsParameters:d}),p()}catch(u){c(u)}}),a.on("produce",async({kind:d,rtpParameters:p},c,u)=>{try{const{id:l}=await r.request("produce",{id:a.id,kind:d,rtpParameters:p});c({id:l})}catch(l){u(l)}}),await a.produce({track:e.stream.getVideoTracks()[0]}),await a.produce({track:e.stream.getAudioTracks()[0]});const o=await r.request("getPeers");for(const d of o)await this.admit(d);await r.request("notifyJoin")}),this.client.on("request",async(i,n)=>{var a;switch(i.method){case"newPeer":return await this.admit(i.data),n();case"disconnectPeer":{const o=i.data.peerId,d=this.peers.find(p=>p.id===o);if(d){for(const p of d.stream.getTracks())p.stop();this.peers=this.peers.filter(p=>p.id!==o)}return await((a=this.onLeave)==null?void 0:a.call(this,o)),n()}}})}async disconnect(){this.client&&await this.client.request("disconnect")}async admit(e){var d;const t=this.client;if(!t)return;const r=await t.request("createConsumerTransport"),i=this.device.createRecvTransport(r);i.on("connect",async({dtlsParameters:p},c,u)=>{try{await t.request("connectConsumerTransport",{transportId:i.id,dtlsParameters:p}),c()}catch(l){u(l)}});const n=await t.request("consume",{peerId:e,rtpCapabilities:this.device.rtpCapabilities}),a=new MediaStream;for(const p of n){const c=await i.consume({id:p.id,producerId:p.producerId,rtpParameters:p.rtpParameters,kind:p.kind});a.addTrack(c.track)}const o={id:e,stream:a};this.peers.push(o),await((d=this.onJoin)==null?void 0:d.call(this,o)),await t.request("resumeConsume")}on(e,t){switch(e){case"join":this.onJoin=t;break;case"leave":this.onLeave=t;break}}}const Ip=1e4,yn=K.createContext({call:()=>{},peerStream:null,selfStream:null,setShyMode:s=>{},shyMode:!0,status:"idle",requestCamera:()=>{},peer:null,end:()=>{},muted:!1,setMuted:s=>{}});function kp({children:s}){const{user:e}=ls("root")||{},[t,r]=K.useState(null),[i,n]=K.useState(null),[a,o]=K.useState(!0),[d,p]=K.useState(!1),[c,u]=K.useState("idle"),[l,h]=K.useState(null),f=K.useRef(null),m=K.useCallback(()=>{u("idle"),h(null),n(null)},[]),g=K.useCallback(()=>{navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(b=>r(b)).catch(console.error)},[]),v=K.useCallback(async()=>{var ce;if(!(e&&t))return;u("connecting"),(ce=f.current)==null||ce.disconnect();const b=await fetch("/parlon/call"),{roomId:W}=await b.json(),le=["ws://localhost:3003","join",W,(a?"shy:":"")+e.username].join("/"),se=new Mp(le);se.on("join",ie=>{u("connected"),h({id:ie.id}),n(ie.stream)}),se.on("leave",()=>{var ie;m(),(ie=f.current)==null||ie.disconnect(),f.current=null}),await se.connect({stream:t}),f.current=se;const he=setTimeout(()=>{se.peers.length||(m(),f.current=null,se.disconnect())},Ip);return()=>clearTimeout(he)},[e,t,a,m]),N=K.useCallback(()=>{var b;(b=f.current)==null||b.disconnect(),m()},[m]);K.useEffect(()=>{for(const b of(t==null?void 0:t.getAudioTracks())||[])b.enabled=!d},[d,t]);const S={call:v,peer:l,peerStream:i,requestCamera:g,selfStream:t,setShyMode:o,shyMode:a,status:c,end:N,muted:d,setMuted:p};return w.jsx(yn.Provider,{value:S,children:s})}function Br(){return K.useContext(yn)}function Op(s){const[e,t]=K.useState(s),r=K.useRef(null),i=K.useCallback(()=>{t(s),r.current=setInterval(()=>{t(a=>a-1)},1e3)},[s]),n=K.useCallback(()=>{clearInterval(r.current)},[]);return K.useEffect(()=>{e===0&&n()},[e,n]),{time:e,start:i,stop:n}}function jp(){const{peerStream:s,peer:e,status:t,call:r,end:i}=Br(),n=K.useRef(null),a=K.useRef(null),{time:o,start:d,stop:p}=Op(10),[c,u]=K.useMemo(()=>e?e.id.startsWith("shy:")?[!0,e.id.slice(4)]:[!1,e.id]:[!1,null],[e]);return K.useEffect(()=>{var f;if(!n.current||!s)return;(f=a.current)==null||f.play(),c&&d();const l=new MediaStream;l.addTrack(s.getAudioTracks()[0]),n.current.srcObject=l;const h=setTimeout(()=>{l.addTrack(s.getVideoTracks()[0])},c?1e4:0);return()=>{clearTimeout(h),p()}},[s,c,d,p]),t!=="connected"?w.jsx("div",{className:"rounded-lg bg-zinc-200 aspect-[5/4] dark:bg-neutral-800 flex justify-center items-center",children:w.jsx("div",{className:"text-center",children:t==="idle"?w.jsxs("button",{className:"bg-blue-500 text-white p-4 rounded-full aspect-square leading-none font-bold text-2xl",type:"button",onClick:()=>r(),children:[w.jsxs("div",{children:["Find ",w.jsx("br",{}),"the one"]}),w.jsx("div",{className:"text-sm opacity-60",children:"Tap here"})]}):w.jsxs("div",{className:"flex gap-2 font-medium items-center",children:[w.jsx("div",{className:"i-svg-spinners-pulse-3 text-red-500 text-3xl"}),w.jsx("div",{className:"text-secondary text-sm",children:"A moment! Searchingâ€¦"})]})})}):w.jsxs("div",{className:gr("rounded-lg bg-zinc-200 aspect-[5/4] dark:bg-neutral-800 flex flex-col justify-between relative",{"!bg-neutral-800":c}),children:[w.jsx("video",{ref:n,autoPlay:!0,className:"w-full h-full rounded-lg overflow-hidden object-cover",style:{transform:"scaleX(-1)"},playsInline:!0}),w.jsxs("header",{className:"justify-between flex items-start p-2 absolute top-0 left-0 w-full rounded-t-lg",style:{background:"linear-gradient(0deg, transparent 0%, rgba(0,0,0,0.4) 100%)"},children:[w.jsx("div",{children:w.jsxs("div",{className:"font-mono text-white",children:["@",u]})}),c&&o>0&&w.jsxs("div",{children:[w.jsx("span",{className:"text-secondary",children:"Reveal in"})," ",w.jsx("span",{className:"font-mono text-white",children:o})]})]}),w.jsx("footer",{className:"flex justify-end p-2 absolute bottom-0 left-0 w-full rounded-b-lg",children:w.jsxs("button",{type:"button",className:"px-2 py-1 rounded-full bg-red-500 flex items-center gap-2 font-medium text-white",onClick:i,children:[w.jsx("div",{className:"i-lucide-phone-off"})," Hang up"]})}),w.jsx("audio",{ref:a,id:"ding",src:"/zasplat_connected_ding.mp3"})]})}function $p(){const{user:s}=ls("root")||{},{muted:e,setMuted:t,selfStream:r,peerStream:i,shyMode:n,setShyMode:a}=Br(),o=K.useRef(null);return K.useEffect(()=>{if(!o.current||!r)return;const d=new MediaStream;d.addTrack(r.getVideoTracks()[0]),o.current.srcObject=d},[r]),w.jsxs("div",{className:"rounded-lg bg-zinc-200 aspect-[5/4] dark:bg-neutral-800 relative",children:[w.jsx("video",{ref:o,autoPlay:!0,className:"w-full h-full rounded-lg overflow-hidden object-cover",style:{transform:"scaleX(-1)"},playsInline:!0}),w.jsxs("header",{className:"justify-between flex items-start p-2 absolute top-0 left-0 w-full rounded-t-lg",style:{background:"linear-gradient(0deg, transparent 0%, rgba(0,0,0,0.4) 100%)"},children:[w.jsxs("div",{children:[w.jsxs("div",{className:"font-mono font-medium text-white leading-none",children:["@",s==null?void 0:s.username,w.jsx("span",{className:"opacity-50",children:"â€¢you"})]}),e&&w.jsx("p",{className:"text-sm opacity-70 text-white",children:"You're muted"})]}),w.jsxs("div",{className:"flex gap-2 items-center",children:[w.jsxs("button",{className:gr("flex gap-2 items-center rounded-full px-2 py-1 bg-zinc-300 dark:bg-neutral-700 font-medium duration-200",{"!bg-green-500 text-white":n}),type:"button",disabled:i!==null,onClick:()=>a(!n),children:[w.jsx("div",{children:"ðŸ™ˆ"})," Shy mode ",n?"on":"off"]}),w.jsx("button",{className:gr("aspect-square rounded-full p-2 bg-blue-500 text-xl text-white duration-200",{"bg-red-500":e}),type:"button",onClick:()=>t(!e),children:w.jsx("div",{className:gr({"i-lucide-mic":!e,"i-lucide-mic-off":e})})})]})]})]})}const rl=({data:s})=>[{title:`Parlon | ${s==null?void 0:s.school.shortName} | gctu`},{name:"description",content:"Make friends, learn from random people on campus"}];function sl(){const{available:s}=Mn();return s?w.jsx(kp,{children:w.jsx(Np,{})}):w.jsx("div",{className:"container",children:"Parlon is not available in your school yet. Please check back later."})}function Np(){const{selfStream:s}=Br();return w.jsxs("div",{className:"container min-h-[60vh]",children:[w.jsxs("header",{className:"text-center mb-4",children:[w.jsx("h1",{className:"text-center",children:w.jsx(In,{})}),w.jsx("p",{className:"text-secondary leading-tight",children:"Make friends, learn from random people on campus"})]}),s?w.jsx(Fp,{}):w.jsx(Ap,{})]})}function Ap(){const{requestCamera:s}=Br(),{user:e}=ls("root")||{};return e?w.jsxs("div",{className:"rounded-lg max-w-[30rem] aspect-[5/4] flex items-center justify-center flex-col mx-auto",children:[w.jsx("div",{className:"text-center",children:w.jsxs(Ln,{type:"button",onClick:s,children:[w.jsx("div",{className:"i-lucide-camera"})," Enable Camera"]})}),w.jsxs("p",{className:"text-secondary text-sm text-center mx-8",children:["Your camera is not shown immediately to the other person unless you turn off ",w.jsx("span",{className:"font-medium",children:"Shy mode"})]})]}):w.jsxs("div",{className:"rounded-lg max-w-[30rem] aspect-[5/4] flex items-center justify-center flex-col mx-auto",children:[w.jsx("div",{className:"text-center",children:w.jsxs(xn,{to:"/login",type:"button",onClick:s,children:[w.jsx("div",{className:"i-lucide-lock"})," Login"]})}),w.jsx("p",{className:"text-secondary text-sm text-center mx-8",children:"You need to log in or create an account to be able to use Parlon. It'll only take a few minutes to create an account if you're new here."})]})}function Fp(){return w.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[w.jsx("div",{className:"grid-cols-1",children:w.jsx(jp,{})}),w.jsxs("div",{className:"grid-cols-1",children:[w.jsx($p,{}),w.jsx("div",{className:"mx-2 text-sm text-secondary leading-tight mt-1",children:"Enabling Shy mode will hide your video from the other person for 10 seconds when connected. You can use the voice channel to introduce yourselves before you're revealed."})]})]})}export{sl as default,rl as meta};
